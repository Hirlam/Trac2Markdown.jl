[[PageOutline]]
[[Center(begin)]]
= '''HARMONIE Climate cy38''' =
[[LastModified]]
[[Center(end)]]

'''This page is intended for communication of status, development and documentation of HARMONIE Climate (HCLIM) based on cycle 38.'''


== Background ==

HCLIM38 is based on the climate version of HARMONIE developed at [http://www.smhi.se/en/Research/Research-departments/climate-research-rossby-centre2-552 Rossby Centre, SMHI].
The first cycle of HARMONIE used for HCLIM at Rossby Centre was cy36. Please refer to paper by [https://hirlam.org/trac/attachment/wiki/HarmonieClimate/TellusA-24138-final.pdf Lindstedt_et_al_2015] for more details.

== HCLIM38 in HIRLAM repository ==

=== https://svn.hirlam.org/branches/climate/HCLIM38h1.1 ===
HCLIM38 development started based on cy38h1.1 on this branch, which originates from /tags/harmonie-38h1.1:13009. [[BR]]
This version was well suited for simulations with ALARO physics on which SMHI focused. However, it has been shown by NWP community that h1.2 is better performing for AROME applications and a step to 1.2 was needed to enable HCLIM-AROME applications.

=== https://svn.hirlam.org/branches/climate/38h1/HCLIM38h1 ===
KNMI started merged all changes made on branch harmonie-38h1 into HCLIM on the HCLIM38h1 branch. The harmonie-38h1 branch is the development branch from which harmonie-38h1.1 and harmonie-38h1.2 are tagged and contains improvements beyond harmonie-38h1.2. It was therefore decided not to name the new version HCLIM381.2, but HCLIM38h1 instead.

=== Institute specific branches ===
SMHI, KNMI and METNO created copies for further development. Modifications relevant for the entire HCLIM community should be merged back to the HCLIM38h1 branch.

== Modifications of HCLIM38h1.1 ==

HCLIM38 specific functions that are present in all cycles since cy36:

 * SIMULATION_TYPE=climate is set in sms/config_exp.h for general climate settings. E.g., this affects many scripts under scr/.
 * A climate version of msms called climsim.tdf is activated for SIMULATION_TYPE=climate. This msms excludes e.g. assimilation processes.

This setup was used by SMHI with ALARO0 (+ACRANEB2) and SURFEX (diffusion, 3-L snow, FLake and simple ice) running over Europe (6 km resolution). Some tuning related to clouds and radiation was needed to reach an acceptable climate. It has been used for production runs for an EU-project SMHI is involved in.

Following is documentation of changes in HCLIM38 with respect to the original /tags/harmonie-38h1.1:

=== General ===

 * Added SST update (already in cy36) and Sea-Ice Concentration (SIC) every 6hr from boundary fields, following the style suggested by Mariken and Yurii.
 * Added radiation scheme ACRANEB2 (needed for greenhouse gas scenarios).
 * Added functionality to read RCP greenhouse gas data.
 * Fixed so restart of SURFEX works when limited SURFEX diagnostics is written using the LSELECT flag.
 * A multi-year climate run produces enormous amount of data. Therefore we have been working hard on making it possible to specify exactly which variables we like in output on a specific time frequency. Output from HCLIM38 can be written in different streams with different output intervals:
   * Atmospheric output can be divided into different streams. E.g. every third hour we write many variables to fa-files named PFHARMEUROPE_15+00006 and every hour we write a smaller subset of variables to fa-files named PFHARMEUROPE_15+00005.
   * SURFEX output can be written in a separate stream with its own output frequency. E.g. using the LSELECT flag we write SURFEX output every hour to fa-files named ICMSHHARM+00735.sfx. In this case a separate restart file is needed for SURFEX prognostic variables at each shift of month (next_first_guess_sfx -> ICMSHFULL+00744.sfx).
 * Use 5 digits in FA names to indicate time (4 in NWP)

=== nam/ ===

 * The %alaro settings in harmonie_namelists.pm are updated based on recommendations by Radmila Brozkova for ALARO-0 baseline (as implemented in CY38T1bf3).
 * In surfex_namelists.pm we have added/modified
   * Use diffusion soil (DIF) with 14 layers and NAPTCH>1.
   * Added soil organic carbon
   * Activated FLake as lake model (including initialization from from lake climate data file).
   * Snow model is explicit snow scheme (3-L).
   * Activated sea-ice model a la Yurii Batrak (HM-1).
 * Added new namelist surfex_selected_output.pm for specific SURFEX output.

=== src/surfex/ ===

SURFEX7.2 is replaced by SURFEX7.3, which has been further developed and modified. The original reason for replacing 7.2 with
7.3 was that physics options that are considered important for a climate version of HARMONIE are not working well enough in 7.2.
These include for example the lake component FLake and the ISBA options diffusion (DIF) and explicit snow (3-L). A major missing
component in 7.3 is prognostic sea-ice temperature which has been added. Furthermore, under the development of HCLIM38 it became clear that
preferred ISBA options are not working well enough in 7.3 in coupled mode. Therefore, the ISBA code of 7.3 has been replaced
by corresponding code from a development version of SURFEX v8. The development of the SURFEX version now used for HCLIM38 is based on
SURFEX 7.3, r1835 in trunk (http://svn.cnrm-game-meteo.fr/projets/surfex/trunk/src). Until March 9, 2015, the SURFEX development for HCLIM38
took place in branch http://svn.cnrm-game-meteo.fr/projets/surfex/branches/SMHI_ROSSBY_DEV. However, since then the HCLIM38 SURFEX
development takes place in the HIRLAM repository.

Selected list of changes in SURFEX for HCLIM38 compared to the original 7.3 version:
 * Added simple sea-ice a la Yurii Batrak (see [https://hirlam.org/trac/wiki/SURFEX-ice Sea ice a la HIRLAM in SURFEX] for more information). More precisely based on r2400 in http://svn.cnrm-game-meteo.fr/projets/surfex/branches/hirlam/cy38_sea_ice. Since then corrected for handling of sea-ice concentration.
 * Replaced the ISBA code by corresponding code from a development version of SURFEX v8. More precisely based on r2793 in http://svn.cnrm-game-meteo.fr/projets/surfex/branches/V8_GMGEC_MEB. E.g. this corrects for a bug related to TG1, it includes modified snow 3-L/ES subroutines to avoid problems for thin snow layers.
 * Added PCD as output for use in ALARO ACPTKE.
 * Added min/max of patch T2M_P to output, i.e. T2MMIN_P and T2MMAX_P.
 * Increased KHALO from 2 to 10 to get soil carbon PGD step to work.
 * Modifications to avoid problems with snow initialization in PREP step (Prep_ini_surfex).
 * Deactivated writing of soil wetness index per layer in write_diag_misc_isban.
 * Force FLake mixed layer depth to be less than lake depth as initial condition.
 * Modified LSELECT functionality to get grid info written to file by default.
 * Updated Soil Organic Carbon parameters. More precisely according to r2837 in http://svn.cnrm-game-meteo.fr/projets/surfex/branches/CM6V8DEV.

=== config-sh/ ===

 * The config files have been complemented with paths to ECOCLIMAP cover parameter files and RCP greenhouse gas files.
   * export ECODIR=
   * export RCPDIR=

=== scr/ ===

 * A convertFA script has been added to convert fa-files to NetCDF on the fly.

=== sms/ ===

 * Comments on config_exp.h
  * Climate setup of HARMONIE is set by SIMULATION_TYPE=climate
  * The tested setup includes DYNAMICS="h", PHYSICS="alaro" and SURFACE="surfex". Any other settings are not necessarily tested or validated.
  * Boundaries used at ECMWF are by default ERA-INTERIM as defined by BDSTRATEY="era".
  * All HCLIM38 runs now uses SURFEX_PREP="yes". We can't guarantee that SURFEX_PREP="no" works. Please note that we have modified original SURFEX7.3 to make PREP work with the SURFEX options we use.
  * CONVERTFA=yes/no has been added to support on the fly conversion of fa-files to NetCDF/GRIB specified by OUTPUT_FORMAT=nc/grib.
  * Old setting MAKEGRIB=yes/no is removed.
  * SURFEX_LSELECT=yes/no has been added. If yes, nam/surfex_selected_output.pm is used for selected SURFEX output.

=== util/ ===

 * Under util most updates concern modifications and complementation of gl to allow NetCDF output.

== Modifications in HCLIM38h1 ==
HCLIM38h1 was created as a copy from HCLIM (identical to HCLIM38h1.1 at that time) and modifications on branch harmonie-38h1 were merged in with:
{{{
 svn merge --accept postpone ^/branches/harmonie-38h1 .
}}}
This needed to be done in several steps because of all the conflicts.

Following is documentation of changes in HCLIM38h1 after these merge steps:

=== General ===
 * ecFlow scheduler added by Samuel Viana
 * support for SST/SIC from different sources, controlled via SST_SOURCES in config_exp.h
 * Option to run in hindcast mode (cold start upper air every cycle, pass on surface), enabled with SIMULATION_MODE=hindcast in config_exp.h
 * Option to run with ERA5 as host model, set BDSTRATEGY=era5 in config_exp.h, use era-in for ERA-Interim (was era)
 * Option to run with RACMO as host model, in config_exp.h set SST_SOURCES=RACMO, HOST_MODEL=racmo, BDLIB=RACMO, BDSTRATEGY=analysis_only and point BDDIR to directory with RACMO files
 * HARATU scheme added: r15049 and later commits, controlled via HARATU switch in config_exp.h
 * Added MULTITASK option: possibility to run multiple scalar jobs (e.g. boundary file generation) on 1 node, enabled with MULTITASK=yes in config_exp.h (but Env_submit for local machines may need to be adapted, not available on ECMWF)

=== config-sh/ ===
 * config.ecgb-cca
  * Add ECACCOUNT to override default account
  * PROJNAME added, to group experiments

=== msms/ ===
 * climsim.tdf
  * Added Extract4ver family

=== scr/ ===
 * Split convertFA in 3 pieces (history, fullpos and surfex) to speed up conversion
 * Store experiment's settings (~/hm_home/$EXP) in ECFS

=== sms/ ===
 * Comments on config_exp:
  * Changed default sea-ice option from 'none' to 'SICE'
  * Switched HARATU on by default
  * SST_SOURCES variable added
  * SAVE_FAOUTPUT variable added, to control which FA output is saved after a successful conversion in FA
  * Added INSTITUTE variable, used as attribute in NetCDF files

=== src ===
 * Debugged to get rid of memory leaks that made long HCLIM-AROME runs impossible : from r14865 to r14880 .
 * Updated microphysics code by Karl-Ivar: r15046
 * Updated SURFEX hydro routines: r15455

=== util/ ===
 * gl/xtool: conversion from FA to NetCDF
  * replaced with gl from cy40
  * relative time axis, and time bounds
  * option to output netcdf4
  * more control over file name
  * better support for multilevel variables, with coordinate variables
  * possibility to write multiple fields/levels to 1 file
  * support for climate fields (no time info)
  * option to convert accumulated fields to fluxes
  * direction of fluxes added
  * better projection description
  * option to skip adding vertices
  * _FillValue attribute
  * global attributes added
  * prevent difdtg from running out of integer
  * Option to calculate upward radiation fluxes from net and downward
  * xtool can output NetCDF
  * do postprocessing in xtool, so it can be used to de-accumulate e.g. total precipitation
  * better support for missing values in xtool
 

== Current status ==
This branch of HCLIM38 is now default set up in such a way that it should run out of the box at ECMWF. So, you are welcome to try it out!! Please follow HARMONIE user documentation for further information. Normal submission of a HCLIM38 simulation is e.g. 

{{{
 Harmonie start DTG=2003090100 DTGEND=2007010100
}}}
At the ECMWF HCLIM38h1 will use ecFlow as the default scheduler. If you prefer to use mSMS you can add SCHEDULER=MSMS to the start command or modify the SCHEDULER variable in Env_system.

Remaining technical issues:
 * Solve I/O-server problem in combination with selected output from SURFEX (LSELECT). Does now work in cy40h.
 * ALARO2ALARO still needs to be solved. Ongoing
 * ALARO2AROME now works partly but the SST/SIC fields do not become available for AROME yet. Ongoing.
 * Mercator domain setup does not work, e.g. setting up an Africa domain. It works better in cy40h ( unexplained "orography mismatch" problem )
 * The current restart at each month shift is currently not bit-identical. Not scheduled.

=== Installation at ECMWF ===

Make sure that you use bash as your default shell on ecgb and cca.

The HCLIM38h1.1 climate branch is available from ecgb under
{{{
 /home/ms/spsehlam/hlam/harmonie_release/branches/climate/HCLIM38h1.1
}}}

The HCLIM38h1 climate branch is available from ecgb under
{{{
 /perm/ms/nl/nkl/harmonie_release/branches/climate/38h1/HCLIM38h1
}}}
but to be in control of the version you are working with it may be safer to checkout your own copy of the sources with e.g.:
{{{
 mkdir -p $PERM/harmonie_release/branches/climate/38h1; cd $PERM/harmonie_release/branches/climate/38h1
 svn co https://svn.hirlam.org/branches/climate/38h1/HCLIM38h1
}}}

Setup and run as usual with, for example for the HCLIM38h1.1 version:
{{{
 mkdir -p ~/hm_home/SOME_EXP; cd ~/hm_home/SOME_EXP
 /home/ms/spsehlam/hlam/harmonie_release/branches/climate/HCLIM38h1.1/config-sh/Harmonie setup -r /home/ms/spsehlam/hlam/harmonie_release/branches/climate/HCLIM38h1.1 -h ecgb-cca
}}}

Some users have encountered a compilation error with message like "Cannot read module file 'types.mod'". If you have this problem please take a look at HIRLAM Forum pages on this issue:
http://hirlam.org/index.php/forum/2-harmonie-system/1183-harmonie-climate-compilation-error-at-ecgb

=== Installation at other systems === #NewSystem

 * By default HCLIM38/SURFEX uses the lake model FLake. FLake requires additional physiography and initial condition data which is normally not available in a HARMONIE setup. Also, by default, soil organic carbon is activated in HCLIM38/SURFEX (look for "soc" in nam/surfex_namelists.pm) which requires additional physiography data. Thus, please complement your system with these files as available at ECMWF/cca in directory $HM_CLDATA/PGD:
   * GlobalLakeDepth.dir
   * GlobalLakeDepth.hdr
   * GlobalLakeStatus.dir
   * GlobalLakeStatus.hdr
   * LAKE_LTA_NEW.nc
   * soc_sub.dir
   * soc_sub.hdr
   * soc_top.dir
   * soc_top.hdr

 * Since the default SURFEX version in cy38h1.1 has been replaced by a later version for HCLIM38 the SURFEX-version-dependent ecoclimap-files also should be updated. See config-sh/config.ecgb-cca and corresponding directory on ECMWF/cca /project/hirlam/harmonie/climate/ECOCLIMAP/40h1.1. On a new system you need to create a corresponding directory and place the SURFEXv7.3 ecoclimap files there.

 * If you are interested in future scenario simulations: HCLIM38 can be used for future scenario simulations given appropriate boundary conditions from e.g. a CMIP5 GCM. In this case the radiation scheme ACRANEB2 needs greenhouse gas concentration corresponding to the RCP scenario. A new RCP directory, RCPDIR, is used in HCLIM38 for the RCP concentration files. See RCPDIR in config-sh/config.ecgb-cca and corresponding directory on ECMWF/cca /project/hirlam/harmonie/climate/RCP. Thus, on a new system you need to create a corresponding directory and place the RCP files there.

Please contact Patrick Samuelsson if you don't have access to ECMWF or if you realise that some more HCLIM38 specific system dependent modifications are needed. If you have access to SURFEX-lab, http://www.cnrm.meteo.fr/surfex-lab/spip.php?rubrique14, you can also download physiography form there.