[[PageOutline]]
[[Center(begin)]]
= '''4D-Var operational feasibility test - 0.1 ''
Last modified [[LastModified]]
[[Center(end)]]

During the Norrkoping working week (13-17 May 2019) it was decided to perform daily 4D-Var runs, to be carried out by KNMI, IPMA and SMHI. General information, standard settings, monitoring and results will be define in the present wiki.

== Model Version==
cy40 4D-Var branch (r18417) version prepared by Eoin and Nils with large extension zone (roughly 300 km), multiple outer loop iterarations at 1/6 and 1/3 of full resolution.

{{{
mkdir -p $HOME/hm_home/4dvar_test01
cd $HOME/hm_home/4dvar_test01
~hlam/Harmonie setup -r /home/ms/spsehlam/hlam/harmonie_release/branches/harmonie-40h1_4DVAR -c AROME_4DVAR
~hlam/Harmonie start DTG=2019051009 DTGEND=2019051012
}}}

== What works (ecgb-cca) ==
Some settings that may guide default/baseline settings:

=== Report from Nils ===
||= DOMAIN  =||= LBIGEZ_MINIM =||= LBGE_BIGEZ =||= LWARM_MINIM =||= NOUTERLOOP =||= ILRES =||= TSTEP4D =||= NITER4D =||= NSIMU4D =||= MINPHYSICS =||=NPROCX x NPROCY  =||= Status  =||= Comments                                                     =||
||METCOOP25C ||yes             ||yes           ||yes            ||2             ||6,3      ||360,180    ||15,10      ||??,??      ||arome         ||16 x  8            ||PASS       ||Nils' test                                                      ||
||METCOOP25C ||yes             ||yes           ||yes            ||2             ||6,3      ||360,180    ||15,10      ||??,??      ||arome         ||12 x  8            ||PASS       ||Nils' test                                                      ||
||METCOOP25C ||yes             ||yes           ||yes            ||2             ||6,3      ||360,180    ||15,10      ||??,??      ||arome         ||32 x  8            ||PASS       ||Nils' test                                                      ||

=== ecgb-cca with r18512 ===
||= DOMAIN    =||= LBIGEZ_MINIM =||= LBGE_BIGEZ =||= LWARM_MINIM =||= NOUTERLOOP =||= ILRES =||= TSTEP4D =||= NITER4D =||= NSIMU4D =||= MINPHYSICS =||=NPROCX x NPROCY  =||= Status  =||= Comments                                                     =||
||DKCOEXP      ||no              ||no            ||yes            ||2             ||2,2      ||120,120    ||15,10      ||20,15      ||arome         || 6 x 16            ||PASS       ||Eoin                                                            ||
||DKCOEXP      ||no              ||no            ||yes            ||2             ||2,2      ||120,120    ||15,10      ||20,15      ||arome         || 1 x 96            ||PASS       ||Tested with r18512                                              ||
||DKCOEXP      ||no              ||no            ||yes            ||2             ||2,2      ||120,120    ||15,10      ||20,15      ||aladin        || 6 x 16            ||'''FAIL''' ||Vertical interpolation '''CRASH''' in 4DVloop1/4DVminim         ||
||DKCOEXP      ||no              ||no            ||yes            ||2             ||2,2      ||120,120    ||15,10      ||20,15      ||aladin        || 1 x 96            ||'''FAIL''' ||r18512 '''ABORTS''' reading climate fileds in 4DVloop1/4DVtraj  ||
||             ||                ||              ||               ||              ||         ||           ||           ||           ||              ||                   ||           ||                                                                ||
||IBERIAxxm_2.5||no              ||no            ||no             ||2             ||4,2      ||300,150    ||15,10      ||20,15      ||arome         ||18 x 18 (fcst 16x18)||PASS       ||Isabel                                                          ||
||NETHERLANDS  ||no              ||no            ||no             ||2             ||4,2      ||300,150    ||15,10      ||20,15      ||arome         ||18 x 12 (fcst 18x18)||PASS       ||Jan ||
||NETHERLANDS  ||no              ||no            ||no             ||2             ||4,2      ||360,180    ||15,10      ||20,15      ||aladin        ||1 x 144 (fcst 18x18)||PASS       ||Jan ||


== Issues for resolution ==
=== LWARM_MINIM ===
With LWARM_MINIM=yes in sms/config_exp.h the log suggests it is working (reading of VATRH) but the cost function diagnostics do not:
 ''with the linear grid the 2nd loop had a hickup in Jo although LWARM_MINIM=yes''
{{{
GREPCOST - ITER,SIM,JO,JB,JC,JQ,JP,JA   15  15   2749.10218714       568.881837534  
GREPCOST - ITER,SIM,JO,JB,JC,JQ,JP,JA  999 999   2749.10218714       568.881837534  
GREPCOST - ITER,SIM,JO,JB,JC,JQ,JP,JA    0   0   2861.95140366       568.881837534  
GREPCOST - ITER,SIM,JO,JB,JC,JQ,JP,JA    1   1   6482.66188990       652.206372515         
<<<<<<<<<
GREPCOST - ITER,SIM,JO,JB,JC,JQ,JP,JA    1   2   2853.10289939       571.668260071
}}}
In the run with cubic grid this Jo behaviour was not the case anymore (and no extra simulation).

=== large extension zone ===

> Large extension zone works (and is now default with default DKCOEXP domain). Settings are '''VERY''' domain dependent. All processors must have some computational (C) points. SLRSET crashes related to processors having only extension zone (E) points available.

=== MINPHYSICS=aladin ===

> MINPHYSICS=aladin is fixed as of r18536 using BLENDSUR

=== Env_submit ===
Env_submit is currently not flexible enough for changing ILRES settings. Do the perl gurus have any opinion on how this might be tackled? In Env_submit or on the 4D-Var scripts?

== General experiment settings ==
{{{
    # AROME with 4D-VAR
    'AROME_4DVAR' => {
      'description'          => 'Standard AROME settings with 4DVAR',
      'PHYSICS'              => 'arome',
      'DYNAMICS'             => 'nh',
      'SURFACE'              => 'surfex',
      'DFI'                  => 'none',
      'LGRADSP'              => 'no',
      'LUNBC'                => 'no',
      'DOMAIN'               => 'NETHERLANDS',
      'VLEV'                 => '65',
      'GRID_TYPE'            => 'LINEAR',
      'ANAATMO'              => '4DVAR',
      'ILRES'                => '4,2' ,
      'TSTEP4D'              => '300,150' ,
      'LWARM_MINIM'          => 'no' ,
      'ANASURF'              => 'CANARI_OI_MAIN',
      'ANASURF_MODE'         => 'after',
      'LBIGEZ_MINIM'         => 'no' ,
      'LBGE_BIGEZ'           => 'no' ,
      'BDSTRATEGY'           => 'simulate_metcoop' ,
      'HWRITUPTIMES'         => '"00-21:1,24-60:6"',
      'LL_LIST'              => '30,3,3,3' ,
      'SURFEX_INPUT_FORMAT'  => 'fa',
      'SURFEX_LSELECT'       => '"no"',
    },
}}}

== Archived fields ==

== Computational aspects ==

Minor updates in r18553.

||= Task      =||= NPROCX x NPROCY =||= Comments =||
||Forecast     || 16 x 18           ||            ||
||4DVScreen    || 18 x 08           ||            ||
||4DVMinim     || 18 x 08           ||            ||
||4DVtraj      || 18 x 08           ||            ||

== Control Runs ==

MetCOOP:
>
KNMI: control run from the HAP2 ensemble (KEPS) with domain=NETHERLANDS (800x800) 
>
IPMA: IBERIAxxm_2.5
>
|| '''EXP'''             ||='''Domain''' =||='''Status'''  =||='''Extent'''       =||='''model version'''=||='''grid'''=||='''DA'''=||='''Obs win'''=||='''Observations'''        =||='''Comments'''||
|| MC_4DVAR              ||  METCOOP25C   ||  dev           ||Scandinavia         ||harmonEPS-40h1.2_preop_4DVAR||      ||          ||               ||                            ||               ||
||xxx                    || NETHERLANDS   || Operational    ||NL,B,Ire,F,1/2 DK,1/2 D ||harmonie-40h1.1.1.rc1+mods ||800x800x65 ||3DVAR ||3 h        ||CONV,ASCAT,MODE-S EHS       ||               ||
||xxx                    || IBERIAxxm_2.5 || pre-operational||Iberian penin.      ||harmonie-40h1.1.1.rc1 ||800x648x65  ||3DVAR     ||3 h            ||CONV,ASCAT                  ||               ||
||dui:4dvar_irl3dvar     || IRELAND25_090 || dev            ||Irl+UK+Atlantic     ||harmonie-40h1_4DVAR   ||1000x900x65 ||3DVAR     ||3 h            ||CONV                        ||               ||
||~~dui:4dvar_irl4dvar~~ || IRELAND25_090 || dev            ||Irl+UK+Atlantic     ||harmonie-40h1_4DVAR   ||1000x900x65 ||4DVAR     ||3 h            ||CONV,ASCAT,AMSU-A,MHS,IASI  ||Bator+MARS conv obs, needed to swtich on large extension zone for Irish domain, LRTTOV_INTERPOL=.TRUE. -- '''ABANDONED''' ||
||dui:4dvar_irl4dvar22   || IRELAND25_090 || dev            ||Irl+UK+Atlantic     ||harmonie-40h1_4DVAR   ||1000x900x65 ||4DVAR     ||3 h            ||CONV,ASCAT,AMSU-A,MHS,IASI  ||Bator+MARS conv obs; ILRES=2,2; needed to swtich on large extension zone for Irish domain; LRTTOV_INTERPOL=.TRUE. ||


 [[BR]]  [[BR]]  [[BR]] 

= Status October 2019 =
 * KNMI: started 2 runs with cold start at 2019070512 and now (2 October 2019) reached beginning of September. Will run MONITOR to derive some verification statistics.
 * METIE: 3D-Var ctrl 18 day, 4D-Var expt 1 day for September 2018. 15 day 3D-Var spin-up used for both
 * IPMA: 1 run with cold start from 2019080118  reached 20190810 (3 Oct 2019). Will run MONITOR for verification hopefully for a 2 weeks run.

 [[BR]]  [[BR]]
== Results==

 [[BR]]  [[BR]]  [[BR]] 
== Verification==
 [[BR]]  [[BR]]  [[BR]] 

