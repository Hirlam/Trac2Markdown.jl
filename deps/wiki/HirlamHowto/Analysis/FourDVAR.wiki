[[PageOutline]]

[[Center(begin)]]
== '''Hirlam HOWTOs''' ==
= '''Running 4D-VAR''' =
[[Center(end)]]

== How do I perform HIRLAM 4D-VAR experiment with the reference system ==

You can perform data assimilation experiment with 4D-VAR upper air analysis in similar way as you do for 3DVAR with reference configuration. With a standard installation of the reference system after version 6.4.4, the only thing you absolutely need to modify is the scripts Env_expdesc. Take ECMWF platform as example. On ecgate,

 1. preparation,
{{{
   alias Hirlam ~nhz/Hirlam
   cd
   mkdir -P hl_home/4DV
   cd hl_home/4DV
   Hirlam setup
   Hirlam co scripts/Env_expdesc
}}}
 1. edit scripts/Env_expdesc to choose 4DVAR as analysis scheme. For versions prior to 7.0, you also need to specify LSMIX=no since the LSMIX option does not work. The option is specifically turned off for 4DVAR at 7.0 release
 1. launch the experiment by specifying at least two consecutive cycles, (this is because the first cycle in 4DVAR scenario is only a cold-start in which forecast is made in order to provide first guess for the 4DVAR cycle)
{{{
   Hirlam start DTG=2006030800 DTGEND=2006030806
}}}

== How do I perform code test to check validity of an adjoint code ==

HIRLAM code contains facility to perform equivalency test (or identity test, IDtest) to validate an adjoint code is in correspondence to a tangent linear code. 

The following instruction is extracted and modified from an email, assuming test platform on ECMWF using 7.0,

 1. preparation on ecgate,
{{{
   alias Hirlam ~nhz/Hirlam
   cd
   mkdir -P hl_home/idtest
   cd hl_home/idtest
   Hirlam setup
   Hirlam co config/system.rttov7
   Hirlam co scripts/Env_expdesc
}}}
 1. edit config/system.rttov7. Add to the specification about VAR4DEF flag with one of the available test options, e.g., DTESGEMINI
 1. edit scripts/Env_expdesc to choose 4DVAR as analysis scheme
 1. launch the experiment by specifying at least two consecutive cycles, (this is because the first cycle in 4DVAR scenario is only a cold-start in which forecast is made, in order to provide first guess for the 4DVAR cycle)
{{{
   Hirlam start DTG=2006030800 DTGEND=2006030806 LLMAIN=06
}}}

Note that for most code test options the programme has been instructed to terminate after the ID-test, thus a crash does not tell whether or not the experiment is successful or not.

You may examine the ID test result by checking the inner product value of lxlx and xllx in the log file of the run. In the above example on ECGATE, do
{{{
cd $SCRACTCH/hl_home/idtest/
grep lx HL_Cycle_2006030806.html
}}}
if you see lxlx and xlxl values to be the same down to the last 2 or 3 digits, the test is successful. Otherwise the test suggest in-equivalency of TL/AD.

If you want to repeat the test or change test options, say from TESGEMINI to TESDYNN, you can do following hacking:
  1. on $ECHOME/hl_home/idtest, edit config/system.rttov7 again to replace -DTESXXX by -DTESYYY, where TESYYY is the new sets of TL/AD that you want to test;
  1. rlogin hpcd, cd $TEMP/hl_home/idtest, do
{{{ 
  rm -rf lib
}}}
  1. back to ECGATE, go to
     $HOME/hl_home/idtest, check that DTG in progress.log is the cycle you want to be at, in this example 2005120806, then do
{{{
    Hirlam prod DTGEND=2008030806 LLMAIN=06
}}}

You now starts a new IDtest, testing anew TL/AD for those defined as TESYYY .

You may do a grep on the directory ~nhz/hirlam_release/7.0rc1/hirlam/include/vartes to see the available TES-options. You will find dozens of such options, among them,
 * TESGEMINI
 * TESSSLN
 * TESEULERN
 * TESDYNN
 * TESMFSPHCALLN
 * TESRHS


[[SubWiki]]

[[Center(begin)]]
[https://hirlam.org/trac/wiki/HirlamHowto Back to the main page of the HIRLAM-HOWTO]
[[Center(end)]]
----

[[Center(begin)]]
[[Disclaimer]]

[[Color(red, Last modified on)]] [[LastModified]]
[[Center(end)]]