[[PageOutline]]
[[Center(begin)]]
== '''HIRLAM 41t1 contributions''' ==

This page summarizes the potential contributions for the cy41t1 phasing due in late 2014.

[[Center(end)]]

== '''Introduction to the changes''' ==

Below is a list of all differences between the current branch for [source:harmonie/branches/phasing/cy40/src cy40h1] and [source:vendor/aladin/current cy40t1_bf.02] as extracted from git. The list serves as a starting point for discussions about contributions to cy41t1. In [https://hirlam.org/trac/raw-attachment/wiki/Harmonie_41h1/41t1_contributions/svndiff_all.html this file] a full list of all the differences can be found. The full source code can be retrieved by 

{{{
 svn co https://svn.hirlam.org/branches/phasing/cy40/src
}}}


== '''Summary table''' ==
|| '''Contribution'''    || '''Author'''            || '''Comments''' || 
|| '''Physics'''||
|| [#Radiationchanges Radiation updates ] || Kristian Pagh Nielsen et.al. || ||
|| [#Alarosurfexinterface Alaro to SURFEX interface] || ||
|| [#Solidmicrophysics Solid microphysics] || Karl-Ivar Ivarsson, SMHI || ||
|| [#CAinALARO CA scheme updates] || Lisa Bengtsson || || 
|| ''' Dynamics''' || 
|| [#LGRADSPchanges LGRADSP] || Mariano Hortal, AEMET || Not yet properly merged ||
|| [#LUNBC LUNBC] || Mariano Hortal, AEMET || Not yet properly merged ||
|| Spectral boundary conditions || Mariano Hortal, AEMET || Not yet merged, see cy38h1 version || 
|| '''Assimilation'''||
|| [#GNSSVarbc GNSS VARBC] || Magnus Lindskog et.al. || ||
|| [#pregpssolfixes GNSS preproc] || Jana Sanchez Arriola, AEMET || || 
|| [#SODAinCANARI SODA in CANARI] || Trygve Aspelien, MET Norway || || 
|| [#Percma Observation perturbation] || Roger R. MET Norway || || 
|| [#ISWAP Correct usage of LBC in CANARI] || || || 
|| '''Diagnostics'''||
|| [#FEMARSLAMchanges FEMARS LAM] || Ulf Andrae, SMHI || ||
|| [#ODB1toODB2 ODB1 to ODB2] || Eoin Whelan, Met Eirann || ||
|| '''Technical'''||
|| [#Memorydiagnostics Memory usage diagnostics] || Sami Saarinen, CSC || ||
|| [#msesurfexinterface mse/surfex interace] || || ||
|| [#Lessverbose Verbosity] || || ||
|| [#DrHOOKupdates DrHOOK updates] || Sami Saarinen, CSC || || 
|| [#ODBupdates ODB updates] || || ||
|| [#Compilationwarningerrorchanges Compilation warnings] || Ulf Andrae, SMHI || ||
|| Rename stat.F90 to festat.F90 || || || 
|| '''SURFEX'''||
|| [#Alarosurfexinterface Alaro to SURFEX interface] || ||
|| [#Prepfixes Prep fixes] || Trygve Aspelien, MET Norway || ||
|| [#SURFEXnumerics SURFEX numerics] || Ulf Andrae, SMHI || ||
|| [#SURFEXinterfaceproblems Interace problems] || Ulf Andrae, SMHI || ||
|| Added surfex/OFFLIN/close_namelist_nc.F90 || || ||
|| '''To be checked'''|| 
|| [#IO-server OI-server log] || || Is this necessary? ||
|| [#Emptypoolfix Empty pool fix] || || Check if still needed ||
|| [#SAMIO SAMIO] || || Add back or not? || 
|| [#LDAmethod LDA method] || || Put under ifdef? || 
|| [#mten Moist energy norm] || Roger R. Met Norway || Contains duplicated routines, needs further checking ||
|| '''Keep in HIRLAM repository only'''||
|| [#Compilationproblemfix GFORTRAN fix] || || ||
|| [#Batorchanges Bator] || || ||
|| [#Blacklisting Blacklist] || || ||
|| [#a4DVARfixes 4DVAR] || || || 
|| [#Nameconventionofcloudfields Field names] || || ||
|| [#Soilincrementtuning OI_CACSTS] || Magnus Lindskog || || 

[[BR]]
[[BR]]

[[Center(begin)]]
== Physics ==
[[Center(end)]]
------------------------------------------------------------------------

=== Radiation changes ===

 - Correct calculation and output of direct and diffuse radiation
 - Add direct normal irradiation ( not yet merged to cy40h1 )

{{{
 arp/phys_dmn/apl_arome.F90
 arp/phys_dmn/aplpar.F90
 arp/phys_dmn/mf_phys.F90
 arp/phys_ec/callparad.F90
 arp/phys_ec/radheat.F90
 arp/phys_ec/radlsw.F90
 arp/phys_radi/sw1s.F90
 arp/phys_radi/swni.F90
}}}

------------------------------------------------------------------------

=== Alaro surfex interface ===

 Changes to make ALARO0 work with SURFEX

{{{
Files:
  arp/phys_dmn/initaplpar.F90
  arp/phys_dmn/aplpar.F90
  mse/externals/aro_ground_diag.F90
  mse/interface/aro_ground_diag.h
  surfex/SURFEX/get_fluxn.F90
  src/surfex/SURFEX/get_surf_varn.F90
}}}

------------------------------------------------------------------------

=== Solid microphysics ===

 Karl-Ivar Ivarsson

 - More strict separation of liquid- and ice microphysics in arome condensation The scheme is controlled by the switch LOCND2, RADGR, RADSN in namparar and is switched off by default 

{{{
 arp/module/yomparar.F90
 arp/namelist/namparar.nam.h
 arp/phys_dmn/apl_arome.F90
 arp/phys_dmn/suparar.F90
 mpa/micro/externals/aro_adjust.F90
 mpa/micro/externals/aro_rain_ice.F90
 mpa/micro/interface/aro_adjust.h
 mpa/micro/interface/aro_rain_ice.h
 mpa/micro/internals/condensation.F90
 mpa/micro/internals/ini_rain_ice.F90
 mpa/micro/internals/ice_adjust.F90
 mpa/micro/internals/rain_ice.F90
 mpa/micro/module/modi_condensation.F90
 mpa/micro/module/modi_ice_adjust.F90
 mpa/micro/internals/rain_ice.F90

 New:
 mpa/micro/internals/aro_icecld.F90
 mpa/micro/internals/aro_tiwmx.F90
 mpa/micro/module/modi_aro_icecld.F90
 mpa/micro/module/modi_aro_tiwmx.F90
}}}

------------------------------------------------------------------------

=== CA in ALARO ===

 Lisa Bengtsson, SMHI

 - Updated tuning of CA scheme in ALARO

 [https://hirlam.org/trac/attachment/wiki/HarmonieSystemDocumentation/progress_report_CA.pdf]

{{{
 arp/control/cuconvca.F90
 arp/module/yoe_cuconvca.F90
 arp/module/yomphy0.F90
 arp/phys_dmn/accvud.F90
 arp/phys_dmn/suphy0.F90
}}}

------------------------------------------------------------------------

== Dynamics ==


=== LGRADSP changes ===

 Mariano Hortal

 - Elimination of aliasing on vorticity and pressure departure following Wedi

 - This is not yet fully merged to cy40h1

{{{
 ald/setup/suehdf.F90
 ald/setup/sueldynb.F90
 ald/transform/etransdir_mdl.F90
 ald/transform/etransinv_mdl.F90
 ald/transform/etransinvh.F90
 arp/adiab/cpg_gp.F90
 arp/adiab/gptf1.F90
 arp/module/gmv_subs_mod.F90
 arp/module/yomsp.F90
 arp/namelist/namdyna.nam.h
 arp/utility/sualspa.F90
}}}

------------------------------------------------------------------------

=== LUNBC ===

 Mariano Hortal

 - Apply Davies relaxation at the upper boundary condition. Controlled by LUNBC in nemelbc0b. 

 - This is not yet fully merged to cy40

{{{
 arp/ald_inc/namelist/nemelbc0b.nam.h
 arp/module/elbc0b_mod.F90
 ald/coupling/ecoupl1.F90
 ...
}}}


------------------------------------------------------------------------


== Assimilation ==

------------------------------------------------------------------------

=== GNSS Varbc ===

 Magnus Lindskog, et.al. 

 - Changes to make VARBC work properly for GNSS

{{{
 arp/module/varbc_sfcobs.F90
 arp/obs_preproc/black.F90
 arp/op_obs/hop.F90
 arp/op_obs/hopad.F90
 arp/op_obs/hoptl.F90
 arp/utility/prtjo.F90
 arp/utility/prtjo.F90
 odb/ddl/getsfcobsid.sql
 odb/ddl/varbc_sfcobs_robhdr.sql
}}}

------------------------------------------------------------------------

=== Varbc ===

 - VarBC predictor levels

 - '''KEPT LOCAL?'''

{{{
 arp/module/varbc_pred.F90
}}}

------------------------------------------------------------------------

=== pregpssol fixes ===

 Jana Sanches Arriola
 
 [https://hirlam.org/trac/raw-attachment/wiki/Harmonie_41h1/41t1_contributions/ASSIMILATION%20GNSS%20Cy38_1.pdf] 

{{{
 uti/pregpssol/filter_gpssol.F90
 uti/pregpssol/pregpssol.F90
 uti/pregpssol/read_obsoul_gpssol.F90
 uti/pregpssol/write_obsoul_gpssol.F90
}}}

------------------------------------------------------------------------

=== Pertcma ===

 Roger R.

 - Perturbation of CCMA database

{{{
 odb/tools/Pertcma.F90
 odb/ddl.ECMA/pertcma.sql
 odb/ddl.CCMA/pertcma.sql
 odb/ddl/pertcma.sql
 odb/pandor/module/random_numbers.F90
}}}

------------------------------------------------------------------------

=== ISWAP ===

 - Change ISWAP from 1 to 2 to avoid unitialized values in CANARI

{{{
 ald/coupling/ecoupl1.F90
}}}

------------------------------------------------------------------------

== Diagnostics ==

------------------------------------------------------------------------

=== FEMARS LAM changes ===
 
 Ulf Andrae
 
 - No LELAM protection flag yet

{{{
 ald/setup/suect0.F90
 arp/ald_inc/namelist/nemct0.nam.h
 arp/control/cnt3.F90
 arp/module/yomvar.F90
 arp/namelist/namvar.nam.h
 arp/setup/suctrl_gflattr.F90
 arp/var/suvar.F90
}}}

------------------------------------------------------------------------

=== ODB1 to ODB2  ===

 Eoin Whelan

{{{
 odb/scripts/dcagen
}}}
------------------------------------------------------------------------

== Technical changes ==

------------------------------------------------------------------------

=== Memory diagnostics ===

 Sami Saarinen, CSC

{{{
 arp/utility/opdis.F90
 xrd/utilities/gethwm.c
 xrd/utilities/getrss.c
 xrd/utilities/getstackusage.c
 xrd/utilities/getstk.c
}}}

------------------------------------------------------------------------

=== Dr HOOK updates ===

 Sami Saarinen

{{{
 xrd/module/dr_hook_watch_mod.F90
 xrd/support/dr_hook_prt.F90
 xrd/support/drhook.c
 xrd/utilities/linuxtrbk.c
}}}

------------------------------------------------------------------------

=== ODB updates ===

 - Sami Saarinen

 - Syntax updates
 - New dummy routines

{{{
 odb/aux/curses.c
 odb/aux/generic.c
 odb/aux/newio.c
 odb/aux/odb2mysql.c
 odb/aux/odbi_direct.c ! Change method why?
 odb/aux/qtar_sub.c
 odb/aux/result.c ! Change method why?
 odb/aux/upcma.c
 odb/extras/mpi_serial/cmpi.c
 odb/extras/mpi_serial/mpi_buffer_attach.F
 odb/include/odb_macros.h
 odb/lib/evaluate.c
 odb/lib/funcs.c
 odb/lib/inside.c
 odb/lib/symtab.c
 odb/lib/vecloops.c
 odb/tools/b4.c
 odb/tools/odbi_direct_main.c
 xrd/include/drhook.h
}}}


------------------------------------------------------------------------

=== Compilation warning/error changes ===

 Several contributors

 - Correct INTENT
 - Break long lines
 - Call ec_getenv not getenv
 - Remove erroneous include of interface block sualspa.intfb.h
 - Lower JPFORC to fit with FA name conventions/grib 
 - Correct array limit in cloud_estimate.F90
 - Correct IVDEP directive locations
 - Correct kind for REAL
 - Correct FORMAT statements

{{{
 arp/adiab/cpg5_gp.F90
 arp/adiab/cpg_dia.F90
 arp/adiab/cpg_dyn.F90
 arp/adiab/cpg_gp.F90
 arp/adiab/cpg_gpb_nhgeogw.F90
 arp/adiab/lacdyn.F90
 arp/adiab/laconead.F90
 arp/adiab/lavent.F90
 arp/adiab/postphy.F90
 arp/canari/canari.F90
 arp/canari/casgra.F90
 arp/chem/chem_mocage.F90
 arp/chem/chem_mozart.F90
 arp/chem/tm5_chem_ini.F90
 arp/control/cnt3_wait.F90
 arp/module/yom_ygfl.F90
 arp/obs_preproc/hatbiasc.F90
 arp/obs_preproc/radar_profs.F90
 arp/obs_preproc/readoba.F90   NB!!! This also contains a LLECMWF flag change
 arp/obs_preproc/sudimo.F90
 arp/obs_preproc/tempin.F90
 arp/oops/fields_io_mod.F90
 arp/op_obs/cloud_estimate.F90
 arp/op_obs/kernel_pbp_ad.F90
 arp/op_obs/slint.F90
 arp/phys_dmn/acconvsad.F90
 arp/phys_dmn/aclspsad.F90
 arp/phys_dmn/acnebsmad.F90
 arp/phys_dmn/acnuagesad.F90
 arp/phys_dmn/apl_arome.F90
 arp/phys_ec/cloud_layer.F90
 arp/phys_ec/convection_layer.F90
 arp/phys_ec/convection_s_layer.F90
 arp/phys_ec/cuadjtq.F90
 arp/phys_ec/cubasmcn.F90
 arp/phys_ec/cuflxn.F90
 arp/phys_ec/cumastrn.F90
 arp/phys_ec/turbulence_layer.F90
 arp/phys_ec/vdfmain.F90
 arp/prism/couplo4_inimpi.F90
 arp/setup/su0yomb.F90
 arp/setup/suvert.F90
 arp/sinvect/suforce.F90
 arp/utility/rdspec.F90
 arp/var/jbtomodelad.F90
 arp/var/writeoba.F90
 mse/internals/write_surft1_aro.F90
 odb/extras/emos/bugbts.F
 odb/pandor/extrtovs/extr_lib_1c.F90
 sur/module/ocean_ml_driver_v2_mod.F90
 sur/module/srfsn_rsn_mod.F90
 surfex/SURFEX/bem.F90
 surfex/SURFEX/default_teb_veg.F90
 surfex/SURFEX/init_from_data_greenroofn.F90
 surfex/SURFEX/init_veg_gardenn.F90
 surfex/SURFEX/init_veg_pgdn.F90
 surfex/SURFEX/mode_sltmbl.F90
 surfex/SURFEX/mode_splines.F90
 surfex/SURFEX/mode_write_surf_fa.F90
 surfex/SURFEX/prep_hor_snow_fields.F90
 surfex/SURFEX/read_gridtype_cartesian.F90
 surfex/SURFEX/snowcro.F90
 surfex/SURFEX/teb_morpho.F90
 tal/module/euvtvd_comm_mod.F90
 tal/module/euvtvd_mod.F90
 tal/module/suemplatb_mod.F90
 tfl/module/updspbad_mod.F90
}}}

------------------------------------------------------------------------

=== mse/surfex interface ===

 - Correct HREC length from 16 to *

{{{
 mse/internals/error_read.F90
 mse/internals/error_write.F90
 mse/internals/fmreadt0.F90
 mse/internals/fmwritt0.F90
 mse/internals/old_ndim.F90
 mse/internals/read_in_lfi_x2.F90
 mse/internals/read_in_lfi_x3.F90
 mse/internals/read_surfc0_aro.F90
 mse/internals/read_surfl0_aro.F90
 mse/internals/read_surfl1_aro.F90
 mse/internals/read_surfn0_aro.F90
 mse/internals/read_surfn1_aro.F90
 mse/internals/read_surft0_aro.F90
 mse/internals/read_surft1_aro.F90
 mse/internals/read_surfx0_aro.F90
 mse/internals/read_surfx1_aro.F90
 mse/internals/read_surfx2_aro.F90
 mse/internals/write_in_lfi_x1.F90
 mse/internals/write_in_lfi_x2.F90
 mse/internals/write_in_lfi_x3.F90
 mse/internals/write_surft0_aro.F90
 
}}}

------------------------------------------------------------------------

== SURFEX ==

------------------------------------------------------------------------

=== Extrapolation in surfex ===
 
  Extrapolation in prep and OI_main
  Add NDIM_EXTRAP to allow different search radius, r12739

{{{
Files:
  arp/fullpos/sufptr2.F90
  surfex/ASSIM/oi_hor_extrapol_surf.F90
  surfex/SURFEX/default_prep_isba.F90 
  surfex/SURFEX/modd_prep_isba.F90
  surfex/SURFEX/modn_prep_isba.F90
  surfex/SURFEX/prep_isba_buffer.F90
  surfex/SURFEX/prep_snow_buffer.F90
}}}

------------------------------------------------------------------------

=== SURFEX numerics ===

 - Avoid SIGFPE trapping by DR_HOOK. Replace WHERE statement with IF to avoid SIGFPE due to evaluation of missing data. 

{{{
 surfex/SURFEX/mode_read_extern.F90
 surfex/SURFEX/z0rel_1d.F90
 surfex/SURFEX/av_pgd.F90
}}}

------------------------------------------------------------------------

=== SURFEX interface problems ===

 - Needed to make cy40h1 compile

{{{
 surfex/OFFLIN/mode_read_surf_ol.F90
}}}

------------------------------------------------------------------------

== Under investigation ==

=== IO-server ===

 - No XML-files by export MFIO_SERV_LOG=/dev/null 

 - Do we really need this?

{{{
 arp/io_serv/io_serv_log.F90
}}}



------------------------------------------------------------------------

=== Less verbose ===

{{{
 mse/internals/fmlook.F90
 xrd/misc/facat.F90
}}}

------------------------------------------------------------------------

=== Empty pool fix ===

 - Check if this is still needed

{{{
 odb/cma2odb/shuffle_odb.F90
 arp/obs_preproc/readoba.F90
}}}

------------------------------------------------------------------------

=== SAMIO ===

Add back or not?

{{{

Files:
xrd/lfi/lfiecc.F90 
xrd/lfi/lfiedo.F90 
xrd/lfi/lfifer.F90 
xrd/lfi/lfilcc.F90 
xrd/lfi/lfildo.F90 
xrd/lfi/lfiouv.F90 

}}}



------------------------------------------------------------------------

=== LDA method ===

 - To be cleaned or treated under ifdef
 
{{{
 odb/module/odbshared.F90
}}}

------------------------------------------------------------------------


------------------------------------------------------------------------

=== Prep fixes ===

{{{
 mse/programs/prep.F90
 surfex/SURFEX/prep_snow_extern.F90
}}}

------------------------------------------------------------------------

=== SODA in CANARI ===

Trygve Asplien

- EKF changes
- SODA inline ( CANARI ) changes

{{{
 arp/canari/canali.F90
 arp/module/qactex.F90
 arp/module/yomlun.F90
 arp/namelist/nactex.nam.h
 arp/utility/openfa.F90
 arp/utility/openfainfo.F90
 mse/externals/aroini_surfa.F90
 mse/externals/aroini_surfc.F90
 mse/externals/deallmse.F90
 mse/externals/sugridsfx.F90
 mse/externals/suphmse_surface.F90
 mse/interface/aroini_surfa.h
 mse/interface/sugridsfx.h
 mse/internals/fminit.F90
 mse/programs/driver_off_omp.F90
}}}


== HIRLAM specific changes ==


------------------------------------------------------------------------
=== Compilation problem fix ===

{{{
Files:
  odb/tools/Simulobs2odb.F90
}}}

------------------------------------------------------------------------


=== Soil increment tuning ===

{{{
 surfex/ASSIM/oi_cacsts.F90
}}}

------------------------------------------------------------------------


=== Bator changes ===

- Reading of HDF5
- Decoding of satellite BUFR data, LMFBUFR flag.
- Radar settings

{{{
  odb/pandor/module/bator_decodbufr_mod.F90
  odb/pandor/module/bator_init_mod.F90
  odb/pandor/module/bator_lectures_mod.F90
  odb/pandor/module/bator_module.F90
  odb/pandor/module/bator_rad_postproc_mod.F90
  odb/pandor/module/bator_util_mod.F90
  odb/pandor/namelist/bator_namelist.nam.h'
  odb/pandor/module/bator_decodhdf5_mod.F90
  odb/tools/Bator.F90

}}}

------------------------------------------------------------------------

=== Blacklisting ===

{{{
Files
  bla/mf_blacklist.b
}}}

------------------------------------------------------------------------

=== 4DVAR fixes ===
r7973 | ovignes | 2010-04-26 15:36:10 +0200 (Mon, 26 Apr 2010) | 2 lines

Port 4DVAR changesets (7141,7167,7181,7200,7220,7545,7957) from 35h1branch

{{{
Files:
  ald/fullpos/suefpg3.F90
  ald/programs/blendsur.F90
}}}

------------------------------------------------------------------------

=== Name convention of cloud fields ===

r9414 | trygveasp | 2011-06-07 09:27:54 +0200 (Tue, 07 Jun 2011) | 32 lines

{{{
Files:
  ald/programs/blend.F90
}}}

------------------------------------------------------------------------

=== ODB sql ===

{{{
odb/ddl.CCMA/mandalay.sql
odb/ddl.CCMA/obsmon_conv.sql
odb/ddl.CCMA/obsmon_conv2.sql
odb/ddl.CCMA/obsmon_sat.sql
odb/ddl.CCMA/pertcma.sql
odb/ddl.ECMA/mandalay.sql
odb/ddl.ECMA/obsmon_conv.sql
odb/ddl.ECMA/obsmon_conv2.sql
odb/ddl.ECMA/obsmon_sat.sql
odb/ddl.ECMA/pertcma.sql
odb/ddl/mandalay.sql
odb/ddl/obsmon_conv.sql
odb/ddl/obsmon_conv2.sql
odb/ddl/obsmon_sat.sql
odb/ddl/pertcma.sql
}}}

