[[PageOutline]]
[[Center(begin)]]
= '''Development of the use of two patches in SURFEX for cy40h''' =

Last modified [[LastModified]]
[[Center(end)]]

In Metcoop we currently work on implementing the use of two patches over land instead of only one. The reason why we try this is because we believe we sometimes have problems with excess evaporation in our AROME simulations. Such excess evaporation could be caused by too large roughness length due to land average of roughness for one patch only. Using two patches require modifications of CANARI/OI and decisions on how increments should be distributed between the two patches (similar problem as in HIRLAM newsnow). This work is ongoing...

== A branch for 2 patches based on latest tag release of harmonie-40h1.1.rc.1 is now available for tests (by Patrick) ==

The branch [https://svn.hirlam.org/branches/harmonie-40h1_patchy_assim] is now up to date with latest tag release of harmonie-40h1.1.rc.1 of (sync until trunk r15043). I have tested it on ecgate and it runs fine. See my experiment setup on ecgate here {{{/home/ms/se/sn8/hm_home/c40h11rc1_2patches}}} (hope all can access it). Thus, this branch can now be used for tests over several different domains/periods.

In {{{sms/config_exp.h}}} the number of patches is specified by {{{NPATCH=2}}}. Thus, to make a clean comparison one should run two experiments with NPATCH= 1 and 2, respectively. Please note that Monitor has been modified according to [wiki:HarmonieWorkingWeek/Surface201604/Two_patches_development#VerificationMonitormodifications Verification Monitor modifications] below to include verification based on patch number 1 (open land) in the case of NPATCH=2.

For further information on tests and results please look below and see also the experiment table for cy40h1.2 [wiki:Harmonie_40h1/40h1.2_validation here]. Please complement the table when you start your own tests.

== Progress report related to the branch !MetCoOp/harmonEPS-40h1_2patches by Patrick ==

The Metcoop branch for 2 patches, [https://svn.hirlam.org/branches/MetCoOp/harmonEPS-40h1_2patches], is now working and is ready to use for further experiments. As far as I understand, the settings in this branch corresponds in general to those which will be available in the official cy40h release (e.g. HARATU is activated). But, please note that:
 * The normal Metcoop setup is to run with modified OI coefficient for deep soil temperature in oi_cacsts.F90 and with modified snow melt in isba_fluxes.F90. These modifications are not included in this branch.
 * The simple sea-ice model (SICE) will be default in cy40h but it is not activated here. The reason is that recent technical SICE modifications are not included and I don't wish to "disturb" the working 2 patches setup with additional modifications at this stage. SICE on/off will not be crucial for the impact of 1 or 2 patches since the main impact is expected over land areas.
 * The Metcoop branch is technically modified with respect to the trunk to fulfil the functionality of MEPS where multi-members are run. For example, this concerns how frequency output of SURFEX full files are specified in  sms/config_exp.h. In this branch SFXFULLTIMES="" is used for that while in the trunk SURFEX_DUMP_STATE_STEPS="" is used. The benefit with these modifications is that a very clean experiment with two members can be setup where the only difference for sure is that one member has 1 patch and the other member has 2 patches. For those of you who have access to the SMHI cluster bi you can see my such setup here: {{{/nobackup/smhid12/sm_psamu/hm_home/MetCoOp_2patches_O3_nb12}}}.
 * The SURFEX output as specified in nam/surfex_selected_output.pm is based on a SURFEX output suggestion for operational forecasts as discussed within Metcoop. Currently this list differs from corresponding list in trunk.

=== Verification results March 2016 ===

I have done a simulation over the Metcoop domain for the month of March 2016 (see experiment table for cy40h1.2 [wiki:Harmonie_40h1/40h1.2_validation here]). The verification results with Monitor is available [https://hirlam.org/portal/smhi/HARMONIE_MONITOR/2_patches/index.html?choice_ind=0 here]. The biggest impact is a reduction of the bias in Rh2m. The impact on T2m is small (spontaneously I expected larger impact so I should understand more why this does not happen). There is also an impact on the wind speed where 2 patches leads to a small negative bias. Also here I spontaneously expected a higher wind speed due to reduced roughness...

Mariken has also done a simulation with 2 patches by introducing some of the changes form the harmonEPS-40h1_2patches branch into her test version of cy40. Her verification is available [https://hirlam.org/portal/smhi/snow_2016_export/ here]. Her results go in the same direction.

------------------------------------------

||                              ||= '''1 patch'''                                    =||= '''2 patches'''                                    =||
||= '''Bowen ratio'''          =|| [[Image(Bowen_Ratio_1patch.png, 400px)]]           || [[Image(Bowen_Ratio_2patches.png, 400px)]]           ||
||= '''Evaporative fraction''' =|| [[Image(Evaporative_Fraction_1patch.png, 400px)]]  || [[Image(Evaporative_Fraction_2patches.png, 400px)]]  ||

Bowen ratio is defined as {{{BR = (sensible heat)/(latent heat)}}} and Evaporative fraction as {{{EF = (latent heat)/(sensible heat + latent heat)}}}.
This figure shows BR and EF calculated from 3-hourly accumulated sensible and latent heat fluxes over land, respectively (HC_ISBA and LEC_ISBA) as mean average over 21 days (March 4 - March 24) for the period 09-12Z each day.
BR/EF is larger/smaller for 2 patches compared to 1 patch which means that a larger part of the available energy is used for sensible heat flux in the 2-patches case.

=== Verification results May 2016 ===

Please download [http://exporter.nsc.liu.se/6278484cacf04edfab88cbc48981b6e6 Monitor verification results here for the period May 4-14, 2016] (available until August 12).

The results for May 2016 show the same tendencies of improvements in Rh2m but also a more clear improvement in T2m. As for March 2016 the wind speed is slightly reduced which is bad according to the verification. However, the big problem with large positive bias in Rh2m over northern Scandinavia in May 2016 is not solved by 2 patches. Here the approach by Sander Tijm et al. by reducing LAI may be helpful.... tests are needed...

=== Verification Monitor modifications ===

The verification/monitor part in the harmonEPS-40h1_2patches branch has been modified to include 2 patches.
The archive/extract/mbr001/vfld files now include additional columns representing the 2 patches:
{{{ 
 TTP1
 TTP2    
 DDP1  
 DDP2             
 FFP1             
 FFP2             
 RHP1             
 RHP2             
 QQP1             
 QQP2             
 TDP1             
 TDP2             
 TXP1             
 TXP2             
 TNP1             
 TNP2             
}}}

where P1 represent open land and P2 forest patches, respectively. For a simulation with NPATCH=1 the P1 is still present but then represents the land value (comparable to the ISBA land-averaged value in a 2-patches experiment).

The corresponding SURFPAR line in {{{monitor/scr/Env_exp}}} reads:

{{{
SURFPAR="PS FF FFP1 GX DD DDP1 TT TTP1 TN TNP1 TX TXP1 TD TDP1 RH RHP1  QQ QQP1 NN PE"
}}}

which corresponds to the following variable list in the WebgraF interface

{{{
Mslp
U10m
U10m 1 patch
Max Wind Gust
Wind direction
Wind direction 1 patch
T2m
T2m 1 patch
Min T2m
Min T2m 1 patch
Max T2m
Max T2m 1 patch
Td2m
Td2m 1 patch
Rh2m
Rh2m 1 patch
Q2m
Q2m 1 patch
Cloud cover
12h Precipitation
}}}

Here, e.g. "T2m 1 patch" in a comparison between a 1 and 2 patches experiment will show the difference between the open land 

== Progress report related to Metcoop working week in Oslo, May 2016 ==

The 2-patch development is now moved to a new branch related to Metcoop since most test will be done related to the Metcoop domain. The new branch is
[https://svn.hirlam.org/branches/MetCoOp/harmonEPS-40h1_2patches].
Thus, the old 2-patches development branch is not used now: [https://svn.hirlam.org/branches/harmonie-40h1_patchy_assim]

Latest status includes:
  * The branch is now running and a simulation is ongoing (one week now).
  * Ulf has modified monitor to include the possibility to validate individual patches.
  * Mariken has updated trans_tab.h to include GRIB codes for patch information.

Examples from very first verification with monitor:

Please not that the two simulations are quite different:

 * Default cy40h starts in February and uses HARATU
 * 2-patches starts in March and does not use HARATU

[[Image(Fc_length_ver_Rh2m.png, 40%)]] [[Image(Fc_length_ver_T2m.png, 40%)]] 

The left figure shows a very common spring problem over the Metcoop domain where Rh2m bias increases rapidly after analysis (default cy40h, green). The 2-patches experiment (red) shows less such a problem. T2m is not affected very much. However, when zooming into smaller geographical sub-areas the conclusions differ.

[[Image(Surface_map_Rh2m_bias_cy40h1.png, 40%)]] [[Image(Surface_map_Rh2m_bias_patchy.png, 40%)]] 

Left figure shows Rh2m bias in default cy40h and right figure shows Rh2m bias for 2-patches. There are quite large biases in the south-east part of the domain and for Norway in default cy40h which are not present in 2-patches.



== Report from [https://hirlam.org/trac/wiki/HarmonieWorkingWeek/Surface201604 Surface meeting in Oslo, April 2016] ==

Current version of the branch crashes... Patrick will continue to look into this.

It could be important to exclude very small fractions of patches. Mariken takes a look at this

Our verification system Monitor may need some modifications to represent the near surface open land diagnostics instead of grid-average values. Mariken and Ulf are experts on this. But, also, we need to add definitions of new patch variables into our GRIB tables since Monitor needs GRIB as input. What about GRIB2 work...? Patrick discuss with Ulf and Daniel on how gl my need modifications.  

cy42h will follow cy40h because the assimilation needs this intermediate step before we go to cy43h (including OOPS). Thus, we should be aware of that any cy40h branch development needs to be forwarded to cy42h and cy43h.
