[[PageOutline]]
[[Center(begin)]]
= '''Work on assimilation methods for surface in HARMONIE''' =

Last modified [[LastModified]]
[[Center(end)]]

== Status in relationship to the Surface meeting in Ljubljana, September 2017  ==

At the [wiki:Meetings/Surface/Surface201709 HIRLAM/ALADIN/LACE/SURFEX Surface Working Days in Ljubljana, September 18-20, 2017], it was decided
that we should re-activate work and development of SURFEX Offline surface data assimilation (SODA) by utilizing the SURFEX [wiki:HirlamMeetings/Surface201610/SODA_development branch SODA_V8] that we created for the [wiki:Meetings/Surface/Surface201610 Zagreb meeting, autumn 2016].
Patrick has now (2017-10-24) updated this branch so it corresponds to latest SURFEXv8.1. See the wiki on [wiki:HirlamMeetings/Surface201610/SODA_development SODA_V8 branch] for more details.

== Side meeting on surface data assimilation, Toulouse, February 27, 2017  ==

Time and location: Monday 27 at 09:00-10:00 at the international conference center (CIC) on the campus of Météo-France in Toulouse.

=== Participants and focus of work ===

 * Patrick Samuelsson (SMHI) - SURFEX processes and data assimilation. 
 * Patrick Le Moigne (Météo-France, VEGEO) - Coordinating SURFEX development
 * Alina Barbou (Météo-France, VEGEO) - Using EKF and EnKF in SODA to assimilate LAI and soil moisture.
 * Stéphanie Faroux (Météo-France, VEGEO) - Coordinating SURFEX repository and ECOCLIMAP development.
 * Hanneke (!MetNorway) - Using Crocus in SURFEX offline 
 * Yurii Batrak (!MetNorway) - Developing Simple Sea Ice model (SICE) for SURFEX.  
 * Trygve Aspelien (!MetNorway) - Currently testing Explicit snow scheme in SURFEX7.3 context for NWP purposes.
 * Mariken Homleid (!MetNorway) - Currently testing Explicit snow scheme in SURFEX7.3 context for NWP purposes.
 * Rafiq Hamdi (Belgium Met Office) - 
 * Clément Albergel (Météo-France, VEGEO)
 * Simon Munier(Météo-France, VEGEO)
 * Delphine Leroux (Météo-France, VEGEO)
 * Jean Christophe Calvet (Météo-France, VEGEO)
 * Camille Birman (Météo-France, NWP)


=== Comments and suggested subjects for discussion: ===

 * HIRLAM colleagues are currently taking steps towards utilizing diffusion soil scheme and explicit snow scheme (preferable also MEB) in combination with EKF surface assimilation for NWP in cy43/SURFEXv8. Please let us know who is working on this or have the intention to do so. 

 * In the VEGEO team of the meso-scale modelling group of CNRM we are currently working on the (offline) assimilation of satellite-derived Surface Soil Moisture and Leaf Area Index using either the Force-Restore version (3 layers) or the diffusion soil scheme of ISBA Land Surface Model at different scale (France, Europe, even global at coarser spatial resolution). So far the main technique that has been used is a simplified version of an Extended Kalman filter and 2017 should be the year of the Ensemble Kalman Filter.

 * Magnus Lindskog (SMHI) heard from Jean-Francois Mahfouf that it was tricky to get Canari working in cy43t due to the fact that the OOPS implementation didn't involve Canari but affects it. Hmhm, a bit unclear to me what this means... If anyone had info on this please report.

 * Questions from Mariken Homleid (!MetNorway) with respect to using Explicit snow scheme in combination with OI assimilation and Force-restore
 The first steps with Optimum Interpolation and ISBA Force Restore
  * Snow analysis. Use snow depths observations to adjust SWE
    * how to adjust the properties of the snow pack after an adjustment of SWE?
    * by SNOW3LTRANSF from snow3L.F90?
  * Update of surface/snow temperature and water. With snow one ground:
    * Which temperature is «seen by the atmosphere» ?
    * Do TG1/TG2/WG1/WG2/WGI1/WGI2 effect the surface fluxes?

 * Introducing SURFEX tile/patch information into CANARI: In our cy40h system we now have the opportunity to run NWP utilizing two patches in SURFEX (separating forest and open land). But then it also seems logical to give CANARI open land conditions as first guess (e.g. T2m and Rh2m) and not grid-averaged values as is currently done (also concern e.g. coastal areas). Is this in the interest also of other users and if yes, how should be proceed with a common solution?
 


== Strategic questions regarding surface data assimilation, meeting January 26, 2017  ==

Google hangouts meeting with the following participants: Mariken Homleid (Met Norway), Trygve Aspelien (Met Norway), Inger-Lise Frogner (Met Norway), Ekaterina "Katya" Kurzeneva (FMI), Eoin Whelan (Met Éireann), Emily Gleeson (Met Éireann), Patrick Samuelsson (SMHI), Jelena Bojarova (SMHI), Magnus Lindskog (SMHI), Tomas Landelius (SMHI), Ulf Andrae (SMHI). Unfortunately our KNMI colleagues were busy with a parallel internal strategy day.

The meeting is based on a [http://hirlam.org/index.php/forum/surface-development/1249-surface-data-assimilation#1772 HIRLAM Forum discussion here].

=== Agenda and memory notes ===

> '''Memory notes are indicated like this.'''


 * As Tomas expressed it: "Take steps towards fully coupled DA using physically consistent ensemble members for atmosphere, surface and ocean but using separate assimilations for a start". I guess we all agree on that, right? So, this system will be based on EnKF.
 > In principle we all agree that a fully coupled EnKF-based system is what we are heading for since it would fulfil consistency between e.g. atmosphere and surface processes. However, in practice it may be kind of a hybrid system since e.g. the time scale of the involved processes differ substantially and therefore all components may not be totally integrated in a common EnKF system. But this will become more clear during the development.

 * So, if we head for an EnKF system...
   * Is it still useful, or well invested time, to explore/develop a surface assimilation system based on EKF as a step in between? My current understanding is yes! Do we all agree on that?
   > The answer is yes. EKF is already used in tests and developments and is applied to e.g. satellite products. We can learn a lot from the EKF development and the results from such a system are also useful to compare with once EnKF-based systems reach test status.  
   * Can we also say now if this EKF-based system should be operational or not? Probably not a solution for those institutes running EPS-system since it would be too expensive, or? But maybe an alternative if a deterministic system only is used. As John comments: "However you may be able to limit the control vector to those variables directly affected by and closest to the observations, resulting in perhaps 10 variables." Although John does not recommend EPS combined with EKF.
   > The answer depends partly on the physics options applied. In our development we are already heading for a combination of EKF and Force-restore/D95snow which should be totally affordable also in EPS systems. However, with more advanced physics, meaning more prognostic variables and probably more control variables, the cost may be to big in an EPS system. But it also depends on the final number of control variables needed. Anyway, the consistency between e.g. atmosphere and surface processes we find important can only be fulfilled through a coupled EnKF system. Thus, in the end an EKF-based system is seen as an intermediate step.

 * Tomas brought up the question of replacing deterministic CANARI with ensemble OI to assimilate t2m and rh2m (snow information assimilated together with other SURFEX variables).
   * Hmhm, our short term plan is to replace CANARI with MESCAN. Thus, we will probably invest some development into MESCAN. It is another question maybe but [https://hirlam.org/trac/wiki/Surface_physis_assimilation/MESCAN_tests#Ideas development ideas of MESCAN related to radius of influences exists]. Strategically, when and how should we take steps to replace CANARI/MESCAN contra continue to develop MESCAN? Or maybe no decision is needed because the need and development for something else is unavoidable when steps are taken towards an EnKF system? 
   > Currently when Magnus is using ASCAT soil moisture product he preprocess the data and read them directly into SODA since the CANARI spatialisation is not applicable to the ASCAT data. In principle this is probably how one wishes to treat also other satellite products. But, we should find a more general and consistent solution which can be easily expanded to additional satellite products and radiances via observation operators. Katya pointed out that for example satellite snow-extent products for snow assimilation still need to make use of the spatialisation functionality of CANARI/MESCAN so we can not simply treat all satellite products outside the CANARI framework. Trygve suggested that we need a ODB interface to SURFEX. '''One important conclusion from this discussion was that we need a dedicated CANARI/MESCAN/satellite-product data flow plan and this is a subject for a separate meeting.'''
   >
   > The life time of CANARI/MESCAN is probably limited and when EnKF-based system is approaching some other solution is needed. However, as Trygve pointed out, we should not spend too much idea-energy on this question at the moment since the future solution will probably depend much on how the OOPS-system affects the code structure.   

 * Looking first at the intermediate step using EKF:
   * A [https://hirlam.org/trac/browser/branches/MetCoOp/harmonEPS-40h1_2patches MetCoOp branch does now exist] where OI has been replaced by EKF but otherwise keeping our NWP setup as it looks. This setup is based on work by Magnus Lindskog in cy38h. A 15-days test has been performed but is not analysed.
   * This setup uses non-evolving B-matrix but I hear from some of you that we should definitely head for evolving B-matrix, right?
   > Jelena and Katya both pointed out the importance to head for an evolving B-matrix EKF-system and we all agreed on that. Just to recall that at the [https://hirlam.org/trac/wiki/HirlamMeetings/Surface201610 surface meeting in Zagreb] last autumn Clément Albergel said "If you go for evolving B-matrix then you need to estimate the Q-matrix which is tricky. So, be careful to activate evolving B-matrix". 
   >
   > Katya stressed that calculations of Jacobians must be done separately in EKF (with evolving B-matrix) compared to SEKF (Simplified EKF, without evolving B-matrix). Katya has provided a [https://hirlam.org/trac/attachment/wiki/HarmonieWorkingWeek/Surface201604/EKF_surface_work/EKFvsSEKF.pdf pdf explaining EKF versus SEKF for ISBA]. The understanding is that this is how [https://hirlam.org/trac/browser/trunk/harmonie/src/surfex/ASSIM/assim_nature_isba_ekf.F90 assim_nature_isba_ekf.F90] is coded...
   * How about the [https://hirlam.org/trac/attachment/wiki/HarmonieWorkingWeek/Surface201604/EKF_surface_work/Annelies_Duerinckx_121-130.pdf treatment of oscillations discussed by Annelies Duerinckx]: oscillations occurring at critical values of the Richardson number when changing from an unstable to a stable boundary layer. She shows that the impact of these oscillations can easily be cured with a simple numerical temporal filter.
   > No one at the meeting has studied Annelies' solution in detail but Magnus thinks that this temporal filter may solve some problems that he has seen in his EKF tests so far. Thus, we should have testing of this temporal filter on our agenda.
   * We need EKF to utilize more advanced surface physics. Steps towards use of more advanced surface physics are initiated here and there:
     *  Mariken Homleid (!MetNorway), Trygve Aspelien (!metNorway), John de Vries (KNMI), Samuel Viana (AEMET), Åsmund Bakketun (!MetNorway) and Tomas Landelius (SMHI) are all involved in similar steps.
     > Patrick suggests a separate meeting to coordinate tests and developments related to these more advanced physics options.

 * How many members are realistic in an EnKF system, 10, 20, ... what is physically "required" and what is affordable?
   * How many, or which, surface variables should be included as control variables? 40? Yes, many surface variables are very correlated, e.g. those within the soil and those within the snow, respectively.
   > Tomas' plan is to use NMC like statistics to investigate the degree of vertical and horizontal correlations. Results from such a study could indicate how many variables are "required". 

 * It seems natural to combine an EPS system with EnKF data assimilation.
   * Currently our EPS colleagues discuss and test how to apply surface perturbations in the operational EPS systems. But such perturbations are in principle the same kind of perturbations used in an EnKF system, right? Can we learn from each other or is the currently discussed surface perturbation just an intermediate step towards an EnKF system? 
   > Andrew Singleton (!MetNorway) and Björn Stensen (SMHI) have investigated the impact of horizontal differences in the perturbations fields of surface variables in the MEPS system. Here expertise judgement has been used to come up with reasonable radius of influences. Their conclusion is that the MEPS scores shown by spread/skill and rank histograms are quite insensitive to such horizontal differences. But there may be other aspects of the results that are influenced, or? But, again, the NMC like statistics method to be applied by Tomas will objectively indicate what are reasonable radius of influence for different variables.
   * John says: "Perturbation of the Land Surface in a calibrated LSM of a coupled system needs to focus on the sources of uncertainty in the simulation of the surface fluxes."
   > John has started work on investigating how to identify the most uncertain/sensitive parameters in SURFEX which can help us to find methods for how perturbations should be applied.

 * Issues related to soil moisture data assimilation combined with soil texture (clay/sand), and its wilting point, and combined with LAI discrepancies.
   * Hmhm, could/should the soil moisture increments be scaled with respect to local Soil Water Index...?
   > Sand/clay should not be used in CANARI/MESCAN since the spatialisation of T2m, Rh2m cannot be expected to be highly dependent on such fields. However, how the increments are used in SODA may take sand/clay fields into account. More discussions with Sander are needed to understand how to proceed.
   * The STAEKF method tested by our colleagues at RMI in Brussels seems to be an attractive method for assimilation of LAI.
   > Yes, test of STAEKF should be on our agenda but as Katya points out, going for assimilation of LAI satellite products should be our ultimate goal. 
   * SURFEX includes an option for prognostic LAI but this model requires activation of other options which are currently far from our NWP setup (e.g. all 12/19 patches need to be used).
   > Using MODIS LAI data to modify LAI physiography input to SURFEX has been tested by Bolli for Iceland with successful results. It is a possible intermediate step but again assimilation of such products should be a more preferable long-term solution.

 * How do we continue? We go "around the table" and say something about our personal contributions to the surface assimilation work.
   > Tomas: Applies the NMC like statistics method in SURFEXv8 environment to study degree of correlations between variables. Also develops EnKF assimilation methods + observation operators for a number of satellite radiances.
   >
   > Magnus: Continue to run cy38h with EKF over a southern Europe domain to assimilate ASCAT soil moisture product. Trying out evolving B-matrix may be on the agenda but not now.
   >
   > Patrick: Has applied Magnus' cy38h EKF development in a [https://hirlam.org/trac/browser/branches/MetCoOp/harmonEPS-40h1_2patches cy40h branch]. A 15-days test has been performed over the !MetCoOp domain. Monitor scores look fine. Studies of details in e.g. increments should be done. Will later look into evolving B-matrix.
   >
   > Mariken and Trygve: Study performance of Explicit snow scheme in SURFEXv7.3 and SURFEXv8 offline simulations. They plan to use the [https://hirlam.org/trac/browser/branches/MetCoOp/harmonEPS-40h1_2patches 2-patches MetCoOp branch] to explore 2 patches in combination with Explicit snow scheme and Force-restore soil. And to apply EKF for surface assimilation, right?
   >
   > Katya: Is working on making FLake operational for cy40h. Longer validation tests will soon be submitted. After that she will look into snow data assimilation and try to understand/solve a suspicious bug in CANARI which affects snow in coastal areas.
   >
   > Emily: Look into how to implement glaciers in SURFEXv8.



== Notes from Surface Workshop discussions in Oslo, April 2016 ==

'''This page was first created as 'memory notes' from the snow discussion held at the [https://hirlam.org/trac/wiki/HarmonieWorkingWeek/Surface201604 Surface meeting in Oslo, April 2016].'''

 People involved in the discussion: Trygve Aspelien (Met Norway), Jostein Blyverket (NILU), John de Vries (KNMI), Jelena Bojarova (SMHI), Magnus Lindskog (SMHI), Stefan Schneider (ZAMG), Mats Dahlbom (DMI), Nikolai Nawri (IMO), Sigurdur Thorsteinsson (IMO)

       * There is a bug-fix i SURFEX version 8.0 with potential relevance for noisy Jacobians (check with LACE)
       * Check importance of/sensitivity to  +/- sign and magnitude of perturbations for EKF noisy Jacobians. In addition investigate whether to 
         specify perturbations in percentage of variable value is better rather than exact value of perturbation.
       * Useful to compare EnKF and EKF when it comes to small scale variations. Some studies of small scale variation done at NILU.
       * Introduction Situation dependent limits/thresholds of when to use EKF Jacobians (OI like) not considered promising way forward.
       * There have been no known comparisons between static B (SEKF) and evolving B in EKF and the importance for results and noise.
       * A testbed with off-line version of EKF was considered to be a helpful tool for development. Both LACE and HIRLAM would find such a testbed useful.
       * There is room for improvement in soda EKF/EnKF for handling of satellite data. Such an improvement would be useful both for LACE and HIRLAM. 
         (there could be a common satellite surface observation handling LACE/HIRLAM with handling of scale differences model/instrument, distribution of observations to processors etc.)
       * The DA file handling/MPP environment for SODA EKF/EnKF could be improved on a longer term.
       * The idea to estimate sensitive surface parameters simultaneously with surface data assimilation was considered an interesting approach and there might be worth to look more closely into the work carried out in Austria. 
       * Paper on "An EKF assimilation of AMSR-E soil moisture into the ISBA land surface scheme" by [https://hirlam.org/trac/attachment/wiki/HarmonieWorkingWeek/Surface201604/2008JD011650.pdf Draper et al. (2009)]

       * Patrick will contact Clement with the suggestion that a SODA-branch of SURFEXv8/trunk is created with the purpose to develop both src/ASSIM/soda... and MY_RUN/SODA/... Currently, MY_RUN/SODA/run_soda.sh does not work as it is in SURFEXv8/trunk. Use and development of SURFEXv8 and SODA is currently ongoing in HIRLAM and LACE. For example, Trygve Aspelien (Met-norway) has an updated version of MY_RUN/SODA/run_soda.sh which do work.


