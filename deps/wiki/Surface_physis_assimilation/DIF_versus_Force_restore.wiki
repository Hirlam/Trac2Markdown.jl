[[PageOutline]]
[[Center(begin)]]
= '''Work on DIF versus Force-restore for surface in HARMONIE with SURFEXv8 physics''' =

Last modified [[LastModified]]
[[Center(end)]]

== Plans to evaluate the performance of cy43h in climate mode with the complete set SURFEXv8 namelists options. (Patrick S. - Samuel V. Hangouts on 7 july, 2017) ==

* Our wishlist of surfex 8 namelist options (https://hirlam.org/trac/wiki/Surface_physis_assimilation/New_SURFEX_options_cy43h) has been tested so far (excluding MEB) with short simulations made by Samuel using one of the HCLIM38h1 branches. One of the motivations was to check for the stability of such a setup using options already used in the HCLIM community, but with our NWP 2.5km resolution. Another thing to check was the sensitivity of the simulations to changes in one of the hydrology options, namely the activation of Horton runoff (CHORT='DEF' or 'SGH'). These short simulations can give a hint on the sensitivity of the surface fluxes to the activation of this runoff process (for instance it seems important when snow melts over frozen soils), but a proper study would imply closing the water balance comparing model output with river discharge data, an interesting but complex exercise which for the moment will be postponed.

* Patrick thinks that it can be important to have a global evaluation on how the expected set of SURFEX options works in climate mode in cy43h, prior to the activation of data assimilation. The identification of model biases and other misrepresented processes can be helpful later on when decisions in the development of surface assimilation have to be taken. For that, once the routines in Harmonie-Arome cy43h are updated (by Patrick) to the most recent versions from the SURFEX8 repository, Samuel will generate a climatology running cy43h in climate mode for 5-6 years over the AIB domain and comparing output statistics with local data sources. 

== Discussion on more advanced surface physics in SURFEX, March 14, 2017  ==

Google hangouts meeting with the following participants: Mariken Homleid (Met Norway), Trygve Aspelien (Met Norway), Emily Gleeson (Met Éireann), Patrick Samuelsson (SMHI), Magnus Lindskog (SMHI), Tomas Landelius (SMHI), Roger Randriamampianina (Met Norway), John de Vries (KNMI), Bert van Ulft (KNMI), Jeanette Onvlee (KNMI), Samuel Vianaj (AEMET), Stefan Schneider (ZAMG), Hanneke Luijting (Met Norway), Yurii Batrak (Met Norway), Laura Rontu (FMI).

Steps towards use of more advanced surface physics in SURFEXv8/cy43 are initiated here and there, e.g. looking into diffusion soil scheme and explicit snow scheme. As far as I know ongoing work involve Mariken, Trygve and Åsmund at !MetNorway, John at KNMI, Samuel at AEMET, Tomas and Patrick at SMHI, Emily, Ruth and Kristian for glacier implementation. Thus, we need to coordinate these efforts. 

[https://hangouts.google.com/hangouts/_/ojobrqpibncg7m2o7p3en2kfgee Here is link to the Hangouts session]. It is recommended to connect via a Chrome web browser. Experience shows that it is good to mute your microphone when you don't talk.

=== Background ===

Our plan is to utilize a number of new options in SURFEXv8 as become available in cy43. For overview documentation on SURFEXv8 please refer to:

 * [http://www.umr-cnrm.fr/surfex//spip.php?page=plan SURFEX Home page]
 * [https://hirlam.org/trac/raw-attachment/wiki/HirlamMeetings/Surface201610/LeMoigne_ZAGREB2016_2.pdf SURFEXv8 overview by Patrick Le Moigne in Zagreb 2016]
 * [http://www.umr-cnrm.fr/surfex//spip.php?article423 Course material from latest SURFEX course in Toulouse February 2017]
 * [http://www.geosci-model-dev.net/6/929/2013/gmd-6-929-2013.html Latest published peer-view SURFEX overview paper, v7.2]

More specifically, the options we have in mind in SURFEXv8 are:

 * Diffusion soil scheme (CISBA='DIF'): Default this means 14 prognostic soil layers for soil temperature distributed over a soil column of 12 m. The number of layers used for soil moisture and soil ice are based on the soil depth as defined in the ECOCLIMAP parameter files (different for each grid box). [http://onlinelibrary.wiley.com/doi/10.1002/jgrd.50631/pdf Paper by Decharme et al. (2011) on ISBA-DIF.]
 * Explicit snow scheme (CSNOW='3-L'): Default this means 12 layers of snow with three prognostic variables per layer: snow water equivalent (SWE), density and enthalpy (representing temperature and liquid water). Each layer is also represented by its age in days. The snow albedo (for three spectral bands) is related to the snow age of the top layer. [http://www.the-cryosphere.net/10/853/2016/tc-10-853-2016-discussion.html Paper by Bertrand Decharme et al. on Explicit snow scheme in SURFEXv8].
 * Multi-Energy balance (LMEB=.TRUE.): Explicit canopy in ISBA (comparable to HIRLAM newsnow)  [http://www.geosci-model-dev.net/10/843/2017/gmd-10-843-2017.pdf Paper Aaron Boone et al. on multi-energy balance (ISBA-MEB)]

=== Agenda and memory notes ===

> '''Memory notes are indicated like this.'''

 * Motivation for the meeting by Patrick
   * Coordinate our work.
   * Have a common view on the SURFEXv8 options we head for. The default options in SURFEX are not the recommended ones but the ones that fulfil backward compatibility for NWP.
   * Good to have a common SURFEXv8 offline branch...?
   > The plan is that HIRLAM development and contributions to SURFEX from cy43h onwards should be tightly connected to the SURFEX repository. [https://hirlam.org/trac/wiki/Surface_physis_assimilation/SURFEX_after_cy43t See plan in this wiki]. The best would be if we could have a development branch related to more advanced physics from such a HIRLAM branch in the SURFEX repository. Let's plan for that now and see how the plan proceeds. let Patrick know if you think it takes too long time and you see a need for a common branch earlier than that.
 * Each of us describes what with do with respect to SURFEXv8 physics right now, tests, problems, questions, need for help/cooperation ...
 > Trygve and Mariken: Looks into initialisation of Explicit snow scheme in cy40h environment. The dirty fix in PREP by Patrick S in the climate branch makes it work but we should understand the root of the problem and fix it there. The understanding is all other snow variables in the PREP step in principle follow a proper initialisation of SWE... Trygve also looks into how CANARI communicates with SURFEX. 
 >
 > Tomas utilizes the combination of Explicit snow scheme and two patches in SURFEXv8 to create proper input to the observation operators ECMWF-CMEM and MEMLS. He focuses on EnKF and is in contact with Jostein Blyverket (NILU) about that.
 >
 > Emily works on the implementation of glaciers in SURFEXv8 following the outcome of the [https://hirlam.org/trac/wiki/HarmonieWorkingWeek/Surface201604/Glacier_plans#NotesfromtheglaciersidemeetingatSURFEXWorkshopMeteoFrance discussion recently hold at Météo-France]. She has now MUSC running with SURFEXv8 in the cy43 environment.
 >
 > John is utilizing output from a simulation made with the CY40h1_ISBASFX8 branch to create forcing for SURFEX offline simulations. He develops a method for parameter calibration. The method can later be applied on the cy43h environment when available.
 >
 > Bert runs the climate version of HARMONIE-AROME for 5 years simulations over the Netherlands. After recent bug fixes related to hydro subroutines results look promising.
 >
 > Samuel has set up and has been running the climate version of HARMONIE-AROME over the Pyrenees for 2-weeks test simulations to look into different SGH options. With the help of Daniel he will get Ecflow working for the climate version. This can later be ported to cy43h in climate mode.
 >
 > Mariken has been looking into the Explicit snow scheme in combination with 2 patches. [http://www.umr-cnrm.fr/surfex/IMG/pdf/explicitsnowexperiments_mariken_170227.pdf See her results in this presentation given at the SURFEX Users Workshop in Toulouse].
 >
 > Yurii has implemented ice growth from the HIGTSI into the SICE model and has now a test simulation running.
 >
 > Stefan is successfully testing SODAv8 in assimilation of satellite soil moisture product with EKF for DIF scheme. SODA works well but he has problems with drifting climate in the soil. Maybe something to do with corrupt forcing...? Still to be solved. Stefan has based his development on SODA as found in SURFEX trunk. Clément Albergel has also EKF development ongoing.
 * Working environment:
   * SURFEXv8 can be used offline
   * cy43h (including SURFEXv8) is under development. Before summer we will hopefully have a version available which can be used in climate mode (without data assimilation)
   * The test branch harmonie-40h1_ISBASFX8 can be used but should be replaced with cy43 as soon it is possible.
   * cy40h (SURFEX7.3) can be used for tests with e.g. CSNOW='3-L' but numerical/physical problems may appear... Patrick Le Moigne's message in Zagreb was that it is strongly recommended to go for SURFEXv8 if processes like diffusion soil scheme and explicit snow scheme are of interest since considerable development of these processes have taken place since earlier SURFEX versions.
 * Considered namelist options in SURFEXv8 to be discussed:
 > [https://hirlam.org/trac/wiki/Surface_physis_assimilation/New_SURFEX_options_cy43h See separate wiki page for this list]. Samuel and Patrick will discuss this list with Aaron Boone at Météo-France.
 * Initialisation in PREP:
   * Our considered SURFEXv8 options are used in ARPEGE climate version. Thus, the prognostic variables are initialised in PREP but maybe not very carefully since climate models rely more on an approximate initialisation with a following spin-up period. For example, at !MetNorway they are currently looking into how CSNOW  = '3-L' should be initialised in PREP.
 > As mentioned above, the dirty fix in PREP by Patrick S works for now but we should understand the root of the problem and fix it there.
 * Offline forcing for SURFEX for various tests:
   * Offline forcing in HARMONIE by Trygve [https://hirlam.org/trac/browser/trunk/harmonie/util/forcing/doc] used by HARMONIE to create forcing for SURFEX from AROME simulations when surface EKF is activated.
   * John has developed python scripts to create a SURFEX-OFFLINE package for 2D simulations.
   > Trygve has been thinking on a new offline forcing generation in HARMONIE. Based now on the initiative by John to build a python based offline forcing generation, John and Trygve are asked to coordinate their ideas also with Daniel since there is a long term plan to build the HARMONIE scripting system around python. Stefan also mentions that Victor at Slovakia Met Service has done a similar solution in python. Stefan is asked to bring Victor together with John, Trygve, Daniel.
   * Patrick has written a small F90-package which reads raw [http://www.eu-watch.org/watermip/use-of-WATCH-forcing-data WATCH data files] and write them again in NetCDF format which can be read as forcing into SURFEX.
   > Patrick can add this F90-package in a common HIRLAM branch for SURFEXv8.
 * Links to work with EKF:
   * Which layers in soil/snow should be assimilated? 
   * For example: Clément Albergel (Météo-France) suggested that a climatology of Jacobian values may be used for some soil layers to limit the number of layers updated in each cycle...
   > We do not discuss connections to EKF further at this meeting.
 * How do we proceed? Who works with who? Priorities?
 > We have updated all of us related to new SURFEXv8 options with each others status-of-work. Good! Quite some work is done in parallel and need no immediate coordination. But...
   >
   > We have a common potential list of SURFEX namelist options which are of our interest. Reaming question marks will be discussed with Météo-France by Samuel and Patrick.  
   >
   > We identified colleagues who should coordinate work around offline forcing generation in HARMONIE-AROME. 

== 2016-07-14: The branch harmonie-40h1_ISBASFX8 is in sync with latest tag release of harmonie-40h1.1.rc.1 (by Patrick) ==

The branch [https://svn.hirlam.org/branches/harmonie-40h1_ISBASFX8] is now up to date with latest tag release of harmonie-40h1.1.rc.1. Or more precisely in sync with trunk until r15054. I.e. beyond the tag harmonie-40h1.1.rc.1 (r15044). 

I did a short test simulation using SIMULATION_TYPE=climate on the SMHI cluster and it worked so go ahead and see how it works for you...

== SICE updates by Yurii as reported May 3 2016  ==

In the harmonie-40h1_ISBASFX8 branch I just have updated SICE up to the latest development version. I've ran test experiment for a few cycles. And it has passed without any problems (but I've not checked output, it was only technical test to be sure that new code can be compiled and ran)

== Notes from [https://hirlam.org/trac/wiki/HarmonieWorkingWeek/Surface201604 Surface meeting in Oslo, April 2016] ==

People involved in the discussion: Mariken Homleid (Met Norway), Trygve Aspelien (Met Norway), John de Vries (KNMI), Jeanette Onvlee (KNMI), Laura Rontu (FMI), Ekaterina Kurzeneva (FMI), Patrick Samuelsson (SMHI), Mats Dahlbom (DMI)

       * The aim is to advance from D95 to 3-layer explicit snow scheme
       * Some questions:
         * which surface scheme to be used; ISBA Force Restore or ISBA-DIF?
         * potential improvements of ISBA-DIF also in snow free regions/seasons?
         * how to validate these options?
       * SUREFX offline runs
         * in sites with observations for forcing, e.g Cabauw, Sodankylä, flux net stations
         * in synop positions, with observations for verification, but forced by NWP forecasts
       * Harmonie runs, with a branch including SURFEX-8 version of ISBA (by Patrick)
         * how to design the experiment to answer the questions we have?
         * short runs without surface assimilation to evaluate potential improvements

== Background information ==

Surface physics based on SURFEXv8 (ISBAv8) is available in a cy40h branch (https://svn.hirlam.org/branches/harmonie-40h1_ISBASFX8). The purpose of this branch is to give opportunity to develop HARMONIE utilizing the Explicit Snow Scheme (CSNOW="3-L") and diffusion soil scheme (CISBA="DIF"). The initialisation of the 3-L snow prognostic variables in PREP needs consideration. This part has not been compared with the corresponding SURFEX8 subroutines. Current implementation works technically but not necessarily how it should. For technical reasons the number of soil layers for DIF is hard coded to 14 layers. Just a few layers beneath the surface the time scale of change is far beyond the NWP forecast time scale. Thus, how do we identify the relevant prognostic variables to include in the assimilation and which ones to leave for peaceful coexistence? (Patrick) The SURFEX part of the branch harmonie-40h1_ISBASFX8 is also available as an offline setup of SURFEX. This setup is available here https://svn.hirlam.org/branches/SURFEXcy40h_with_ISBAv8 .
