[[PageOutline]]
[[Center(begin)]]
== '''HARMONIE 33h1''' ==
[[Center(end)]]

== Highlights of Harmonie 33h1 ==

Harmonie 33h1, tagged on 19 June 2008, is an HARMONIE system adaptation to the IFS/ALADIN [http://www.cnrm.meteo.fr/aladin/partner/docoper/Memorandum/cy33t1.pdf Cycle 33T1 ]. 33h1 features as default the upper air and surface data assimilation for 11-km model domain, as well as numerous new additions of functionalities in mSMS script and utilities.

HARMONIE is the acronym for Hirlam's meso-scale forecast system (Hirlam Aladin Regional/Meso-scale Operational NWP In Europe). The HARMONIE system is the product of the HIRLAM-ALADIN joint project HARMONIE: Hirlam-Aladin Research towards Meso-scale Operational NWP in Europe.

The highlights of Harmonie 33h1 include
 * 3DVAR and surface analysis CANARI for 11 km have been tested through. Full HARMONIE data assimilation cycling is now possible for domains SCANDINAVIA, NORWAY and RCR_PLAR
   * So far only observation data from MARS archive has been tested
   * The observations Land SYNOP, TEMP, AIREP, DRIBU, PILOT, AMSU A, AMSU B, Scatterometer wind are the default assimilated observation types
 * CY33T1 updates for data assimilation
   * code adaptation for input of maps of small ensemble DA derived sigma Bs
   * VARBC in ALADIN for SEVIR HR radiances
   * new humidity contro lvariable (E Holm's dev.) in ALADIN
   * adaptations in obs parto for HR AMDAR and AMSU B
   * code cleaning for scatterometer winds
 * CY33T1 updates for AROME forecast model 
   * surfex3 including CANOPY scheme for PBL diagnostics
     * New handing of Surfex output files.
     * naming convention of surfex files is now similar to atmospheric files. 
   * hail added as option, plus fullpos adaptation
   * introduction of EDKF shallow convection as a new technical option
   * the unnecessary ALADIN ISBA read/write in AROME are removed
   * update of the script for boundary file generation
     * AROME needs 3 namelists for bd-gen: for surfex, atmosphere+00h and atmosphere+Nh.
   * Promelange no longer needed 
   * ensure identical model and surface orography
   * reduced size LFI file via key REDUCELFI
   * FULLPOS now supports technically radiance postprocessing.
   * see also [wiki:Harmonie_33h1/dev_arome_forCY33T1.pdf the detailed information  in the Meteo France presentation]
 * CY33T1 updates with ARPEGE/ALADIN FR physics
   * interface for TKE routines introduced
   * fixes in CBR and top-PBL entrainment
   * SURFEX plug-in: make implicit coupling between surface and atmospheric vertical diffusion possible for any model version (ALADIN_FR, ALARO, ARPEGE)
   * fix a bug for CAPE computation in FULLPOS
 * CY33T1 updates with ALARO forecast model
   * vertical diffusion implicit coupling with SURFEX now possible; 
   * code update, mainly that of 3MT (adapted to the CHMI operational version in spring 2008)
 * CY33T1 FULLPOS adaptation for post-processing of the MTS (model to satellite, simulated radiances fields
 * 2D-decomposition in forecast model now the default. This brings a significantly enhanced computational efficiency for forecast model, see demonstrations in http://hirlam.org/portal/fmi/Arome_33h0_at_hpce.png and http://hirlam.org/portal/fmi/Arome_33h0_at_hpce2.png
 * RCR-7.1 equivalent domain, RCR_POLAR (with polar-stereographic coordinate), RCR_POLAR, introduced
 * New field manipulation tool xtool added into GL package, includes implementation of SAL (Structure, Amplitude, Location) software.

== Source code and script updates in Harmonie-33h1 ==
Compared to the previously tagged Harmonie release Harmonie_33h0, the new release contains   [https://hirlam.org/trac/log/trunk/harmonie?action=stop_on_copy&rev=5985&stop_rev=5862&mode=stop_on_copy new features and modifications] in source codes, scripts and utilities, with the highlights summarized below
 * Source code adaptation from [http://www.cnrm.meteo.fr/aladin/partner/docoper/Memorandum/cy33t1.pdf Cycle 33T1 ] (Wilhelmsson)
   * changeset [5938], [5939]
 * Source code modification and scripts and mSMS adaptation for running 3D-VAR upper air analysis and CANARI surface analysis, (Andrae,  Randriamampianina, Lindskog, Trojakova, Guidard, Boloni, Niemela, Yang)
     * changeset [5877], [5884], [5890], [5891], [5903], [5940],[5942-5943],[5945], [5948], [5967], [5974]
 * Harmonie script adaptation to 33T1
     * ALARO update (Andrae, [5956-5957])
     * AROME update (Niemela, [5966])
 * Change of HARMONIE default configuration (Andrae, Niemela, Yang)
     * changeset [5953], [5963], [5964], [5965], [5973], [5976], [5980], [5983-5985] 
 * Script implementation to utilize 2D parallel decomposition in forecast models (Niemela, Andrae)
     * changeset [5900], [5902]
 * Introduction of boundary strategy, initially with 4 alternatives (Andrae)
     * changeset [5906], [5911], [5958]
 * GL and MONITOR utility updates and extensions
     * XTOOL for field manipulation including SAL implementation (Andrae, Niemela, Yang)
       * changeset [5872], [5879], [5883], [5885], [5896-5898],[5913], [5941], [5946], [5954], [5960]
     * Monitor updates (Andrae, Yang)
       * changeset [5878], [5886], [5949-5950], [5969]
     * Other GL modifications for verification algorithm (Andrae, Eerola, Niemela, Mannik, Yang)
       * [5864], [5871], [5873], [5894], [5916-5917], [5921], [5952], [5968], [5978]
 * mini-SMS script enhancement
   * Boundary and surface coupling (Andrae)
     * changeset [5874]
   * Simplified setting for launching Harmonie rootpack installation (Andrae)
     * changeset [5970], [5972]
   * MARS data retrieval and STAGE function (Andrae)
     * changeset [5959], [5961-5962], [5979], [5981]
   * Diverse corrections (Sattler, Andrae, Yang, Niemela)
     * changeset [5862],[5893], [5975], [5977]
 * portability, domain and platform-specific configurations (Andrae,Niemela,Dahlbom, Yang)  
   * Changset [5875], [5901], [5920], [5982]
 * diverse corrections (Andrae]
   * changeset [5947]

== Harmonie-33h1 source code downloads ==

 * On ECMWF, the check-out version of the harmonie-33h1 is available on,
{{{
   ecgate:/home/ms/dk/nhz/harmonie_release/33h1  # on ecgate
}}}
 * harmonie-33h1 release can also be obtained via Subversion command, (At ECMWF, the svn client is available on ecgate but not on HPCE)
{{{
   svn co https://svn.hirlam.org/tags/harmonie-33h1
}}}
 * The export tarball of the harmonie-33h1 is available on ECMWF:ecgate as /scratch/ms/dk/nhz/harmonie-33h1.tar.gz, or on ECFS: ec:/hirlam/src/tar/harmonie-33h1.tar.gz

=== Default experiment configuration and available alternatives ===

Harmonie experiments are configured via various settings defined by environmental variables, name-list etc. which are grouped under script directories such as [https://hirlam.org/trac/[source:tags/harmonie-33h1/sms sms], [source:tags/harmonie-33h1/msms msms ], [source:tags/harmonie-33h1/scr scr] and  [source:tags/harmonie-33h1/nam nam]
{{{
   config-sh, mainly config.$COMPUTER             # platform-specific settings
   config, mainly config.$ARCH                    # platform and compiler-specific settings
   sms, mainly config_exp.h                       # specifications about model, domain, cycling, data etc.
   nam                                            # name-lists for model features and coupling
}}}

The configuration file in [source:tags/harmonie-33h1/sms/config_exp.h sms/config_exp.h] provides default values for key basic settings concerning
 * general paths (source, data, archive)
 * definition of ROOTPACK (model versions etc.)
 * domain, resolution
 * data (climate, observation and verification, coupling)
 * model components (data assimilation, initialisation, forecast, post-processing, verification)

Up till now no official reference Harmonie configuration has been defined, in contrast to the case for RCR in the synoptic Hirlam. Presently, the main characteristics of the 'default' values as defined in config_exp.h includes:
 * A 11 km resolution domain SCANDINAVIA which can be switched to other domains like
   * 11 km domain TEST_11, NORWAY_POLAR, NORWAY, RCR_POLAR, MEDITERRANEAN
   * 5.5 km domain SWEDEN_5.5
   * 2.5 km domain TEST_2.5, SWEDNE_NORTH, SWEDEN-SOUTH, DENMARK, FINLAND_SOUTH, ICELAND, IBERIA
 * Several model versions, compiled under name 'aromodb', allowing switches for
   * AROME, ALADIN, ALARO and HIRALD physics
   * nonhydrostatic or hydrostatic dynamics
 * Hydrostatic Aladin physics (FLAG=ald_h), with possibility to be switched over to
   * nonhydrostatic model with ALADIN physics (FLAG=ald_nh)
   * hydrostatic or nonhydrostatic model with HIRALD physics (FLAG=ald_h and PHFLAG=hlm)
   * alaro-h: hydrostatic model with ALARO physics
   * ald_nh_sfx: nonhydrostatic model with ALADIN physics and SURFEX surface scheme
   * ald_nh_sfx: nonhydrostatic model ALADIN physics and SURFEX surface scheme
   * arome: nonhydrostatic model with meso-NH physics and SURFEX surface scheme
 * Coupling data from ECMWF IFS archive, switchable to
   * RCR archive (hir)
   * Existing/local nesting ALADIN run (ald)
 * Surface and upper air data assimilation by default for coarse resolution domains SCANDINAVIA, RCR_POLAR and NORWAY
   * CANARI surface analysis
   * 3DVAR upper air analysis. 
     * NOTE that due to the explicit need for background error statistics of the same model, the 3DVAR extension for other domains without corresponding B-matrix is currently impossible.

=== Configure and Launch Harmonie experiments from ECMWF-ecgate ===

Since 33h0, the reference Harmonie system on ECMWF platform assumes dual-hosts setup, resembling the traditional settings for the synoptic Hirlam using mSMS. By default, the mSMS script uses the front-end ecgate to configure and launch experiments, whereas HPCE is used for all computations except those for operations related to observation verification and monitoring.

As in the previous versions, the reference ROOTPACK for 33h1 has been pre-built and available on ECMWF HPCE computer, under /ms_perm/hirlam/harmonie/pack/

Following example shows steps to launch an Harmonie-33h1 experiment "H33H1" on ECMWF platform:

 1. Create an experiment directory under $HOME/hm_home and run the setup
{{{
   mkdir -p $HOME/hm_home/H33H1; cd $HOME/hm_home/H33H1
   ~nhz/Harmonie setup           # this by default points the model version to the latest tagged Harmonie release
   PATH_TO_HARMONIE33h1_SOURCE/config-sh/Harmonie setup -r PATH_TO_HARMONIE_33h1_SOURCE -h YOURHOST    # for non-ECMWF platform
}}}
 1. If applicable, put your local source or script changes, which are different but consistent with the reference version as installed in the ROOTPACK, into the current $HOME/hm_home/H33H1 directory, with exactly the same subdirectory structure as in the reference. e.g, if you want to modify a subroutine
{{{
   cd $HOME/hm_home/H33H1; mkdir -p src/arp/setup/src/arp/setup
   cp ~nhz/harmonie_release/33h1/src/arp/setup/src/arp/setup/suphy.F90 src/arp/setup/src/arp/setup  # retrieve default source code
   vi src/arp/setup/src/arp/setup/suphy.F90                                                         # modify the source code
}}}
 1. Edit basic configuration files such as [source:tags/harmonie-33h0/config-sh/config.hpce Env_system -> config-sh/config.YOURHOST] and [source:tags/harmonie-33h0/sms/config_exp.h sms/config_exp.h] to configure your experiment scenarios. Modify specifications for model versions (ALADIN, AROME, ALARO), data locations, settings for dynamics, physics, domain, coupling host model etc. e.g,
{{{
   ~nhz/Harmonie co scr/include.ass         # retrieve default 3DVAR configuration script include.ass
   vi scr/include.ass                       # modify the script
}}}
 1. Launch the experiment
{{{
      PATH_TO_HARMONIE/config-sh/Harmonie start DTG=YYYYMMDDHH DTGEND=YYYYMMDDHH
                                    # e.g., ~nhz/Harmonie start DTG=2008030500 DTGEND=2008030506 LL=12
}}}
If successful, mSMS will identify your experiment name, launch mXcdp and start build and run. If not, you need to examine the mSMS log file $HM_DATA/mSMS.log. $HM_DATA is defined in your Env_system file

On ecgate, you can follow the progress of the runs on $SCRATCH/hm_home/H33H1. More complete results data are available on HPCE:$TEMP
under $HM_DATA: $TEMP/hm_home/H33H1. Under this directory you will find:

   * All binaries under lib/ibmecmwf/bin
   * Model libraries, object files and source code under lib/gmkpack_build
   * Scripts, config files, sms and msms definitions under lib/
   * Utilities such as gmkpack, gl and verification under lib/util
   * Climate files under climate
   * Archived files under archive
   * Working directory for the current cycle under YYYYMMDD_HH
   * Verification working directory on ecgate:$SCRATCH/hm_home/$EXP/lib/util/monitor.
   * Log files under H33H1. All logfiles are also archived in archive

See also previous documentations on
 * HARMONIE ROOTPACK and reference installation on ECMWF-HPCE

== Build HARMONIE ROOTPACK on non-ECMWF platforms ==

Find the instructions here: [wiki:HarmonieSystemDocumentation/LocalInstallation].

== Performing model inter-comparison using Harmonie verification tools ==

For comparison between HIRLAM and HARMONIE experiments it is now possible to extract verification files from your HIRLAM experiment
[source:trunk/hirlam/scripts/VER_create_fld VER_create_fld]. Read more on how to use the
[source:tags/harmonie-33h0/util/monitor/doc verification].

== Technical aspects with 33h1 ==

=== Tested HARMONIE model configurations, components  ===

|| Check of components || model || domain ||platform||  configurations etc. || cycling || reported status || reporters ||
|| build || [[Color(green, gmkpack, rootpack, target pack)]] ||   || [[Color(green, ECMWF, SMHI, DMI)]] ||  || || tested || Ulf Andrae; Xiaohua||
|| climate generation ||  || [[Color(green, SCANDINAVIA, RCR_POLAR, FINLAND_SOUTH, TEST_2.5, DENMARK )]] || [[Color(green, ECMWF )]] || || ||tested ||Ulf, Xiaohua, Sami ||
|| Boundary coupling || [[Color(green, ifs2ald,hir2ald,ald2aro,ifs2aro,hir2aro )]]  || [[Color(green, SCANDINAVIA,RCR_POLAR, DENMARK, FINLAND_SOUTH)]] || [[Color(green, ECMWF )]]  ||  || || tested ||Xiaohua, Sami  ||
|| forecast || [[Color(green, ALADIN, ALARO )]] || [[Color(green, SCANDINAVIA, RCR_POLAR )]] || ECMWF, SMHI  || MF/ALARO physics,hydrostatic  || 24h forecast || tested || Ulf, Xiaohua  ||
|| forecast || [[Color(green, AROME)]]  || [[Color(green, TEST_2.5)]]   || ECMWF || AROME physics,nonhydrostatic. || 24h forecast || tested || Sami, Xiaohua  ||
|| data assimilation, 3DVAR+Canari || [[Color(green, ALADIN )]]  || [[Color(green, SCANDINAVIA,RCR_POLAR )]] || [[Color(green, ECMWF )]]  ||  synop+airep+dribu+ pilot+amsu-A/B+scatterometer || 2 consecutive cycles || tested ||Xiaohua  ||

|| post-processing || [[Color(green, gl, monitor )]] || [[Color(green, SCANDINAVIA,RCR_POLAR )]], [[Color(green, TEST_2.5 and FINLAND_SOUTH (gl,Fullpos,fldextr))]] || [[Color(green, ECMWF )]]  ||  data archiving; verification || multi cycles || tested ||  ||
|| documentation ||  ||    || [[Color(green, hirlam.org wiki )]]  ||  [[Color(green, release notes, list of new features )]], HOWTO, technical test data || ||  ||   ||

=== Technical Information about the tested HARMONIE 33h1 configurations and components  ===

|| model domain || computer platform || model || grid || tested configurations || nr of nodes || nr of tasks per nodes || total elapse time || Billing costs || reporter and last experiment date ||

||  || ecgate/HPCE || AROMODB || master build|| || 1 || 1 || 5h 30 m || 52 ||  Xiaohua, 20080617 ||
||  || DMI XT4 || AROMODB || master build|| || 1 || 2 || 3h 20 m || ||  Xiaohua, 20080618 ||
|| SCANDINAVIA with HIRLAM_60 || HPCE || ALADIN 12 h Forecast || 256x288, DT=300s || MF physics, hydrostatic ||  2 || 20 || 571 s || 60 || Xiaohua, 20080619 ||
|| SCANDINAVIA with HIRLAM_60 || HPCE || ALADIN  Surf Ana || 256x288 || Canari||  1 || 1 || 400s || 1.5 || Xiaohua, 20080609 ||
|| SCANDINAVIA with HIRLAM_60 || HPCE || ALADIN 3DVAR || 256x288|| screen+minimisation ||  2 || 20 || 36+169s || 4+20 || Xiaohua, 20080618 ||
|| RCR_POLAR with HIRLAM_60 || HPCE || ALARO 12 h Forecast || 648x540, DT=300s || alaro+hydrostatic ||  4 || 15 || 2105s || 488 || Xiaohua, 20080618 ||
|| RCR_POLAR with HIRLAM_60 || HPCE || ALADIN Surf Ana || 648x540 || Canari ||  1 || 1 || 691 || 2 || Xiaohua, 20080618 ||
|| RCR_POLAR with HIRLAM_60 || HPCE || ALADIN 3DVAR || 648x540||  screen+minimisation ||  4 || 15 || 52s + 745s || 12+260 ||Xiaohua, 20080618 ||
|| DENMARK with HIRLAM_60 || HPCE || AROME 12 h forecast || 384x400, DT=60s ||  AROME, nonhydrostatics  ||  2 || 20 || 5420s || 630 ||Xiaohua, 20080618 ||



 [[FootNote]]

== Acknowledgement ==
The main source code of the Harmonie 33h1 is based on ALADIN 33T1 released by Meteo France in Toulouse. Tomas Wilhelmsson and Toon Moene participated on-site phasing for Cycle 33T1 in Meteo France. Ulf Andrae, Tomas Wilhelmsson, Sami Niemela, Magnus Lindskog, Alena Trojakova, Vincent Guidard, Roger Randriamampianina, Andrea Storto, Gergely Boloni, Trygve Aspelien, Mats Dahlbom and Xiaohua Yang et al are acknowledged for direct source contributions leading to the various components of the new HARMONIE release.

== References and documentation ==
 * [wiki:HarmonieSystemDocumentation/33h1 Harmonie system documentation ]
 * Meteo France Memorandum on [http://www.cnrm.meteo.fr/aladin/partner/docoper/Memorandum/cy33t1.pdf Cycle 33T1 ],available on MF's restricted-access page
 * Meteo France "Reverse" Memorandum on [http://www.cnrm.meteo.fr/aladin/partner/docoper/Memorandum/cy33t1_reverse.pdf Cycle 33T1 ],available on MF's restricted-access page
 * [https://hirlam.org/trac/attachment/wiki/Harmonie_33h1/dev_arome_forCY33T1.pdf Meteo France Information about new features in AROME model]

----
[[Center(begin)]]
[[Color(red, Last modified on)]] [[LastModified]]
[[Center(end)]]''
