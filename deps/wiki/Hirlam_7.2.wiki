[[PageOutline]]
[[Center(begin)]]
== '''HIRLAM 7.2''' ==
[[LastModified]]
[[Center(end)]]

== Highlights of Hirlam 7.2 ==

Hirlam 7.2 is the official version of the synoptic-scale HIRLAM forecast system, released on Sept 2, 2008. On April 17, 2009, the update version 7.2.1 is released, replacing 7.2 as official release. Compared to Hirlam 7.1, version 7.2 contains as default following main features:
 * 4D-VAR upper air analysis, with no more explicit initialisation
 * Kain Fritsch Rasch Kristjansson condensation scheme
 * Tuning in vertical diffusion, in which the turning of wind stress vector (close to surface as implemented in 6.4) is removed
 * Technical upgrade in ATOVS data assimilation and use of RTTOV-8 library for satellite data assimilation 
 * Update in background error statistics data used for screening and for minimisation, update of bias correction data

== Hirlam 7.2 release history ==

 * Update release Hirlam 7.2.1, tagged on April 17, 2009.
 * Official release Hirlam 7.2, tagged on Sept 2, 2008.
 * Release candidate Hirlam-7.2rc4, tagged on August 29, 2008
 * Release candidate Hirlam-7.2rc3, tagged on April 17, 2008
 * Release candidate Hirlam-7.2rc2, tagged on March 3, 2008
 * Release candidate Hirlam-7.2rc1, tagged on February 8, 2008
 * Beta version Hirlam-7.2beta1, tagged on November 23, 2007.

== Hirlam 7.2 source code downloads ==

 * The official release of Hirlam 7.2, 7.2.1 can be obtained via Subversion command, e.g.,
{{{
   svn co https://svn.hirlam.org/tags/hirlam-7.2.1                     
}}}
 * On ECMWF, a checkout version (checkout of the source code with Subversion export command) of the 7.2.1 is available on ecgate as
{{{
   ecgate:/home/ms/dk/nhz/hirlam_release/7.2.1
}}}
 * The export tarball of the Hirlam 7.2.1 is available on ECMWF:ecgate as `/scratch/ms/dk/nhz/hirlam-7.2.1.tar.gz`, or on ECFS: `ec:/hirlam/src/tar/hirlam-7.2.1.tar.gz`

== New Features in Hirlam 7.2 ==

Hirlam 7.2 contains following main updates over that of Hirlam 7.1, many of these targeted to be the standard options in 7.2
 * '''Data assimilation and use of observation'''
  * __Replacement of RTTOV7 package by RTTOV8 and modificaton to AMSU data assimilation module__ (Tveter, Amstrup, Dahlgren et al, [4849:5444], [5545])
  * __Update and addition for background error structure functions with statistical balance approach__ for RCR domain with 60 level, (Gustafsson). The data are derived from RCR experiments using updated source code (Yang)
  * __Tuning of background error in screening__, including use of index field. Consistent background error statistics is now used in screening as for minimisation with exception of index field; Some of the background error limit and scaling factors have been tuned in the screening part (Lindskog, [5440])
  * __Update and addition for bufrtable, satellite constants and bias correction statistics__ for AMSU-A, AMSU-B and MHS data over sea, sea/ice and sea/ice/land, with Noaa-15/16/17/18 and Metop satellites (Amstrup, [5205],[5538],Dahlgren [5607]). The model data are derived from RCR experiment using updated source code. (Yang)
  * __Analysis with new moisture control variable__ (Gustafsson & Thorstensson, [5516])
  * __Enabling of running background error statistics in parallel mode__, (Gustafsson, [5482])
  * __Update of Seawinds data assimilation__(de Vries, [5465])
  * __Extension to assimilation of AMSU-B data __(Dahlgren, [5282], [5506])
  * __Automatic calculation of observation data array__ Instead of hardcoding, the dimensions for observation arrays plen, nobsh_local, nobsh_hi, plen can now be calculated from actual observation data (CMA file) sizes and thereby avoid waste of memory (Lindskog, [5147])
  * __Improvement in minimisation at VarQC start and end__by resetting search direction to steepest descent when cost function changes in  conneciton with on and off of variational quality control. (Vignes, [5247])
  * __Correction to use more reasonable screening limit__ for ATOVS AMSU data, (Dahlgren, [5636])
  * __Update of radar radial wind observation operator__ Beamwidth is now derived from observation file instead of assuming one-degree one-way beamwidth; The code now supports two-way radar beamwidth. (Salonen, [5183],[5193])
  * __BGOS update__ (Lindskog and Dahlgren, [5298])
  * __Extraction of background error information from acma files__are included (Lindskog, [5307])
 * '''Forecast model'''
  * __Modified Kain Fritsch Rasch Kristjansson condensation scheme__ (Ivarsson and Calvo, [5180], [5270], [5613])
  * __Modification in vertical diffusion scheme CBR__ (Bruijn and Tijm, [5741])
  * __Fog correction__ (Sass, [5291], [5292]])
  * __Modified STRACO evaporation and precipitation release__ (Sass, [5179], [5391], [5664], [5696])
  * __Improvement for adiabatic DFI option__, (Yang, [5499])
  * __Cleanup of the Hirlam physics__in order to minimize the differences between Hirlam and ALADIN versions. (Wilhelmsson and Niemela, [5126],[5127])
 * '''Ensemble forecast'''
  * __Scripts generalisation and enhancement for EPS forecast production__, which enable separation of normal and EPS DA cycling, separation of cycles for ensemble members with and without own analysis; use of TEPS boundary (at 24h interval) (Sattler, [5404] etc)
  * __Enhancement of the mini-SMS parser__ to serve the needs in EPS scenario, (Sattler, [5294])
 * '''Script and system aspects'''
  * __OpenMP__ directives in (HIRVDA) spectral forecast model (Wilhelmsson, [4998:5529],[5530],[5701],[5704],[5705])
  * __Replace bi-linear vertical interpolation by integration__ in Vineta and in TOVS Jacobian, (Gustafsson, [5518], [5560])
  * __Raise the precision level for humidity data in GRIB output to 16 bits__, (Feddersen, [5384])
  * __OpenMP__ directives in grid-point forecast model (Vignes, [5557])
 * '''Other technical improvements, bug fixes in code and scripts'''
  * Implementation of __aggregation of sug-grid sloping surface parameters in the climate generation__ to allow parameterisation of orographic radiation (Sattler, [5687])
  * __Correction in climate generation__ to pass correctly vegi field to be used in ISBA soil type setting [Sattler, [5672])
  * Improved __script setting for LSMIX__ in operational launch (Vignes, [5695], [5770])
  * Retrieval of ECMWF boundary data on __rotated lat-long grid and on frames__ to reduce storage, (Yang, [5700])
  * Fixed a __February 29 bug__ in spectral HIRLAM which affects 4D-VAR (Ivarsson, [5751])
  * Correction of a __radiation bug__ associated with extreme temperature (Rontu, [5752])

Compared to Hirlam_7.2, the last update version 7.2.1 switches the default dual hosts computer platforms at ECMWF HPC from ecgate/HPCE to ecgate/C1A. In addition, it ports several system updates and bug corrections recently installed in the developing versions for Hirlam-7.3.

== Meteorological Evaluation of Hirlam 7.2 ==

A real time parallel suite using the latest version of the 7.2-series has been maintained for FMI-RCR-runs from May to August 2008. Verification scores for these months are shown at https://hirlam.org/portal/oprint/ObsVer/. Relative to HIRLAM 7.1 They show a general and persistent reduction of the random errors of the surface pressure and in all upper-air fields. The biggest improvement is found in the relative humidity: the earlier large wet bias near the jet stream level is gone, and the dry bias of the lower troposphere is reduced. Systematic changes in the weather parameters tend to be small during the test period. The new version gives a little lower night-time wind speeds, thus reducing to some extent the long-lasting positive bias. By contrast, although precipitation forecasts are improved in terms of standard deviation, the frequency of weak rainfall occurence is clearly overestimated in Hirlam 7.2.

=== Earlier evaluation of 7.2 rc2 ===

||Model versions for parallel comparison || experiment domain || main configuration differences  || computer platform|| tested episode || verification || testers ||  notes ||
|| 7.2 rc2 radiation bug fix test [[FootNote(before and after radiation bug correction)]]  || RCR 7.1 || Laura's bug fix on radiation bug || HPCE || [http://hirlam.org/portal/validation/7.2/71272RRC2_200702 200702] and [http://hirlam.org/portal/validation/7.2/71272RRC2_200608 200608] || EWGLAM OBS ||  Xiaohua Yang  || pre-tagging test of 7.2 rc2 ||
|| 7.1.2, 7.2 rc 1 and 7.2 rc2 candidate[[FootNote(before radiation bug correction)]]  || RCR 7.1 || 7.1 vs 7.2 rc1, 7.2 rc2: 3DVAR vs 4DVAR, STRACO vs KFRK || HPCE || [http://hirlam.org/portal/validation/7.2/712RC2RCN_200702 200702] and [http://hirlam.org/portal/validation/7.2/712RC2RCN_200608 200608] || EWGLAM OBS ||  Xiaohua Yang  || pre-tagging test of 7.2 rc2 ||

 [[FootNote]]

== Running Hirlam 7.2-code series on the ECMWF platform ==

 * The default configuration setting is ecgate, where ecgate (HOST0) is used for launching jobs and simple serial tasks and HPCE (HOST1) is for computations. Please use reference installation on `ecgate:~nhz/hirlam_release` 
 * To set up an experiment "{exp}" on ecgate, you can go through following sequence of actions as in examples:
{{{
  mkdir ~/hl_home/{exp}; cd ~/hl_home/{exp}
  ~nhz/Hirlam setup -r 7.2.1                  # running system 7.2.1
}}}
 * To modify source code or scripts, first 'check out' the reference ones and modify them. e.g,
{{{
  ~nhz/Hirlam co scripts/Env_domain; vi scripts/Env_domain
  ~nhz/Hirlam co scripts/Env_expdesc; vi scripts/Env_expdesc
  ~nhz/Hirlam co grdy/putdat.F; vi scripts/putdat.F
}}}
 * Launch experiment, e.g,
{{{
  ~nhz/Hirlam start DTG=2006030100 DTGEND=2006033106    # to perform cycled experiments from start cycle DTG to end cycle DTGEND
}}}
 * See also further examples of job launch command in the following sections.

== Install and run 7.2 system on non-ECMWF platforms ==

 * On non-ECMWF platforms, a local installation is needed by either local system manager or user self. A local installation needs an climate data (HDF file) set updated to 7.2. The procedure is simillar to [https://hirlam.org/trac/wiki/HirlamHowto/Install/General#WhatisanHDFSETandwherecanIfindtheHDFsets that of 7.0], except to replace all instances of `hdfdb-7.0` there with `hdfdb-7.2`.

 * Then install the HIRLAM source code on a local path $localpath:
{{{
   svn co https://svn.hirlam.org/tags/hirlam-7.2.1 7.2.1                   # with internet access, or
   tar -zxvf hirlam-7.2.1.tar.gz; mv hirlam-7.2.1 7.2.1                    # with a source code tarball
}}}
   1. `alias Hirlam $localpath/hirlam/config-sh/Hirlam`
   1. `Hirlam setup -r 7.2.1 -d $localpath`
   1. Launch the job with:
{{{
    Hirlam start DTG=$yyyy$mm$dd$hh
}}}

== Alternative configurations with HIRLAM 7.2 ==

 * __Cold start of the new model version__ Hirlam 7.2 contains correction in climate generation which affects the ISBA-VEGI fields, especially for tile 3. Replacement of such fields affects description of soil moisture characteristics, which typically takes rather long spin-up time for model to adapt. In order that such changes in climate generation to take effect in operational application, it may require that the operational centers, when adopting 7.2rc1 or later versions, to cold-start model runs several weeks ahead of the targeted operational usage.
 * __Choice of model domain__
   * The default reference model domain is RCR_7.1. Several commonly used model domains have been defined in scripts/Env_domain with environmental variable DOMAIN as RCR_7.1, RCR_7.0, EPS71, EPS71T etc, the choice for which is specified in scripts/Env_expdesc.
 * __Data assimilation with 4D-VAR__ is now the standard option. If you have questions about experiment settings, write to the HIRLAM 4DVAR mailing list ([mailto:4dvar@hirlam.org 4dvar@hirlam.org])
   * Default background error structure function is based on statistical balance, which is available for both 40 and 60 levels, with the 60-level one updated recently
   * In scripts/Env_expdesc the following baseline configuration of 4D-VAR has been choosen but users can explore alternative options:
{{{
  FCINT=06            # assimilation interval in h
  ASSWIN=06           # length of assimilation window in h
  NOUTERLOOP=1        # number of outer loops
  ILRES=3             # minimisation resolution in 4DVAR innerloop
  OBSCUT=0230         # observation cutoff time relative to the nominal analysis time (hhmm)
                      # another possibility for operational usage is OBSCUT=0130, with shorter cutoff time
  ILPHYS=MFSP1        # innerloop (tangent lienar and adjoint) physics NONE,BUIZZA,
                      # MFSP1 (simplified vertical diffusion),MFSP2 (MFSP1+large scale condensation)
  SPNDTIME=1800       # time step in spectral TLM and ADM during 4DVAR minimisation. 
                      # May consider 1200s in case of finer inner loop resolution
  NQLIMIT=60          # iteration limit for 4DVAR innerloop minimisation
  SPHALO=10           # halo zone width in number of grid point for spectral HIRLAM used in 4DVAR minimisation
  NBZONE=6            # boundary relaxation zone width in inner loop
  MINALG=CG           # CG in minimisation (M1QN3 is another option)
  VARQCSTART=15       # onset time for VarQC (iteration step)
  VARQCEND=25         # turn off time for VarQC (iteration step)
  JCDFI=yes           # yes to use weak constraint JcDFI for gravity wave damping
  LBCCONTROL=no       # yes to use lateral boundary control in 4DVAR (not fully tested)
  LOWRESINCR=yes      # yes to use lower resolution during 4DVAR minimisation
  PROPAGATECONTROL=yes
                      # yes to use tangent linear model TL to advect analysis increment from start of assimilation window
                      # no to use nonlinear forecast model to project analysis increment to nominal analysis time
}}}
 * __Data assimilation with 3D-VAR__
   * 3D-VAR assimilation scheme is now non-default option. It can be activated by setting ANALYSIS=3DVAR in scripts/Env_expdesc
   * For 3D-VAR, the default options is 6h cycling (FCINT=06) with FGAT.
   * Default background error structure function is now based on statistical balance, which is available for both 40 and 60 levels. The new structure function data is obtained from RCR forecast using the NMC method.
   * The default 3DVAR minimisation uses full resolution (LOWRESINCR=no) assuming the resolution in the background error structure function is the same as forecast model. When used for finer resolution 3DVAR such as 5 to 10 km, please consider to change LOWRESINCR in scripts/Env_expdesc to yes to avoid too noisy analysis increment, unless you use locally derived B.
 * __Choice of re-forecast scheme__ The re-forecast using ECMWF analysis is controlled by parameters in scripts/Env_expdesc
   * LSMIX. Put it to no if you do not want to use re-forecast scheme
   * MIXINT. Put to 06 for operational use in which ECMWF analysis is available 4 cycles/day
 * __Launch of single cycle job__. In Hirlam 7.2 (with changeset [5695]), the mSMS scripts have been modified to allow easier script setting for operational usage when LSMIX (large scale mixing) scheme is used. The change enables an easy operational cycle scheduling consisting of a sequence of single cycles with either regular (long)  or re-forecasts. Environment variables RUN and RUNEND have been introduced to indicate the tasks for the current (DTG) and finishing (DTGEND) cycles, with RUN=1 and RUN=2 specifying regular/long and re-forecast for cycle DTG, respectively. Correspondingly, RUNEND=1 and RUNEND=2 indicate the expected task to be performed at DTGEND. As default, RUN=1 and RUNEND=1. At the end of each forecast cycle, progress.log is updated with both DTG and RUN information. Thus in operational application, a sequence of single forecast can be launched at command line (or as crontab job), using 'prod' launching option, to form operational cycles, e.g.:
{{{
   Hirlam prod            # giving DTG and RUN=1, this performs a long forecast for cycle DTG. This is then finished with RUN updated to 2
                          # in progress.log. This is followed by
   Hirlam prod RUNEND=2   # giving DTG and RUN=2, this performs a re-forecast for cycle DTG. This is then finished with DTG updated to 
                          # next cycle point and RUN to 1 in progress.log. This is then followed by
   Hirlam prod            # giving the new DTG and RUN=1, this performs long forecast for the new cycle DTG and update RUN to 2 at the end
}}}
 * __Running non-reference configuration__
   * It is strongly advised that, in setting up model configurations which in any way deviates from that of reference settings, users only do modifications on top of the checked-out version of the reference source code or script. Do not copy directly source code or scripts from your previous experiments that are based on earlier model versions. See also [wiki:HirlamHowto/Install/ECMWF wiki page] for instructions on such procedure.
 * __Choice of physics scheme__ 
   * Kain Fritsch Rasch Kristjansson condensation scheme is now the default scheme.
   * STRACO condensation scheme may be used by changing COND_SCHEME from KF to STRACO in scripts/Env_expdesc
   * By default, cloud ice is not an explicit model variable/output in the KF scheme 
     *  WARNING! In the present HIRLAM code using KFRK-option (default in 7.2rc1 and 7.2rc2), cloud ice is not an explicit model variable/output. In addition, the variable "cloud water" (WMO number 76 at model levels, postprocessed to pressure levels or vertically integrated) is interpreted as total condensate in case of KFRK, but cloud liquid water in STRACO. The values of vertically integrated sum of cloud ice and water (137,200,0) and cloud ice (58,200,0) are undefined in KFRK. Thus, these cloud water, cloud ice and cloud condensate variables are not backward compatible in the output of the default HIRLAM 7.2 release candidates. This inconsistency will be solved before the official release of Hirlam 7.2.
   * Moist CBR is the standard option and defined as NOPTION(3)=3 in the scripts FCinput. Technically its dry version is available with NOPTION(3)=2
 * __Choice of output data streams__
   * Edit Env_domain to request more model level output data than the default
   * Edit Env_expdesc for OUTSTREAM to add or reduce post-processing data stream and parameters
 * __Choice of archiving location and amount at ECMWF platform__
   * Use "ectmp" instead of "ec" to specify temporal instead of permanent archiving site. Note that data archived to "ectmp" disappear after about 3 months
 * __Choice of permissions for archived results at ECMWF platform __
   * Choose "hirlam" instead of "default" for ECFSGROUP to ensure accessibility of experiment results by other hirlam colleagues. 
 * __Choice of ECMWF boundary data__
   * Use "bc" as BDSTRATEGY for data from ECMWF-BC suite. Note the full BC data are available from ECMWF MARS for only limited length of time
   * The default now retrieves ECMWF forecast data on rotated coordinate and frames. If you want to use BD data over regular lat-long coordinate and full set, you may specify parameter ROTATE and FRAMES as no.
 * __Ensemble prediction__
   * Ensemble prediction is switched off per default (ENSSIZE=-1 and ENSFIRST=-1)
   * Ensemble mode is switched on by following setting in `Env_expdesc`:
     * ENSSIZE ensemble size (number of perturbed members), set to a number larger or equal to 000 (use 3 digits!)
     * ENSFIRST to 000, if the control run is to be performed, or to 001 or higher to skip control run and run for perturbed members only
   * Current boundary data availability:
     * the boundary data from ECMWF-EPS and TEPS (model-level files) are not available from MARS
     * `.mars` files are therefore pre-retrieved, and stored on a boundary data pool on [[Color(green, ectmp:/hirlam/bnd)]]. From there they are available for HIRLAM EPS experiments over a period of about three months.
     * boundary data models
       * ECMWF-EPS boundary data from 0 and 12UTC runs, currently retrieved on regular coordinate with full data
       * Norwegian TEPS from 12UTC runs
   * more settings concerning HIRLAM EPS: see [wiki:HirlamSystemDocumentation/EPS/Settings]
   * Data is archived in a sub-directory for each member under the normal cycle-directory

== Technical Information ==

=== Tested architecture, model domains and components ===

||tested version|| model domain ||computer platform||tested configurations ||purposes of tests||

|| 7.2 rc 2 || RCR-7.1 ||ECMWF-HPCE || 4DVAR and 3DVAR, KFRK and STRACO, SL || technical test ||
|| 7.2 rc 2 || RCR-7.1 ||FMI-Altix ||  4DVAR and 3DVAR, KFRK and STRACO, SL || technical test ||
|| 7.2.1 || RCR-7.1 ||ECMWF-C1A || 4DVAR and 3DVAR, KFRK and STRACO, SL || technical test ||

 [[FootNote]]

=== Computation cost === 

'''3D-VAR'''

||model domain||tested 7.2 versions ||platform||nr of node,processors||plen||nr of iteration || elapsed time||HPC billing unit||

||RCR-7.1 || 7.2rc2 || HPCE || 2,16|| dynamic || ( 63 iterations) || 362s ||  42 ||

 [[FootNote]]

[[BR]]

'''4D-VAR'''

||domain||tested 7.1 release||platform||simplified phys||nr of iterations ||structure function||resolution|| nr of node,processors ||plen||my_shared_memory||elapsed time||HPC billing unit||

||RCR 7.1||7.2rc2||ECMWF-HPCE||MFSP1||60||statistical||1/3||3,16,48||dynamic||yes ||1300-1570s||230-274||
||RCR 7.1||7.2.1||ECMWF-C1A||MFSP1||60||statistical||1/3||2,32,64||dynamic||yes ||~1000s||370||
||RCR 7.1||7.2rc2||FMI-Altix||MFSP1||60||statistical||1/3||121||dynamic||yes ||~900s||N/A||
 [[FootNote]]

[[BR]]

'''Forecast'''

||domain||tested 7.2 versions ||condensation schemes || platform||nr of nodes|| task per node || my_shared_mem || nprocx||nprocy||ncpu_hgs||nhalo||time step||elapsed time per step||48 h Forecast elapsed time||HPC Billing cost||

||RCR 7.1||7.2rc2||KFRK || ECMWF-HPCE||4||30 || yes || 8||11||2||6||360s||~3.5s||1702-1963s||300-340||
||RCR 7.1||7.2.1||KFRK || ECMWF-C1A||3||62 || yes || 15||12||6||6||360s||~1.1s||600s||330||
||RCR 7.1||7.2rc2||KFRK || FMI-Altix||1||121 || yes ||11||11||0||6||360s||~2.0s||~1400s||N/A||
||RCR 7.1||7.2rc2||STRACO ||HPCE||4||30 || yes || 8||11||2||6||360s||~3.2s||1602s||280||

 [[FootNote]]

== Reference ==
 * De Bruijn, E.I.F., and ijm, A.B.C., 2008: Overall tuning of the turbulence scheme of HIRLAM with the focus on the stable boundary layer. HIRLAM newsletter 53.

== Acknowledgement ==
The following are acknowledged for their direct contribution to the the code and script updates featured so far in HIRLAM 7.2:

'''DA'''
 * Bjarne Amstrup, Per Dahlgren, Carlos Geijo, Nils Gustafsson, Kirsti Salonen, Magnus Lindskog, Sigurdur Thorstensson, Frank Tveter, Henrik Vedel, Ole Vignes, John de Vries, Tomas Wilhelmsson, Xiaohua Yang     

'''Forecast model'''
 * Trygve Aspelien. Javier Calvo, Henrik Feddersen, Karl-Ivar Ivarsson, Aidan !McDonald, Sami Niemela, Veniamin Perov, Claus Petersen, Laura Rontu, Bent Hansen Sass, Sander Tijm  

'''System'''
 * Kalle Eerola, Toon Moene, Jacob Weismann Poulsen, Kai Sattler, Tomas Wilhelmsson, Ole Vignes, Xiaohua Yang
----
[[Center(begin)]]
[[Color(red, Last modified on)]] [[LastModified]]
[[Center(end)]]
