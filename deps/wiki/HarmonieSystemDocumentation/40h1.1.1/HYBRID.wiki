[[PageOutline]]
[[Center(begin)]]
= '''A 3DVAR-LETKF Hybrid Gain approximation in HARMONIE-AROME tag 40h1.1.1''' =
[[Center(end)]]

== Previously ==

It is recommended to take a look to LETKF in HARMONIE-AROME tag 40h1.1.1 description in https://hirlam.org/trac/wiki/HarmonieSystemDocumentation/40h1.1.1/LETKF

== Background ==

The Hybrid Gain Ensemble Data Assimilation is a simple way to combine a low rank pure ensemble based data assimilation system with a full rank one. In our case it is applied to LETKF and 3DVAR but it could be extended to other systems. This idea was proposed by Penny et al (2014) and it has been satisfactorily implemented with IFS 4DVAR-LETKF (see Bonavita et al. and Hamrud et al., 2015). Steps to construct this Hybrid Gain are the following ones:

1) Do the LETKF and 3DVAR air analyses separately 

2) Construct a new Hybrid Analysis by linear weigthing 

  '''AnHYB = K * AnLETKF + (1-K) * An3DVAR'''      

  (where K=0.5 is an optimal value)

3) Recenter LETKF ensemble around AnHYB

4) Take AnHYB Forecast to be the next cycle First Guess for 3DVAR analysis

By construction this Hybrid Gain approximation has potential benefits from 3DVAR and LETKF single improvements. 

== Compilation of LETKF code within HARMONIE package ==

Take a look to section "Compilation of LETKF code within HARMONIE package" in https://hirlam.org/trac/wiki/HarmonieSystemDocumentation/40h1.1.1/LETKF

== Setting up a basic Hybrid 3DVAR-LETKF experiment in HARMONIE-AROME ==

To have a complete description of a basic Hybrid 3DVAR-LETKF experiment setup, one can take a look to AROME_HYBRID testbed configuration in [source:tags/harmonie-40h1.1.1/scr/Harmonie_configurations.pm].  

Two files need to be modified. In [source:tags/harmonie-40h1.1.1/sms/config_exp.h] one needs to change:

{{{
ANAATMO=LETKF            
ANASURF_MODE=after
NOUTERLOOP=1
CH_RES_SPEC=no
BDINT=1                                     # It could be BDINT=3...
HH_LIST=0-21:3                         
HWRITUPTIMES="00-03:1"                      # It could be HWRITUPTIMES=00-03:03...                    
PWRITUPTIMES="00-03:1"                      # It could be PWRITUPTIMES=00-03:03...
PFFULLWFTIMES="00-03:1"                     # It could be PFFULLWFTIMES=00-03:03...
VERITIMES="00-03:1"                         # ...
SFXWFTIMES="00-03:1"                        # ...
SFXFULLTIMES="00-03:1"                      # ...
BDSTRATEGY=simulate_operational
ENSMSEL=0-10                                # Number of ensemble members... 
PERTSURF=model                             
LL_LIST="3"                                 # So far it works in a 3-hour assimilation cycle...
LETKF_LAG=no                                
HYBRID=yes
SCALE_PERT=yes
}}}

In [source:tags/harmonie-40h1.1.1/msms/harmonie.pm] one needs to change to:

{{{
'ANAATMO'  => { 0 => 'LETKF' },
'LSMIXBC'  => { 0 => 'yes' },
}}}

At the moment (October 3rd 2018), LETKF has been tested to properly assimilate Conventional Observations, ATOVS and GNSS (see [source:tags/harmonie-40h1.1.1/scr/include.ass]). While Conventional Observations and GNSS can be assimilated with harmonie-40h1.1.1 tag, ATOVS observations need to use harmonie-trunk (or contact to pescribaa @ aemet.es)

== Comparison of Hybrid Gain with LETKF and 3DVAR ==

To be included

== Contact ==
 
In case of questions you can send an email to Pau Escribà (AEMET), pescribaa @ aemet.es.

== References ==

* Bonavita, Massimo, Mats Hamrud, and Lars Isaksen, 2015: EnKF and Hybrid Gain Ensemble Data Assimilation. Part II: EnKF and Hybrid Gain Results. Mon. WEa. Rev., 143, 4865-4882. https://doi.org/10.1175/MWR-D-15-0071.1
* Hamrud, Mats, Massimo Bonavita, and Lars Isaksen. 2015: EnKF and Hybrid Gain Ensemble Data Assimilation. Part I: EnKF Implementation. Mon. Wea. Rev. 143, 4847-4864. https://journals.ametsoc.org/doi/pdf/10.1175/MWR-D-14-00333.1/10.1002/qj.2748
* Penny, G. S., 2014: The hybrid local ensemble transform Kalman filter. Mon. Wea. Rev. 142, 2139–2149. https://doi.org/10.1175/MWR-D-13-00131.1