[[Center(begin)]]
= '''The HARMONIE testbed''' =
[[Center(end)]]

The HARMONIE testbed provides a facility to run a number of well defined test cases using the existing script environment in HARMONIE. The ALADIN testbed,
[wiki:HarmonieSystemDocumentation/38h1.2/Evaluation/Mitraillette mitraillette] runs test on the hart of the model, the dynamical core. The HARMONIE testbed tests the full script system as it is supposed to be used.
[[BR]]

== Defining the configurations ==

The testbed is a mSMS experiment that launches and follows new mSMS experiments one at a time in a controlled environment. The testbed experiment takes care of compilation and also hosts the climate files generated by the tested configurations. Source and scripts changes shall be done in the testbed experiment and will be synchronized to the child experiment using the hm_CMODS option in HARMONIE. 

A number of basic configurations have been defined in [source:tags/harmonie-38h1.2/scr/Harmonie_configurations.pm Harmonie_configurations.pm] as the deviation from the default setup in 
[source:tags/harmonie-38h1.2/sms/config_exp.h config_exp.h]. These configurations are controlled by the script 
[source:tags/harmonie-38h1.2/scr/Harmonie_testbed.pl Harmonie_testbed.pl]. The script also contains a number of extra configurations tested from time to time. With the current settings, a test of AROME without 3DVAR would look like.

{{{

    # AROME no 3D-VAR but default blending of upper air from boundaries
    'AROME' => {
      'description' => 'Standard AROME settings without upper air DA',
      'PHYSICS'     => 'arome',
      'SURFACE'     => 'surfex',
      'DYNAMICS'    => 'nh',
      'ANAATMO'     => 'blending',
      'ANASURF'     => 'none',
      'DFI'         => 'none',
      'HOST_MODEL'  => 'ifs',
      'DOMAIN'      => 'DKCOEXP',
      'VLEV'        => '65',
      'BDINT'       => '3',
    },

}}}

The resulting output, in this case from AROME_BD_ARO running at ECMWF would look like:

{{{

 Using the configuration AROME_BD_ARO


 Input /gpfs/scratch/ms/spsehlam/hlam/test_harmonie/ecgb_c2a_testbed_trunk_mkp_12413/sms/config_exp.h 
 Output sms/config_exp.h 

 Change BUILD=${BUILD-yes}                     to BUILD=no 
 Change       BUILD_ROOTPACK=no to BUILD_ROOTPACK=no 
 Change BINDIR=${BINDIR-$HM_DATA/bin}                 to BINDIR=$HM_COMDAT/ecgb_c2a_testbed_trunk_mkp_12413/bin 
 Change DOMAIN=DKCOEXP                          to DOMAIN=TEST_8 
 Change VLEV=65                                 to VLEV=HIRLAM_60 
 Change LL=${LL-06}                             to LL=6 
 Change DYNAMICS="nh"                           to DYNAMICS=nh 
 Change PHYSICS="arome"                         to PHYSICS=arome 
 Change SURFACE="surfex"                        to SURFACE=surfex 
 Change DFI="none"                              to DFI=none 
 Change ANAATMO=3DVAR                           to ANAATMO=none 
 Change ANASURF=CANARI_OI_MAIN                  to ANASURF=none 
 Change OBDIR=$HM_DATA/observations             to OBDIR=$HM_DATA/../ecgb_c2a_testbed_trunk_mkp_12413/observations/ 
 Change HOST_MODEL="ifs"                        to HOST_MODEL=aro 
 Change HOST_SURFEX="no"                        to HOST_SURFEX=yes 
 Change SURFEX_INPUT_FORMAT=lfi                 to SURFEX_INPUT_FORMAT=fa 
 Change BDLIB=ECMWF                             to BDLIB=AROME 
 Change BDDIR=$HM_DATA/${BDLIB}/archive/@YYYY@/@MM@/@DD@/@HH@   to BDDIR=$HM_DATA/../ecgb_c2a_testbed_trunk_mkp_12413/archive_AROME/@YYYY@/@MM@/@DD@/@HH@/ 
 Change INT_BDFILE=$WRK/ELSCF${CNMEXP}ALBC@NNN@                 to INT_BDFILE=$ARCHIVE_ROOT/$YY/$MM/$DD/$HH/ELSCF${CNMEXP}ALBC@NNN@ 
 Change BDSTRATEGY=simulate_operational to BDSTRATEGY=same_forecast 
 Change BDINT=1                         to BDINT=3 
 Change SURFEX_PREP="no"                to SURFEX_PREP=yes 
 Change CLIMDIR=$HM_DATA/climate                to CLIMDIR=$HM_DATA/../ecgb_c2a_testbed_trunk_mkp_12413/climate/$DOMAIN/$PHYSICS 
 Change BDCLIM=$HM_DATA/${BDLIB}/climate        to BDCLIM=$HM_DATA/../ecgb_c2a_testbed_trunk_mkp_12413/climate/TEST_11/arome/ 
 Change INT_SINI_FILE=$WRK/SURFXINI.$SURFEX_OUTPUT_FORMAT       to INT_SINI_FILE=$ARCHIVE_ROOT/$YY/$MM/$DD/$HH/SURFXINI.$SURFEX_OUTPUT_FORMAT 
 Change ARCHIVE_ECMWF=yes                       to ARCHIVE_ECMWF=no 
 Change POSTP="inline"                          to POSTP=inline 
 Change MAKEGRIB=no                             to MAKEGRIB=yes 
 Add new settings JBDIR=$HM_REV/testbed_data/jb_data 
 Add new settings LARGE_EC_BD=no 
 Add new settings PLAYFILE=harmonie 
 Add new settings config=AROME 


 Input /gpfs/scratch/ms/spsehlam/hlam/test_harmonie/ecgb_c2a_testbed_trunk_mkp_12413/Env_submit 
 Output Env_submit 

 Change $nprocx=16; to $nprocx=2 
 Change $nprocy=16; to $nprocy=2 
 Change $nprocx=8; to $nprocx=2 
 Change $nprocy=16; to $nprocy=2 

}}}

As seen from the example above the script also changes the submission rules. These rules can be defined, per host, at the end of the script. Other host specific settings may also be defined to allow local changes of the test environment. In Harmonie_testbed.pl we find e.g. changes for ecgb:

{{{

 'ecgb' => {
   'BINDIR'     => '$HM_COMDAT/'.$EXP.'/bin',
   'BDDIR'      => '$HM_DATA/../'.$EXP.'/$BDLIB',
   'OBDIR'      => '$HM_DATA/../'.$EXP.'/observations/',
   'LARGE_EC_BD' => 'no',
   'CLIMDIR'    => '$HM_DATA/../'.$EXP.'/climate/$DOMAIN/$PHYSICS',
  },

}}}

The host dependent settings will be imposed on all configurations. If a setting in any configuration is in conflict with the host settings the configuration settings will be used.

[[BR]]

== The playfile ==

The playfile used for the testbed is 
[source:tags/harmonie-38h1.2/msms/testbed.tdf testbed.tdf]. Here each configuration is defined with a trigger, a task to create and one to follow the child experiments. 
Configurations inluded are listed in the TESTBED_LIST environment variable in sms/config_exp.h

{{{
 TESTBED_LIST="ALADIN ALADIN_3DVAR AROME"
}}}

If the child experiment fails the Follow_exp task will also fail. When the child experiment problem has been corrected and the task restarted, the follow task should be restarted. When, finally, the child experiment is finished the test family will be completed and next test case will be triggered. We may choose to let the testbed launch a new experiment if the current child experiment fails. This is done by setting in sms/config_exp.h 

{{{
 TESTBED_CONT_ON_FAILURE=1
}}}


== Input data ==

The standard testbed configuration is run over the 50x50 TEST_11 domain. The domain and resolution is chosen to be computationally cheap and not to give meteorologically interesting and meaningful results. Input data for running the testbed is ECMWF boundaries, observations, background error statistics and climate files. Input data can be downloaded from hirlam.org [https://hirlam.org/portal/download/testbed/38h1/ here]. Download the data to your machine and put it on the default location {{{$HM_REV/testbed_data}}} or define your location in [source:trunk/scr/Harmonie_testbed.pl Harmonie_testbed.pl]. If you wish to test the climate generation you simple redefine the location of the climate files or remove the existing ones in the climate directory of the testbed. The current testbed data contains the following

 * ECMWF boundaries for 2008093018-2010100100 to be used for the deterministic configurations
 * ECMWF boundaries for 2012061000-2012061012 for EPS
 * ECMWF boundaries for 2012053100-2012060200 for climate simulation
 * Conventional observations for the deterministic and EPS runs
 * Background error statistics for the TEST_11 domain.
 * For double nesting experiments, e.g. AROME to AROME, the TEST_8 domain is used as the inner domain.


== Starting the testbed ==

The testbed experiment is setup as any normal experiment with

{{{
Harmonie setup -r REVISION -h HOST
}}}

The testbed is launched by

{{{
Harmonie testbed 
}}}

Before you start the testbed you should define your reference experiment.  The reference experiment is picked automatically as an experiment with the same name but with lower revision number. The reference experiment can also be defined by the by setting REFEXP in sms/config_exp.h as the full path to another testbed experiment:

{{{

export REFEXP=/scratch/ms/spsehlam/hlam/hm_home/test_37h12

}}}


== Evaluation of the result ==

At the end of each testbed run the results are compared to a reference experiment using the script [scource:scr/Testbed_comp Testbed_comp]. The script uses xtool to check the numerical difference of the last 6h forecast fore each configuration. In addition the internal consistency is checked by comparing runs with different parallel decomposition or the consistency between a deterministic run and a EPS run with the control member.

{{{

HARMONIE testbed results from c2a-batch
Tue Oct  1 06:09:44 UTC 2013

Configuration: c2a
 Build method: makeup

Compare revision ecgb_c2a_testbed_trunk_mkp_12365 and ecgb_c2a_testbed_trunk_mkp_12363

Check:AROME
  Compare /scratch/ms/spsehlam/hlam/hm_home/ecgb_c2a_testbed_trunk_mkp_12365/archive_AROME/2008/09/30/18/ICMSHHARM+0006
       vs /scratch/ms/spsehlam/hlam/hm_home/ecgb_c2a_testbed_trunk_mkp_12363/archive_AROME/2008/09/30/18/ICMSHHARM+0006
  Files are equal
  Compare /scratch/ms/spsehlam/hlam/hm_home/ecgb_c2a_testbed_trunk_mkp_12365/archive_AROME/2008/09/30/21/ICMSHHARM+0006
       vs /scratch/ms/spsehlam/hlam/hm_home/ecgb_c2a_testbed_trunk_mkp_12363/archive_AROME/2008/09/30/21/ICMSHHARM+0006
  Files are equal
  Compare /scratch/ms/spsehlam/hlam/hm_home/ecgb_c2a_testbed_trunk_mkp_12365/archive_AROME/2008/10/01/00/ICMSHHARM+0006
       vs /scratch/ms/spsehlam/hlam/hm_home/ecgb_c2a_testbed_trunk_mkp_12363/archive_AROME/2008/10/01/00/ICMSHHARM+0006
  Files are equal

 ...

}}}

All the logs from any testbed experiment are posted to the testbed mailing list [https://hirlam.org/pipermail/testbed]. The test returns three different status signals

 * OK means that all configurations reproduces the result of your reference experiment.
 * OK, BUT NO COMPARISON means that the suit run through but that there was nothing to compare with
 * FAILED means that the internal comparisons failed
 * DIFFER means that one more configurations differ from your reference experiment
 * FAILED and DIFFER is a combination of the last two

 In addition to the summary information detailed information can be found in the archive about the art of the difference.

== When to use the testbed ==

It is recommended to use the testbed when adding new options or make other changes in the configurations. If your new option is not activated the result compared with the reference experiment should be the same, if not you have to start debugging. When changing things for one configuration it's easy to break other ones. In such cases the testbed is a very good tool make sure you haven't destroyed anything.

----

Last modified [[LastModified]]
