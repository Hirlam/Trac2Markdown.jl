[[PageOutline]]

[[Center(begin)]]
== '''Harmonie System Documentation''' ==
= '''Set-up for running HarmonEPS experiments''' =
[[Center(end)]]

== Background ==
This page describes the common set-up of the HarmonEPS experiments as defined in the HIRLAM work plan for 2013 and in the notes from the working week in October 2012 and March 2013 (https://hirlam.org/trac/attachment/wiki/GLAMEPS_HARMONEPSworkingweek2012/GLAMEPS_ww_report_october2012.pdf and https://hirlam.org/trac/attachment/wiki/GLAMEPS_HARMONEPSworkingweek2013-1/GLAMEPS_ww_report_march2013.pdf ). To be able to compare the results from the different experiments it is 
important that we are all using the same version and set-up. 

Before you start you need to read this page: [wiki:HarmonieSystemDocumentation/38h1.2/EPS/Howto How to run an ensemble experiment].

== Basics ==
The experiments are to be run with 20 + 2 members, 10 + 1 with Arome physics and 10 + 1 with Alaro physics. The resolution is 
2.5 km, and the number of vertical levels is 65. The two control members are to be run with 3DVAR with 6 hourly cycling. 
The other members use blending and are run every 12 hour. The forecast length is 36 hours. 

For experiments focusing on only one of the physics options (eg the CA experiment) it is important to use the same boundaries
for the same members as in the full experiments where all members are included, in that way we can substitute the new Alaro members
with the original ones and compare the performance.

== Area ==
The initial experiments are to be performed for an area of 450 x 540 points. [[Image(https://imap.met.no/service/home/~/HarmonEPS_1.png?auth=co&loc=no&id=49042&part=2)]]). 

This area is quite similar to the area 
used by DWD for their convection permitting EPS, hence we have something to compare our system against. 

== Structure functions ==
NB! Error in generation of the structure functions used by default detected in October 2014. You should use new: stabfiltn_HarmonEPS1New_int_128.cv and stabfiltn_HarmonEPS1New_int_128.bal).
Updated in the branch harmonEPS-38h1.1.
The structure functions (.cv and .bal files) to be used are interpolated from the structure functions made for the metCoOp-area using jbconv. 
Using the area defined for this experiment (HarmEPS_1) you will automatically use these interpolated structure functions.

== Branch ==
REVISION=38h1                       
BRANCH=harmonEPS_13100 

Please check https://hirlam.org/trac/log/branches/harmonEPS-38h1.1 for latest changes to the branch.

== Test periods ==
We will run HarmonEPS by nesting in ECMWF data, at least initially. For the experiments that will nest in EC EPS we have prepared
a test period with available model level data, from both a high resolution version of EC EPS and at original resolution:

For the period 20 January 2011 to 9 February 2011:
1. Operational EPS T639, 00 and 12 UTC. Model levels can be found in ecfs: ec:/zno/BND_v1_v2/ECEPS
2. Higher resolution EPS T1279 (here after called H-EPS), 06 and 18 UTC. Model levels can be found in mars with class=no and expver=b0xw. This data is stored on Gaussian grid (not SH) and using a bit map to cut out ~Europe. This is done to save storage space in mars.

The initial experiments will be done for this period and the summer period provided by Martin L (both EPS T639 and EPS T1279 for 10.06.2012 - 28.06.2012).

For more details on the summer period (and other priods provided by ECMWF) See: https://software.ecmwf.int/wiki/display/LAMEPS/Availability+of+ensemble+BC+data You need to be registered to see this page. Contact Inger-Lise or Umberto Modigliani at ECMWF.

A list of test periods can be found here: wiki:HarmonieSystemDocumentation/38h1.2/EPS/Testperiods

== SBUs ==
At present it is not clear how much SBUs we have to do our experiments. What is clear, however, is that there will probably be a shortage. In 2012 we did not use all our SBUs, but this will change now that we start running HarmonEPS. We are all encouraged to use SBUs from other sources (eg national) if possible. If you would like to use SBUs from account 'hlameps' for you experiments you need to contact Inger-Lise first to get approval.

== Spin-up run ==
For our experiments we need to spin-up the two control members to avoid having to cold start HarmonEPS. The spin-up periods are 3 weeks.

For the test period from 2011 ( 20 January 2011 to 9 February 2011) the control members have been cycled from 1st January with full DA until the start of the experiment period (~ 3 weeks).

Now also the 3 week spin-up run for the summer case in 2012 is finished. Spin-up from 21 May 2012 for the test period from 10 June 2012 - 28 June 2012.

See below on how to use this in your experiment.

NB: run with the corrupted structure functions!

== Scripts changes ==
This describes in detail the basic script changes that have been done or that you need to invoke yourself in order to run this basic set-up of HarmonEPS. Experiment specific changes that might be needed are not included here.

In [source:tags/harmonie-38h1.2/sms/config_exp.h sms/config_exp.h] The following are now set as default settings in the branch (as of Nov 2014):
{{{
BRANCH=harmonEPS_13100
DOMAIN=HarmEPS_1 
VLEV=65 
LL=${LL-6}
ANAATMO=blending 
FCINT=12 
BDSTRATEGY=eps_ec 
ENSMSEL=0-21 
ENSINIPERT=bnd 
WRITUPTIMES="00 03 06 09 12"   # These two writeuptimes can be reduced to a minimum
SWRITUPTIMES="00 03 06 09 12"  # because we use inline_fulpos for our output
INLINE_FULLPOS=yes 
FPOUTINT="1"     
MAKEGRIB=yes   # output in grib
OBSMONITOR=no  # Crashes frequently
}}}

Here we use LL=6 so that LL can vary with time of day: long forecast at main hours only, 6h for the intermediate runs. Then it is important to set 
LLMAIN=36 in the command when you  submit your forecast (after 'start' or 'prod'). In some experiments the main hours are 06 and 18, see below how to handle this.

In [source:tags/harmonie-38h1.2/config-sh/submit.ecgb config-sh/submit.ecgb] set the appropriate account to bill you run to


In [source:tags/harmonie-38h1.2/msms/harmonie.pm msms/harmonie.pm] the following is now default in the branch (as of 28. February 2013):
{{{
Removed the comments from ANAATMO, FCINT, PHYSICS, ENSCTL and ENSBDMBR. Put ENSBDMBR' => [ 0, 0, 1..20 ]
}}}

In [source:tags/harmonie-38h1.2/scr/MARS_get_bd scr/MARS_get_bd]:
{{{
This is the place to make sure you get the right boundaries. To use the high resolution EPS that is prepared
for the first exp you need to change two places for BDSTRATEGY="eps_ec":
EXPVER=b0xw
CLASS=NO

To use the data that are stored in ecfs, obviously some coding is needed here.

To use the data that Martin Leutbecher has produced, you need to change the EXPVER accordingly and put CLASS=RD.
}}}

In [source:tags/harmonie-38h1.2/scr/Boundary_strategy.pl scr/Boundary_strategy.pl] make sure you use the right offset for you boundaries:
{{{

For example, when nesting in the High resolution EPS from ECMWF that are produced at 06 and 18 UTC, change from: 

} elsif ( $strategy eq 'eps_ec' ) { 
   if ( $hh == 0 || $hh == 12 ) { 
      $hh_offset = 0;
   } else { 
      $hh_offset = 6;
   } ;


to:

} elsif ( $strategy eq 'eps_ec' ) { 
   if ( $hh == 0 || $hh == 12 ) { 
      $hh_offset = 6;
   } else { 
      $hh_offset = 0;
   } ;

Because the EC boundary data are available at 06/18 for this case, you need to change the offset so
that it will retrieve 6 hour old data for 00/12 UTC, and 0 hour old data at 06/18 UTC. For the test
data from ECMWF that is run for 00/12 UTC the original configuration is to be kept. So you need
to make sure you have the offset correct as to which boundary data you use.
}}}

If using 06 and 18 as your main hours you need to change in [source:tags/harmonie-38h1.2/scr/submission.db scr/submission.db]:
{{{
change
 if ( $HH % 12 ) { $LL = $llshort; } else { $LL = $ENV{LLMAIN}; } 
to
 if ( $HH % 12 == 0 ) { $LL = $llshort; } else { $LL = $ENV{LLMAIN}; } 
}}}

You also need to do the same in [source:tags/harmonie-38h1.2/scr/Boundary_strategy.pl scr/Boundary_strategy.pl]

NOTE: Bug detected Nov 2013 when running with 06/18 as main hours: The problem with the current code is that not all members have
the same FCINT, and this is not properly accounted for in the Start script. Temporary fix:
{{{
check out (i.e., Harmonie co) scr/Start and change the line

FirstHour=$(( $StartHour % $FCINT ))    export FirstHour

to

FirstHour=0  export FirstHour
}}}

In [source:tags/harmonie-38h1.2/scr/Setup_inline_postp scr/Setup_inline_postp]:
{{{
As of 28 February a new version of Setup_inline_postp is included. This gives the following output parameters:

*AROME:
Accumulated rain 
Accumulated snow
Accumulated graupel
Snow depth water eqiv. 
Surface SW down radiation
T2m
Max Temp 
Min Temp
WinSpeed10m 
RH2m
Total Cloud 
U-momentum of gusts
V-momentum of gusts
U10m
V10m
U-component (500, 850 and 925hPa)
V-component (500, 850 and 925hPa)
Geopotential(500, 850 and 925hPa)
Temperature (500, 850 and 925hPa)
MSLP   
Surface pressure      
Total precipitation  
Wind direction screen level

*ALARO:
Snow depth water eqiv. 
Accumulated stratiform rain
Accumulated convective rain 
T2m
Max Temp
Min Temp   
WinSpeed10m
RH2m
U10m
V10m 
Total Cloud 
U-momentum of gusts (currently zero due to bug)
V-momentum of gusts (currently zero due to bug)
Temperature (500, 850 and 925hPa)
Geopotential (500, 850 and 925hPa)
MSLP
Surface pressure 
Total precipitation
Wind direction screen level


A slight change in Makegrib was also necessary to achieve this (included in the branch)
}}}

== Storage of results ==
Everybody needs to make sure that they store their output-files from fullpos (the files ending with _fp) in a safe place. Ecfs could be such a place.

== cca ==
harmonEPS38h1.1 is on cca

== To start your run from the spin-up data ==
Spin-up of the two controls have been performed for two test periods. You can find them on ecfs ec:/fai/spinup
They are named: spinup_YYYYMMDDHH_mbr000.tar and spinup_YYYYMMDDHH_mbr001.tar

Member 000 is Arome, and Member 001 is Alaro.

To use the spin-up data is not straight forward. This is because the way Harmonie is set up to NOT do assimilation for the first cycle, 
so that would ruin everything with the spin-up data. Originally we planned to make changes in the scripts to make this work automatically. 
However, it turned out to be quite some work because it involves many scripts and you can easily do something wrong. So for the time being, 
we do it manually in the following way: First run a dummy run for one cycle (eg for 2011-01-20-06), then manually replace the resulting
FG (ICMSHHARM...) and FGS (AROMOUT_..., in cy38 ICM...sfx) files 
for all the members with the ones from the spin-up runs (replace on c2a under $SCRATCH/<userid>/hm_home/<your exp name>/archive/yyyy/mm/dd/hh/mbr<nnn>). Then check if progress.log and progressPP.log are correct (in the example it was 
not correct, it was 2011-01-20-18, while it should be 2011-01-20-12. This bug should be fixed now, but check to be sure it is correct, so that in the example you start at 2011-01-20-12). 
Then start your exp again using "prod" (and not "start", you do not want a cold start!), so that the exp will continue from the cycle where now the correct data from the 
spin-up is placed.

If you run it the way of the default set-up, then mbr 0, 3, 4, 7, 8, 11, 12, 15, 16, 19, 20 are Arome and
mbr 1, 2, 5, 6, 9, 10, 13, 14, 17,18, 21 are Alaro, so put the spin-up from mbr000 in all the Arome members of your dummy run, 
and the spin-up from mbr001 in all the Alaro members of your dummy run.

== A step-by-step example on how to use the spin-up runs for the summer period:==
1) Run your dummy run:

Harmonie start DTG=!2012061000 DTGEND=!2012061000 LLMAIN=06

2) When this is finished delete all AROMOUT...(in cy38 ICM...sfx) and ICM.... files on c2a (in my exp /scratch/ms/no/fai/hm_home/HM_EPS25_prod_summer/archive/2012/06/10/00/mbr<nnn>) for all mbr nnn, and substituted with corresponding files from the spinup run that you can find here: ec:/fai/spinup/spinup_2012061000_mbr000 and ec:/fai/spinup/spinup_2012061000_mbr001. mbr 0, 3, 4, 7, 8, 11, 12, 15, 16, 19, 20 are Arome so put spinup from mbr000 for this and mbr 1, 2, 5, 6, 9, 10, 13, 14, 17,18, 21 are Alaro so put spinup from mbr001 for this. I copied in all files that are in the spinup-tar files, although there are more than you need (more forecast times) because I found that the simplest thing to do. 

3) Make sure progress.log and progressPP.log are correct. This bug is correct so should be ok now. DTG is supposed to be !2012061006 in the log files.

4) Start experiment again using 'prod':

Harmonie prod DTGEND=!2012062812 LLMAIN=36

From cycle !2012061012 we have results that we can verify (as 06 only runs the control).

== Known problems ++ ==
Many problems fixed in week 21 (2013), still remaining:
* If your run crashes in RunCanari and rerunning this one task does not help, it can be that something
  went wrong in RunBatodb (without this task crashing). As RunBatodb is now moved to the same family as RunCanari you can easily try to rerun RunBatodb. 
  The reason for this problem is known; it is because several members are  writing to the same bufr file which sometimes makes it fail. Work is ongoing to fix this. 
* Listen4Makegrib fails. A quick-fix was introduced on 25 May that hopefully will lead to fewer crashes. 

[[Center(begin)]]
[wiki:HarmonieSystemDocumentation Back to the main page of the HARMONIE System Documentation]
[[Center(end)]]
----

[[Center(begin)]]
[[Disclaimer]]

[[Color(red, Last modified on)]] [[LastModified]]
[[Center(end)]]










