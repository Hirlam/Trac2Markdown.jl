[[PageOutline]]

[[Center(begin)]]
== '''Harmonie System Documentation''' ==
= ''' Derivation of Structure Functions ''' =
[[Center(end)]]

== '''General''' ==
For each new model domain, in order to carry out upper air data assimilation (3DVAR or 4DVAR) one needs to generate background error covariances (generally referred to as structure functions). 
Within the HARMONIE community the derivation has been based on data generated with ensemble HARMONIE forecasts which downscale from ECMWF EPS runs. To alleviate spin-up issues the HARMONIE 
forecasts are run up to 6 hours. Using the ECMWF LBC data, 6h HARMONIE ensemble forecasts are initiated from ECMWF 6h forecasts daily from 00 UTC and 12 UTC, with ECMWF forecasts as initial 
and lateral boundary conditions. To obtain stable statistics, it seems appropriate to run 4 ensembles for the chosen episode (s). Ideally the episodes should sample different seasons. 
Therefore it is recommended to run for one winter month and one summer month, for example January and July, 2012. Thereby we sample both seasonal (January, July)  and daily (00 UTC and 12 UTC) 
variations. After running of the ensembles the archived results (6h forecasts) are processed to generate structure functions by running a program called 'festat'. This documentation 
describes a new environment for generating structure functions and it has been tested on cy38h1.2, and it is applicable on this version and versions after that. The main changes in the new 
environment as compared with the old environment are: (1) the ensemble forecasts are all run under on single experiment within the HARMONIE mini-sms system, (2) a software 'FEMARS' is run to 
generate GRIB files of forecasts differences after each cycle have completed in HARMONIE mini-sms and (3) a parallel version of the 'festat' is run as a last step of the single mini-sms 
experiment, after that the forecast difference files have been generated for the entire period.  

Note that under certain circumstances there is a method to technically run 3/4DVAR using structure functions derived from another HARMONIE model domain. That requires that your HARMONIE 
model domain is embedded in the original domain from which structure function has been derived, and with same vertical coordinate. Thus the derivation of structure function is usually the first step to go before any VAR experiment can be done. There is a program developed for converting structure functions from one area to another but it is recommended to be used for technical tests only. The procedure decribed below is the recommended one and it has been tested on HARMONIE cy38b1.1.beta1, from which version it is applicable. For earlier versions the old procedure for generating structure functions should be used (wiki:HarmonieSystemDocumentation/38h1.2/Structurefunctions). The procedure for generating structure functions from an ensemble of forecasts is described below for a AROME setup with 2.5 km horizontal resolution, 65 vertical level and a domain covering Denmark. The experiment is run for a winter-period of 10 days followed by a summer-period of 10 days on the ECMWF ecgb/cca computing system. Forecasts are run twice a day.  In the section below detailed instructions on how to generate the structure functions are give..The other sections deals with how to diagnose the structure functions and how to interface the newly generated structure functions into the data assimilation. There is also a tool for interpolating background error statistics from one domain to another. This procedure is described in the section 'Interpolation of background error statistics between different domains for technical data assimilation tests' and it is only intended for technical assimilation tests. Finally something about recent and ongoing work and future development plans.
  
== '''Generating background error statistics on ecgb/cca, for area DKCOEXP''' ==
  1. Preparation of one mini-sms ensemble experiment for running 4 downscaled 6h forecasts. 
     1. On ecgb $HOME directory create hm_home/38h12_b1 directory. Then cd $HOME/hm_home/38h12_b1.
     1. Create experiment by typing '~hlam/Harmonie setup -r ~hlam/harmonie_release/tags/harmonie-38h1.2.beta.1 -h ecgb-cca'.
     1. edit sms/config_exp.h as follows:
       * set ECFSLOC=ec, 
       * set ANAATMO=none,
       * set ANASURF=none,
       * set FCINT=12,
       * set BDSTRATEGY=enda,
       * set BDINT=6,  
       * set ENSMSEL=1-4,
       * set FESTAT=yes,
      1. Placed in hm_home/38h12_b1 and check out 'harmonie.pm' by typing '~hlam/Harmonie co harmonie.pm'. Then you will get s file 'hm_home/38h12_b1/msms/harmonie.pm'. Edit this file as follows: 
       * set 'ANAATMO'  => { 0 => 'none', 1 => 'none' },
       * set 'LSMIXBC'  => { 0 => 'no', 1 => 'no' },
       * set 'ANASURF'  => { 0 => 'none', 1 => 'none' },
       * set 'FCINT'    => { 0 => 12,       1 => 12 },
       * set 'ENSBDMBR' => [ 1, 2, 3, 4 ],
       * set 'PHYSICS'  => [ 'arome','arome','arome','arome' ],
       * set 'ENSCTL'   => [ '001',  '002',  '003',  '004' ],
       * set 'TSTEP'    => [ '60',  '60',  '60',  '60' ],
      1. Placed in hm_home/38h12_b1 check out 'Festat' by typing '~hlam/Harmonie co Festat'. Then you will get s file 'hm_home/38h12_b1/scr/Festat'. Replace the checked out 'Festat' script with the updated 'Festat' script that is attached as the bottom of this wiki-page. You can dowload it to your local disk and transfer it to ecgb with 'ftp ecaccess.ecmwf.int'.
      1. Replace hm_home/38h12_b1/config-sh/submit.ecgb-cca with the updated 'submit.ecgb-cca' that is attached as the bottom of this wiki-page. You can download it to your local disk and transfer it to ecgb with 'ftp ecaccess.ecmwf.int'.

  1. Launch of mini-sms ensemble experiment, Part 1 (example 1-10 January 2012, 6 h forecasts 06 and 18 UTC, run full January 1-31 when producing and not just testing ):
{{{
   ~hlam/Harmonie start DTG=2012010106 DTGEND=2012010118 LL=06
}}} 
  1. After that the Part 1 10 day experiment have finished (take a couple of days up to one week), launch mini-sms ensemble experiment, Part 2 (1-10 July 2012, 6 h forecasts 06 and 18 UTC, again run full July 1-31 when producing and not just testing):
{{{
   ~hlam/Harmonie start DTG=2012070106 DTGEND=2012070118 LL=06
}}} 
  1. Taking care of results. After that both the first and the second part of the mini-sms ensemble experiment have finished the resulting background error statistics (structure functions will be found on c2a:$TEMP/hm_home/38h12_b1/archive/extract/. The name of the files are stab_38h12_b1_2012070106_160.bal.gz, stab_38h12_b1_2012070106_160.cv.gz and stab_38h12_b1_2012070106_160.cvt.gz. (There are also files called  stab_38h12_b1_2012070106_80.bal.gz,stab_38h12_b1_2012070106_80.cv.gz and  stab_38h12_b1_2012070106_80.cvt.gz, but these are based on forecast differences of the January period only and should be ignored).
== '''Generating background error statistics on ecgb/cca with EDA cycling, for area DKCOEXP''' ==
  1. Preparation of one mini-sms ensemble experiment for running 8 EDA member 6h forecast cycling with 3DVAR 
     1. On ecgb $HOME directory create ~/hm_home/38h12_b1 directory. Then cd $HOME/hm_home/38h12_b1.
     1. Create experiment by typing '~hlam/Harmonie setup -r ~hlam/harmonie_release/tags/harmonie-38h1.2.rc.1 -h ecgb-cca'.
     1. edit sms/config_exp.h as follows:
       * set LSMIXBC=no
       * set FCINT=6
       * set BDSTRATEGY=enda
       * set BDINT=3 
       * set FESTAT=yes
       * set ENSMSEL=1,2,3,4,5,6,7,8
       * add export ENSSIZE=8 
       * set PERTATMO=CCMA
       * set PERTSURF="yes" 
      1. in $HOME/hm_home/38h12_b1, check out 'harmonie.pm' by '~hlam/Harmonie co harmonie.pm'. Then you will get file 'hm_home/38h12_b1/msms/harmonie.pm'. Edit this file as follows: 
       * set 'LSMIXBC'  => { 0 => 'no', 1 => 'no' },
       * set 'ENSBDMBR' => [ 1, 2, 3, 4,5,6,7,8 ],
       * set 'PHYSICS'  => [ 'arome','arome','arome','arome','arome','arome','arome','arome' ],
       * set 'ENSCTL'   => [ '001',  '002',  '003',  '004','005','006','007','008'  ],
       * set 'TSTEP'    => [  '75',  '75',  '75',  '75','75',  '75',  '75',  '75'  ],
      1. in $HOME/hm_home/38h12_b1, edit 'Env_submit'. Edit this file
       * set $nproc_festat=320; the number here is the size of ensemble: number of run per day (4) x number of days (10) x number of EDA members (8)
  1. Launch of mini-sms ensemble experiment
{{{
   ~hlam/Harmonie start DTG=2013081500 DTGEND=2013081418 LL=6
}}} 
  1. After the EDA runs have finished, the resulting background error statistics (structure functions) will be found on cca:$SCRATCH/hm_home/38h12_b1/archive/extract/. The name of the files are stab_38h12_b1_2013081500_320.bal.gz, stab_38h12_b1_2013081500_320.cv.gz and stab_38h12_b1_2013081500_320.cvt.gz. 

== Diagnosis of background error statistics ==
   1. Diagnosis of background error statistics is a rather complicated task. To get an idea of what the correlations and covariances should look like take a look in the article: Berre, L., 2000: Estimation of synoptic and meso scale forecast error covariances in a limited area model. Mon. Wea. Rev., 128, 644-667. A software for investigating and graphically illustrate different aspects of the background error statistics has been developed and statistics generated for different domains has been investigated (see attached report below by Nils Gustafsson). With this software you can also compare your newly generated background error statistics with the one generated for other HARMONIE domains. This will give you and idea if your statistics seems reasonable. For diagnosing the newly derived background error statistics follow these instructions:
       1. Go to $SCRATCH on ecgb
       1. ecp ec:/smx/Jb_wiki_ml/jbdiagconv_ensys.tar .
       1. tar -xvf jbdiagconv_ensys.tar will give directory $SCRATCH/jbdiagconv
       1. Go to $SCRATCH/jbdiagconv where you find subdirectories data (containing background error statistics for different domains and directories containing output-statistics for different domains (for example 'diagDKarome' and  'diagFIarome'). You will also find two .f90 files and three scripts for diagnostics.
       1.Placed in $SCRATCH/jbdiagconv compile jbdiagnose.f90 and jbconv.f90 by typing './Compile'. That will generate jbdiagnose.x and  jbconv.x. Thereafter fetch your background error statistics files from  ec:/$uid/jbdata and gunzip then and place them in $SCRATCH/jbdiagconv/data (in this example stab_38h12_b1_2012070106_160.bal and stab_38h12_b1_2012070106_160.cv). Create a directory ${SCRATCH}/jbdiaconv/diag for output (mkdir ${SCRATCH}/jbdiagconv/diagEXP). Then edit 'jbdiagnose.ksh' to read your data and adjust namelist to your domain settings (horizontal resolution and vertical levels). Finally generate statistics by place in ${SCRATCH}/jbdiagconv typing './jbdiagnose.ksh'. A lot of statistics files appears in directory ${SCRATCH}/jbdiagconv/diag. Copy ${SCRATCH}/jbdiagconv/diag to ${SCRATCH}/jbdiagconv/diagEXP (by cp -r).
       1. Placed in ${SCRATCH}/jbdiagconv plot statistics of your newly derived background error statistics with './plotbaloper_arome.sh', 'plotspdens_arome.sh' and 'plotvercor.sh'. This will generate a lot of postscript files in directory ${SCRATCH}/jbdiagconv. The statistics is for newly generated structure functions (named EXP) as well as for structure functions of other domains, plotted together. The meaning of these can be found in attached document by Gustafsson. Note that the plot scripts can be adjusted to plot different vertical levels instead of the currently chosen level.
   1. Another way to diagnose the background error statistics is to investigate the analysis increments of various types of data assimilation experiments. For carrying out such experiments we however first need to introduce our newly generated background error statistics into a data assimilation experiment. That procedure is describe below for a full scale data assimilation experiment (utilizing in this example the domain placed over Denmark (named DKCOEXP), for which the statistics was derived).

== Test 3DVAR with the new background error statistics ==
      1. create hm_home/38h12_assim directory. Then cd $HOME/hm_home/38h12_assim.
      1. create experiment by typing '~hlam/Harmonie setup -r ~hlam/harmonie_release/tags/harmonie-38h1.2.beta.1 -h ecgb-cca'.
      1. Check out the file include.ass by typing '~hlam/Harmonie co scr/include.ass' 
      1. In include.ass set JBDIR=ec:/$uid/jbdata (uid being your userid, in this example 'ec:/smx/jbdata') and  f_JBCV='name of your .cv file in ec:/$uid/jbdata' (without .gz) and f_JBBAL is 'name of your .bal file in ec:/$uid/jbdata'  (without .gz)  (in this example ,f_JBCV=stab_38h12_b1_2012070106_160.cv, stab_38h12_b1_2012070106_160.bal).  Add these three lines instead of the three lines in include.ass that followsright after the elif statement:'elif [ "$DOMAIN" = DKCOEXP ]; then'. If domain is other than 'DKCOEXP' one has to look for the alternative name of the domain. 
      1. From $HOME/hm_home/38h12_assim launch experiment by typing
{{{
   ~hlam/Harmonie start DTG=2012061003 DTGEND=2012061006 LL=03
}}}
      1. The resulting analysis file be found on c2a (ssh c2a) under $TEMP/hm_home/38h12_assim/archive/2012/06/10/06 and it will be called 'MXMIN1999+0000' and on and ectmp:/smx/harmonie/38h12_assim/YYYY/MM/DD/06. To diagnose the 3D-VAR analysis increments of the 38h12_sinob-experiment, copy the files MXMIN1999+0000 (analysis) and ICMSHHARM+0003 (fg) to $TEMP. The first guess (background) file can be found on $TEMP/hm_home/38h12_assim/archive/2012/06/10/03 and ectmp:/smx/harmonie/38h12_assim/YYYY/MM/DD/03.  Convert from FA-file format to GRIB with the gl-software ($TEMP/hm_home/38h12_assim/bin/gl) by typing './gl -p MXMIN1999+0000' and './gl -p ICMSHANAL+0000'. Then plot the difference between files file with your favourite software. Plot horizontal and vertical cross-sections of temperature and other variables using your favourite software (MetgraF or cross for example).
      1. Now you have managed to insert the newly generated background error statistics to the assimilation system and managed to carry out a full scale data assimilation system and plot the analysis increments. The next natural step to further diagnose the background error statistics is to carry out a [wiki:HarmonieSystemDocumentation/38h1.2/SingleObs_ensys single observation impact experiment], utilizing your newly generated background error statistics. Note the variables REDNMC and REDZONE in include.ass. REDNMC is the scaling factor for the background error statistics (default value 0.6/0.9 
for DKCOEXP/NEW_DOMAIN. REDZONE described how far from the lateral boundaries (in km) the observations need to be located to be assimilated (default value 150/100) for DKCOEXP/NEW_DOMAIN.

== Interpolation tests ==
Interpolation of background error statistics between different domains for technical data assimilation tests:
   1. A tool has been developed to interpolate background error statistics derived for one domain, to another domain. The purpose is to make it easier to get started and to carry out technical data assimilation tests for new domains. The functionality of the tool 'jbconv' is documented in detail in an attached report by Nils Gustafsson. One constraint worth mentioning is that the number of vertical levels of the two domains should be the same. In addition, wave number 1 in the spectral representation of errors should be larger for the input domain than for the output. In practice this mean that the length (in km) of the longest side of the domain should be longer for the input domin than for the output domain. By doing some settings in the HARMONIE system background error statistics can automatically be interpolated from one area to another in HARMONIE data assimilation experiments. This procedure is described below and it has been tested on HARMONIE cy38b1.1.beta1, from which version it is applicable. In the illustrative example background error statistics are automatically generated for the MEDITERRANEAN domain from the DENMARK domain in a HARMONIE assimilation experiment carried out over the  MEDITERRANEAN domain.

      1. create hm_home/38h12_jbint directory. Then cd $HOME/hm_home/38h12_jbint.
      1. create experiment by typing '~hlam/Harmonie setup -r ~hlam/harmonie_release/tags/harmonie-38h1.2.beta.1 -h ecgb-cca'.
      1. Edit sms/config_exp.h as follows:
        * set DOMAIN=MEDITERRANEAN,
        * set JB_INTERPOL=yes,
      1. Check out the file jbconv.sh by typing '~hlam/Harmonie co scr/jbconv.sh'.
      1. Replace the file jbconv.sh with the corrected one attached at the bottom of this page. 
      1. Check out the file domain_prop.F90 by typing '~hlam/Harmonie co util/gl/prg/domain_prop.F90'.
      1. Replace the file domain_prop.F90 with the corrected one attached at the bottom of this page.
      1. Launch the single observation impact experiment by standing in hm_home/38h12_jbint typing:
{{{
   ~hlam/Harmonie start DTG=2012061003 DTGEND=2012061006 LL=03
}}}
      1. The resulting analysis file be found on c2a (ssh c2a) under $TEMP/hm_home/38h12_jbint/archive/2012/06/10/06 and it will be called 'MXMIN1999+0000' and on and ectmp:/smx/harmonie/38h12_jbint/YYYY/MM/DD/06. To diagnose the 3D-VAR analysis increments of the 38h12_sinob-experiment, copy the files MXMIN1999+0000 (analysis) and ICMSHHARM+0003 (fg) to $TEMP. The first guess (background) file can be found on $TEMP/hm_home/38h12_jbint/archive/2012/06/10/03 and ectmp:/smx/harmonie/38h12_jbint/YYYY/MM/DD/03.  Convert from FA-file format to GRIB with the gl-software ($TEMP/hm_home/38h12_jbint/bin/gl) by typing './gl -p MXMIN1999+0000' and './gl -p ICMSHHARM+0003'. Then plot the difference between files file with your favourite software. Plot horizontal and vertical cross-sections of temperature and other variables using your favourite software (MetgraF or cross for example). The interpolated background error statistics for the MEDITERRANEAN domain will appear on c2a in $TEMP/hm_home/38h12_jbint/lib/const/jb_data as stabfiltn_MEDITERRANEAN_65_jbconv.cv and stabfiltn_MEDITERRANEAN_65_jbconv.bal.

Note that you can change the area you want to interpolate the structure functions from by editing in the script jbconv.sh.

== Recent work & future developments ==
Recent and on-going work as well as plans for future developments:
   * Present work regarding structure functions concerns investigations of spin-up effects related with downscaling of ECMWF Ensemble Data Assimilation (EDA) forecasts with the HARMONIE system. There is also work on introduction and testing of ensemble data assimilation in the HARMONIE system itself. Longer term research is towards flow dependent background error statistics and close link between the data assimilation and the ensemble forecasting system.

== References ==

 * [https://hirlam.org/trac/raw-attachment/wiki/HarmonieSystemDocumentation/Structurefunctions_ensys/festat_guidelines.pdf Festat guide], Ryad El Katib, Meteo France, 2014

