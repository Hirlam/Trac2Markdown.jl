[[PageOutline]]

[[Center(begin)]]
== '''Harmonie System Documentation''' ==
= '''Harmonie-31h1 System setup at ECMWF platform''' =
[[Center(end)]]

== Preparation for running HARMONIE-31h1 experiment ==

The main sources of HARMONIE program (ALADIN system, including that of AROME) is compiled and maintained at /hpce/ms_perm/hirald/pack by staffs from Meteo France. The compilation utility gmkpack is used to handle different versions and to compile the code. For Hirlam users of HARMONIE system, works have to be done on both ECGATE and HPCE platforms.

=== Preparation of source codes for HARMONIE system on ecgate ===
 * Make sure you belong to the hirald group at ECMWF platform. Write to Claude Fisher at Meteo France (for ALADIN users) and Xiaohua Yang (for HIRLAM users) requesting it if you do not.
 * Due to limitation of the ECMWF HPCF currently preparation and compilation of the HARMONIE-related software need to be done using ecgate and HPCE platforms, separately. For retrieving of the HARMONIE source code/updates (from https://svn.hirlam.org) using Subversion (svn) command, it needs to be done at ecgate platform. The compilation and experiment submission are then done at HPCE platform. 
   * Log in to ecgate platform. Subversion is installed at ecgate but you have to edit the server configuration file for subversion to be able to access hirlam.org. 
{{{  
Change in $HOME/.subversion/servers
from
# http-proxy-exceptions = *.exception.com, www.internal-site.org
to
  http-proxy-exceptions = *.ecmwf.int, localhost
  http-proxy-host = www-gw.ecmwf.int
  http-proxy-port = 3333
}}}
   * If $HOME/.subversion/servers does not exist, use the copy of ''servers'' attached to this page.
   * All subversion commands has to be done on ECGATE, even if you install the code on HPCE disc.
   * Add the following to your [[Color(red, .user_profile )]] on [[Color(red, HPCE )]] to be able to run "gmkpack", which is the standard ALADIN compilation tool. If .user_profile does not exist, create one under $HOME/ [ Note that this is not only necessary to run "gmkpack" (which is done interactively), but also to make these environment variables known to jobs llsubmitted later on. ]
{{{
export GMKROOT=/hpce/ms_perm/hirald/tools/gmkpack
export ROOTPACK=/hpce/ms_perm/hirald/pack
export HOMEPACK=$HOME/HARMONIE/pack
export HOMEBIN=$TEMP/HARMONIE
export GMKFILE=IBMP690.HPCE
export GMKTMP=$TEMP/gmktmp
export PATH=$PATH:$GMKROOT/util
export MANPATH=$MANPATH:$GMKROOT/man
}}}
=== Configuration and compilation of an HARMONIE experiment on HPCE partition ===
 1. Create directory $HOMEPACK as defined above
 1. Under [[Color(red, Korn-Shell)]], create a new experiment $your_exp for ALADIN/AROME with gmkpack, e.g., for cycle 31t1 and the AROME system including ODB package,
{{{
gmkpack -r 31t1 -u $your_exp -p aromodb
}}}
   * The above will create a new directory $HOMEPACK/pack/$your_exp with a file ics_aromodb which is your makefile. A directory structure similar to the reference installation (in $ROOTPACK) will also be created, with subdirectories bin, lib, src, sys. In particular, the directory $HOMEPACK/$your_exp/src/local/ is where users shall put the modified codes
   * CY31t1 does not work directly at ECMWF platform. It needs updates as [4920] in the HARMONIE repository. The change set has to be added here manually
 1. Add HARMONIE scripts, utilities and the necessary code correction sets
   1. change platform to ecgate and go to the HPCE $HOMEPACK directory (e.g.,
{{{
cd /hpce/"PathToYourHOMEPACKatHPCE"/$your_exp
}}}
   1. retrieve the relevant HARMONIE script, utility gl
{{{
svn export https://svn.hirlam.org/tags/harmonie-31h1/scr scr
mkdir util; cd util
svn export https://svn.hirlam.org/trunk/harmonie/util/gl gl
}}}
   1. for cycle 31t1, run the script scr/Extract_changes to produce the needed code updates
{{{
ksh scr/Extract_changes
}}}
 1. Compilation 
   * Return to HPCE platform to the $HOMEPACK/$your_exp position, edit the ics_aromodb job script to include the above exports of environment variables (they are not passed on automatically) and submit batch job for compilation of main program:
{{{
cd $HOMEPACK/$your_exp
llsubmit ics_aromodb
}}}
   * The script ics_aromodb will pick up the code changes you put in $HOMEPACK/your_exp/src/local/ and create an executable AROMODB in $HOMEPACK/your_exp/bin/. Note that you may need to modify the script ics_aromodb  in order to use multi-PE, or consider to increase memory allocation especially for single PE compilation.
   * After successful compilation the binaries can be found in the same directory as the ALADIN/AROME binary
   * compile now the utility gl needed for running HARMONIE with HIRLAM/ECMWF initial/boundary data (gl) and the utilities to interpolate model and observation data for verification, fldextr and obsextr
{{{
cd $HOMEPACK/$your_exp/util/gl
gmake
}}}
   * The final software needed before an experiment can be done is mandtg, this may be copied from an HIRLAM experiment.
 1. Harmonie scripts and namelists
   * Go to your experiment directory at HPCE from ECGATE. On ECGATE, do
{{{
cd /hpce/"PathToYourHOMEPACKatHPCE"/"your_exp"/
}}}
   * Then check out the latest scripts from Harmonie trunk (for the first time) by using Subversion command  
{{{  
svn co https://svn.hirlam.org/trunk/harmonie/scr/ 
svn co https://svn.hirlam.org/trunk/harmonie/nam/ 
}}}

[[SubWiki]]

[[Center(begin)]]
[wiki:HarmonieSystemDocumentation Back to the main page of the HARMONIE System Documentation]
[[Center(end)]]
----

[[Center(begin)]]
[[Disclaimer]]

[[Color(red, Last modified on)]] [[LastModified]]
[[Center(end)]]
