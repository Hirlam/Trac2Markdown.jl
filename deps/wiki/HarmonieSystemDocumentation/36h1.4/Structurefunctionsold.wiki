[[PageOutline]]

[[Center(begin)]]
== '''Harmonie System Documentation''' ==
= ''' Derivation of Structure Functions ''' =
[[Center(end)]]

== '''General''' ==
For each new model domain, in order to carry out upper air data assimilation (3DVAR or 4DVAR) one needs to generate background error covariances (generally referred to as structure functions). The structure functions can be calculated from an ensemble of HARMONIE forecasts. A data sets from ECMWF ensemble experiments have been acquired by HIRLAM, for the period 20060920 and 20061031. With this data set, HARMONIE ensemble forecast runs can be initiated from ECMWF 6h forecasts, using ECMWF forecasts as initial and lateral boundary conditions. Such HARMONIE ensemble forecasts can be run for up to 6 hours, with results archived. To obtain stable statistics, it seems appropriate to run 4 ensembles for each day of the episode, all from 00 UTC. Then the forecasts can be processed to generate structure functions by method described below.

Note that in the HIRLAM VAR implementation it has been possible technically to run 3/4DVAR using structure functions derived from other HIRLAM runs on different domain. This is not the case in the current HARMONIE data assimilation. So the derivation of structure function is the first step to go before any VAR experiment can be done. 
== '''Example on ecgate/c1a, for area SCANDINAVIA''' ==
 * Preparation
   1. Run the 4 downscaled HARMONIE 6h ensemble forecasts in for 20060920-20061031 00 UTC. Create FC_ENS1 to FC_ENS4 directories as described below for FC_ENS1. FC_ENS2 to FC_ENS4 procedure is exactly the same, except for that you do include 'export JB_ENS_MEMBER=2' etc, instead of 'export JB_ENS_MEMBER=1' at the bottom of config_exp.h.
     1. create hm_home/FC_ENS1 directory. Then cd $HOME/hm_home/FC_ENS1. 
     1. create experiment by typing '~nhz/Harmonie setup -r ~nhz/harmonie_release/36h1.2'.
     1. edit sms/config_exp.h as follows
       * set DOMAIN=SCANDINAVIA, 
       * set FCINT=24,
       * set BDSTRATEGY=jb_ensemble
       * set OUTINT=6,  
       * set ANAATMO=none
       * set ANASURF=none
       * I have also set ECFSLOC=ec, instead of default ectmp, but that is not crucial. In case of ECFSLOC=ec the forecasts will be archived at ec:/$uid/harmonie/$EXP/$YYYY/$MM/$DD/$HH.
       * include the following line at the bottom of config_exp.h: export JB_ENS_MEMBER=1 
     1. From $HOME/hm_home/FC_ ENS1 launch experiment by typing
{{{
   ~nhz/Harmonie start DTG=2006092000 DTGEND=2006103100 LL=06
}}}
   1. Generate difference files from 6 h forecasts (for forecasts valid at the same time) in a format suitable for background error statistics program. It involves two steps
     1. Generate relevant executibles for calculate differences between forecasts stored in FA files, and pinuts/frodo
       * Do-it-your-self: Example of procedure
         1. on ecgate, copy your experiment $HOME/hm_home/FC_ENS1 to $HOME/hm_home/DF_ENS (using cp -r). 
         1. for future purposes in sms/config_exp.h add 'pinuts' to string after OTHER_PROGRAMS
         1. if you are not running with AROME using cycle 36, then
            1. create a directory '$HOME/hm_home/DF_ENS/src/arp/control'. 
            1. place a routine cnt3.F90 (it is modified to enable difference file calculation). 
            1. the correct cnt3.F90 is placed on c1a as ~smx/Jb_wiki/cnt3.F90 (copy that to $HOME/hm_home/DF_ENS/src/arp/control/cnt3.F90). Note if you are running AROME (it uses gridpoint specific humidity) you should rather copy ~smx/Jb_wiki/cnt3.F90_arome to $HOME/hm_home/DF_ENS/src/arp/control/cnt3.F90.  
            1. launch an experiment in $HOME/hm_home/DF_ENS by '~nhz/Harmonie start DTG=2006092000'. 
            1. when the build (compilation) step is finished you will on c1a find $TEMP/hm_home/DF_ENS/bin/MASTERODB. Copy that to ec:/$uid/MASTERODB_DF (ecp TEMP/hm_home/bin/AROMODB ec:/$uid/MASTERODB_DF).
            1. sometimes for some file model PHYSICS choices, the program abort due to some unknown fields. Such fields are not important for our purposes. If that happens in the next step then also copy ~smx/Jb_wiki/facile.F and put in $HOME/hm_home/DF_ENS/src/xrd/fa/facile.F. For AROME you need to copy suctrl_gflattr.F90 and place at arp/setup/suctrl_gflattr.F90 as well as rdgpfa.F90 to arp/utility/rdgpfa.F90.ori)
         1. for cycle 36 using AROME, copy necessary source code changes to $HOME/hm_home/FC_ENS1 from ~nhz/hm_home/arome36_jb which contains updated subroutines corresponding to those mentioned above
       * ALTERNATIVE: from ECFS, you may also find the following ready-made executibles prepared for CY36. These can then be used in next step when editing "makediff"
         * PINUTS/FRODO in ec:/hirlam/jbexe/frodo
         * executible needed to calculate forecast differences from AROME model: ec:/hirlam/jbexe/AROME_36
     1. Running difference file generation placed at c1a, utilizing executibles (MASTERODB_DF or AROME_36 as mentioned above) and forecast files from the previous step. 
       * Log in to c1a (rlogin c1a). 
       * Go to $TEMP, followed by 'cp -r /ms_perm/alas/Jb_wiki  $TEMP/.'. You will get a number of subdirectories under your 'Jb_wiki'
       * In scripts you find the script 'makediff'. Take a look at it and modify '/ms_perm/alas' to '$TEMP', $uid 'smx' to your own uid and find appropriate paths for your forecast files, dates of data and executible file. 
         * In case of AROME and cycle 36, see example in ~nhz/scr/makediff, in which namelist is pointed to ~nhz/scr/difarm.36h1.nml.
       * When finished with the editing, launch the experiment with 'llsubmit ./makediff'. 
         * check if you are running by typing llq -u $uid'. Out directory will be on $TEMP/ald3dvar. Note three sub-directories 'Diff2 Stat Work'. 'Work' is where the calculations take place and 'Diff2' where the output difference files appear in a format suitable for coming structure funtion calculation (names like nmcstat2006092000.0i, i=1,..4). 
 * Calculation
   1. On c1a $TEMP/Jb_wiki/scripts you find 'linkdiff' script. Take a look at it. It justs creates symbolic links between the difference files  '$TEMP/ald3dvar/Diff/nmcstatYYYYMMDDHH.1' etc and  '$TEMP/ald3dvar/Stat/nmcstat001' (002 for the next file and so forth), needed for the next step. Modify paths and dates and run by typing (placed in $TEMP/Jb_wiki/scripts) ./linkdiff (the outcome will be the links in '$TEMP/ald3dvar/Stat'.
   1. Time to compile festat program. Make sure you use /bin/ksh. Go to $TEMP/Jb_wiki/nmcstat/src. There edit compilation script 'festat'. Here you will find roughly 25 different parameters to set, related to dates and number of cases you have, as well as model geometry for your domain. Edit these parameters. To find out about your model parameters, fetch a forecast file in FA-format from your experiment. and examine it with executible frodo. See following. Afterwards, type './frodo $FILE' and you will receive a file 'INFO.$FILE' providing you with geometrical information. After editing festat compile by typing './festat' and a festat.x will appear.
     * fetch the executable '$TEMP/hm_home/DF_ENS/bin/PINUTS' from your DF_ENS experiment and name it as 'frodo' (cp $TEMP/hm_home/DF_ENS/bin/PINUTS frodo). 
     * alternatively, fetch directly from ec:/hirlam/jbexe/frodo
   1. Now  it is time for running festat by utilizing the script runfestat in $TEMP/Jb_wiki/scripts. Modify paths (/ms_perm/alas to $TEMP and smx to uid), make sure runfestat is using your newly compiled festat.x, and run by typing 'llsubmit ./runfestat'. The structure function program festat.x will run at $TEMP/ald3dvar/Stat and the structure function output will be three files starting with 'stabfiltn'. There will also be a lot of diagnostical files with names starting on 'cov' and 'cor' as well as a log file (these files are worth saving). The two files 'stabfiltn*.cv' and 'stabfiltn*.bal' will be needed by the assimilation later on. gzip them and copy to ecfs (emkdir ec:/$uid/jbdata followed by: ecp stabfiltn*.cv.gz ec:/$uid/. and stabfiltn*.bal.gz ec:/$uid)
 * Run data assimilation 
   1. On ecgate $HOME/hm_home/, copy experiment FC_ENS1 to AN_ENS (cp -r FC_ENS1 AN_ENS)
   1. go to $HOME/hm_home/AN_ENS
     * set in sms/config_exp.h, ANAATMO=3DVAR, ANASURF=yes, BDSTRATEGY=operational and remove last line in config_exp.h (export JB_ENS_MEMBER=1)
     * create directory $HOME/hm_home/AN_ENS/scr and place the file include.ass in that directory (include ass you can get from $TEMP/hm_home/lib/scr/ on c1a). In include.ass set JBDIR=ec:/$uid/jbdata (uid being your userid) and  f_JBCV='name of your .cv file in ec:/$uid/jbdata' (without .gz) (example stabfiltn_demo_20070201_10.cv,f_JBBAL=' name of your .bal file in ec:/$uid/jbdata  (without .gz) (example stabfiltn_demo_20070201_10.bal). 
     * in $HOME/hm_home/AN_ENS, launch '~nhz/Harmonie start DTG=2007020100' and you will create an experiment with data assimilation
   1. The analysis file will be called 'MXMIN1999+0000'. Results will appear on $TEMP/hm_home/AN_ENS' and ECFS. Note that with structure functions based on a too small sample you might get an error in minimization due to issues like zero humidity eigenvalue.
 * Diagnosis of structure functions and analysis increments
   * Diagnosis of structure functions is a rather complicated task. On c1a /ms_perm/alas/Jb_wiki/dia you will find makescript fediacov, it utilizes diagn.include and libgsa_var_comp_gsa_log.F. Compile it while shell /bin/ksh by typing ./fediacov (note that in diagn.include and libgsa_var_comp_gsa_log.F there are geometrical settings according to your domain that you need to specify before comiling to get it correct). Place the resulting diacov.x in $TEMP/ald3dvar/Stat and type './diacov.x' (it needs the three gunzipped stabfiltn*-files as input. Output will be a lot of cov* and cor* files and more. In  $TEMP/sfun_dem/plot example of octave plot programs for displaying data are provided as example. prep_gmt.F reads data cov*.xy and put in a perhaps more plot-freindly format. To get an idea of what the correlations and covariances should look like take a look in the article: Berre, L., 2000: Estimation of synoptic and meso scale forecast error covariances in a limited area model. Mon. Wea. Rev., 128, 644-667. It would also be fruitfuil to look at the 3D-VAR analysis increments of your AN_DEMO experiment. Copy the files MXMIN1999+0000 (analysis) and ICMSHANAL+0000 (fg, with surface analysis applied) to $TEMP. Convert from FA-file format to GRIB with the gl-software ($TEMP/hm_home/AN_DEMO/bin/gl) by typing 'gl -p MXMIN1999+0000' and gl -p ICMSHANAL+0000'. Then plot the difference file with your favorite software
 * Future developments
   * Present work regarding structure functions concerns ensemble data assimilation systems with perturbed observations also in HARMONIE.

[[SubWiki]]

[[Center(begin)]]
[wiki:HarmonieSystemDocumentation Back to the main page of the HARMONIE System Documentation]
[[Center(end)]]
----

[[Center(begin)]]
[[Disclaimer]]

[[Color(red, Last modified on)]] [[LastModified]]
[[Center(end)]]