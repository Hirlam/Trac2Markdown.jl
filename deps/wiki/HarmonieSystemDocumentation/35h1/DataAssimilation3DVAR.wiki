[[PageOutline]]

[[Center(begin)]]
== '''Harmonie System Documentation''' ==
= ''' Derivation of Structure Function''' =
[[Center(end)]]

== '''General''' ==

For each new model domain you need to generate background error covariances (generally referred to as structure functions), before being able to carry out data assimilation. The structure functions are calculated by applying the so called NMC-method from differences of forecast valid at the same time (or alternatively, not described here, by the ensemble method). As a first step you need to run the forecast model up to 36 hours and archive at least the +12 and +36 hour forecasts. To obtain stable statistics the model should be run for at least two months, twice a day. Then the forecast will be processed to generate structure functions by method described below. For the demonstration below only 25 days of forecasts are run, twice a day.

Note that in the HIRLAM VAR implementation it has been possible technically to run 3/4DVAR using structure functions derived from other HIRLAM model runs on different domain. This is not the case in the current HARMONIE data assimilation. So the derivation of structure function is the first step to go before any 3D-VAR experiment can be done.

== '''Demonstration on ecgate/hpce, for area SCANDINAVIA''' ==

 * Preparation
  1. Run 10 days of forecasts 00, 12 UTC each day, up to 36 hours, see example starting from 2007020100 on ecgate:$HOME: ~smx/hm_home/FC_DEMO
    1. create hm_home/FC_DEMO directory. Then cd $HOME/hm_home/FC_DEMO. 
    1. create experiment by typing '~nhz/Harmonie setup -r ~nhz/harmonie_release/33h1'.
    1. edit sms/config_exp.h as follows
      * set DOMAIN=SCANDINAVIA, 
      * set FCINT=12, 
      * ARCHINT=06, 
      * set ANAATMO=no
      * set ANASURF=no. 
      * I have also set ECFSLOC=ec, instead of default ectmp, but that is not crucial. In case of ECFSLOC=ec teh forecasts will be archived at ec:/$uid/harmonie/$EXP/$YYYY/$MM/$DD/$HH. 
    1. From $HOME/hm_home/FC_DEMO launch experiment by typing: '~nhz/Harmonie start DTG=2007020100 DTGEND=2007022512 LL=36 (will give you 10 days of forecasts, 00 and 12 UTC).
  1. Generate 12-36 h difference files (for forecasts valid at the same time) in a format suitable for background error statistics program. It involves three steps
    1. On ecgate starting a complilation for generating an executable AROMODB_DF on hpce, needed for difference file calculation. 
    1. Running difference file generation placed at hpce, utilizing AROMODB_DF and forecast files from the previous step. 
      * on ecgate, copy your experiment $HOME/hm_home/FC_DEMO to $HOME/hm_home/DF_DEMO (using cp -r). 
      * create a directory '$HOME/hm_home/DF_DEMO/src/arp/control'. 
      * place a routine cnt3.F90 (it is modified to enable difference file calculation). 
      * The correct cnt3.F90 is placed on hpce as /ms_perm/alas/sfun_dem/src_diff/cnt3.F90 (copy that to $HOME/hm_home/DF_DEMO/src/arp/control/cnt3.F90). 
      * launch an experiment in $HOME/hm_home/DF_DEMO by '~nhz/Harmonie start DTG=2007020100'. 
      * When the build (compilation) step is finished you will on hpce find $TEMP/hm_home/DF_DEMO/bin/AROMODB. Copy that to ec:/$uid/AROMODB_DF (ecp TEMP/hm_home/bin/AROMODB ec:/$uid/AROMODB_DF).
        * Note to log in to hpce you type 'rlogin hpce')(b) log into hpce. 
      * Go to $TEMP, followed by 'cp -r /ms_perm/alas/sfun_dem  $TEMP/.'. You will get a number of subdirectories under your 'hm_home'
      * In scr you find the script 'makediff'. Take a look at it and modify '/ms_perm/alas' to '$TEMP', $uid 'smx' to your own uid and find appropriate paths for your forecast files, dates of data and AROMODB_DF file. 
      * When finished with the editing launch the experiment with 'llsubmit ./makediff'. 
        * check if you are running by typing llq -u $uid'). Outdirectory will be on $TEMP/sfun_out. Note three sub-directories 'Diff Stat Work'. 'Work' is where the calculations take place and 'Diff' where the output difference files appear in a format suitable for coming structure funtion calculation (names like nmcstat20007020100). 

 * Calculation
  1. On hpce $TEMP/sfun_dem/scr you find 'makelink' script. Take a look at it. It justs creates symbolic links between the difference files  '$TEMP/sfun_out/Diff/nmcstatYYYYMMDDHH' and  '$TEMP/sfun_out/Stat/nmcstat001' (002 for the next file and so forth), needed for the next step. Modify paths and dates and run by typing (placed in $TEMP/sfun_dem/scr) ./makelink (the outcome will be the links in '$TEMP/sfun_out/Stat'.
  1. Time to compile festat program. Make sure you use /bin/ksh. Go to $TEMP/sfun_dem/src. There edit compilation script 'festat'. Here you will find roughly 25 different parameters to set, related to dates and number of cases you have, as well as model geometry for your domain. Edit these parameters. To find out about your model parameters: fetch a forecast file in FA-format from your experiment (for example, in the scandinavian domain case: 'ecp ec:/smx/harmonie/FC_DEMO/2007/02/01/00/ICMSHALAD+0036'). Then fetch the executable '$TEMP/hm_home/FC_DEMO/bin/PINUTS' from your FC_DEMO experiment and name it as 'frodo' (cp $TEMP/hm_home/bin/PINUTS frodo). Finally type './frodo ICMSHALAD+0036' and you will receive a file 'INFO.ICMSHALAD+0036' providing you with geometrical information. After editing festat compile by typing '/festat' and a festat.x will appear. Place it in $TEMP/sfun_dem/bin.
  1. Now  it is time for running festat by utilizing the script runfestat in $TEMP/sfun_dem/scr. Modify paths (/ms_perm/alas to $TEMP and smx to uid) and run by typing 'llsubmit ./runfestat'. The structure function program festat.x will run at $TEMP/sfun_out/Stat and the structure function output will be three files starting with 'stabfiltn'. There will also be a lot of diagnostical files with names starting on 'cov' and 'cor' as well as a log file (these files are worth saving). The two files 'stabfiltn*.cv' and 'stabfiltn*.bal' will be needed by the assimilation later on. gzip them and copy to ecfs (emkdir ec:/$uid/jbdata followed by: ecp stabfiltn*.cv.gz ec:/$uid/. and stabfiltn*.bal.gz ec:/$uid').

 * Run data assimilation 
Placed on ecgate $HOME/hm_home/ copy experiment FC_DEMO to AN_DEMO (cp -r FC_DEMO AN_DEMO). go to $HOME/hm_home/AN_DEMO/sms and set 
ANAATMO=3DVAR and set ANASURF=yes. After that create directory $HOME/hm_home/AN_DEMO/scr and place the file include.ass in that directory (include ass you can get from $TEMP/hm_home/lib/scr/ on hpce). In include.ass set JBDIR=ec:/$uid/jbdata (uid being your userid) and  f_JBCV='name of your .cv file in ec:/$uid/jbdata' (without .gz) (example stabfiltn_demo_20070201_10.cv,f_JBBAL=' name of your .bal file in ec:/$uid/jbdata  (without .gz) (example stabfiltn_demo_20070201_10.bal). Finally to  $HOME/hm_home/AN_DEMO and type '~nhz/Harmonie start DTG=2007020100' and you will create an experiment with data assimilation. The analysis file will be called 'MXMIN1999+0000'. Results will appear on $TEMP/hm_home/AN_DEMO' and ecfs. Note that with structure functions based on a too small sample you might get an error in minimization due to issues like zero humidity eigenvalue.

 * Diagnosis of structure functions and analysis increments
Diagnosis of structure functions is a rather complicated task. On hpce $TEMP/sfun_dem/dia you will 
find makescript fediacov, it utilizes diagn.include and libgsa_var_comp_gsa_log.F. Compile it while in
shell /bin/ksh by typing ./fediacov (note that in diagn.include and libgsa_var_comp_gsa_log.F there
are geometrical settings according to your domain that you need to specify before comiling to get it correct). Place the resulting diacov.x in $TEMP/sfun_out/Stat and type './diacov.x' (it needs the three gunzipped stabfiltn*-files as input. Output will be a lot of cov* and cor* files and more. In  $TEMP/sfun_dem/plot example of octave plot programs for displaying data are provided as example. prep_gmt.F reads data cov*.xy and put in a perhaps more plot-freindly format. To get an idea of what the correlations and covariances should look like take a look in the article: Berre, L., 2000: Estimation of synoptic and meso scale forecast error covariances in a limited area model. Mon. Wea. Rev., 128, 644-667. It would also be fruitfuil to look at the 3D-VAR analysis increments of your AN_DEMO experiment. Copy the files MXMIN1999+0000 (analysis) and ICMSHANAL+0000 (fg, with surface analysis applied) to $TEMP. Convert from FA-file format to GRIB with the gl-software ($TEMP/hm_home/AN_DEMO/bin/gl)
by typing 'gl -c MXMIN1999+0000' and gl -c ICMSHANAL+0000'. Then plot the difference file with your favorite software.



[[SubWiki]]

[[Center(begin)]]
[wiki:HarmonieSystemDocumentation Back to the main page of the HARMONIE System Documentation]
[[Center(end)]]
----

[[Center(begin)]]
[[Disclaimer]]

[[Color(red, Last modified on)]] [[LastModified]]
[[Center(end)]]
 
