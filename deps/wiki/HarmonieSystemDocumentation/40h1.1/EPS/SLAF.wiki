'''
== SLAF in HarmonEPS ==
'''

'''SLAF''' stands for Scaled Lagged Average Forecasting (Ebisuzaki & Kalnay, 1991) and it [[BR]]
is a technique used to easily generate perturbed boundary and initial conditions from a single deterministic model (HRES).

The general idea of SLAF is that perturbations are taking HRES 
forecasts valid at the same time but with different forecast lengths and initial times :

 '''IC_m = A_c + K_m * ( IFS_0 – IFS_N )''' 

 '''BC_m = IFS_0 + K_m * ( IFS_0 – IFS_N )'''
Where IC_m is the initial perturbation for member m, BC_m is the lateral boundary perturbation for member m, A_c is the control analysis, K_m a scaling factor, IFS_0 is the 
latest available IFS forecast and N [[BR]] is the forecast length for an earlier forecast valid at the same 
time.

This first attempt on using SLAF revealed an undesirable clustering between the different members using positive or negative [[BR]]
perturbations. Depending on the sign of K_m the members gather on either side of [[BR]]
the mean. If HRES has a increasing bias over the forecast length the same bias will be [[BR]]
introduced through the perturbations. A cure of this problem is to use shorter forecast lengths and [[BR]]
construct the perturbations by two consecutive forecasts 6 hours apart:

 '''IC_m = A_c + K_m * ( IFS_N – IFS_N-6 )'''

 '''BC_m = IFS_0 + K_m * ( IFS_N – IFS_N-6 )'''

where IFS_N is a forecast with length N and IFS_N-6 is a 6h shorter forecast, both valid at the same [[BR]]
time as the analysis. With this construction most of the clustering is gone. [[BR]]
'''THIS IS THE DEFAULT SETUP IN HarmonEPS cy40.'''

From the equation it is clear that every lag used generates two perturbations, so if we use deterministic runs from 06, [[BR]]
12, 18, 24 and 30 hours before we'll have 10 different perturbed members and control, then 11 members in total. 


The goal is to have similar spread at the boundaries of the LAMEPS than using pure downscaling but with less communication time.

Sotfware to use SLAF technique in HarmonEPS was introduced in HarmonEPS branch in version 38h1.1 and first tested by Jose A. Garcia-Moya.

The main advantage of SLAF is that only needs having stored the last runs of the deterministic model and, in daily [[BR]]
run mode at home, we only need to have access to the last ECMWF (or any other global model) run avoiding a lot of time in [[BR]]
communications compared with the pure downscaling technique.

Summarizing, to run an HarmonEPS experiment using SLAF (default in cy40) you have to:

1) Refer to HarmonEPS branch 38h1.1 (minimum). (Constant 6h lag as described above from cy40)

2) In sms/config_exp.h choose:

 2a) BDSTRATEGY=simulate_operational

 2b) ENSMSEL=0-10 (or whatever you want)

 2c) SLAFLAG=1

 2d) SLAFK=1

3) In msms/harmonie.pm:

 3a)  'ENSBDMBR' => [ 0 ],

 3b)  'SLAFLAG'  => [    0,    6,     6,    12,    12,  18,     18,   24,    24,    30,    30],

 3c)  'SLAFDIFF' => [    0,    6,     6,     6,     6,    6,     6,    6,     6,     6,     6],

 3d)  'SLAFK'    => ['0.0','1.75','-1.75','1.5','-1.5','1.2','-1.2','1.0','-1.0','0.9','-0.9'] (example used for constant 6h lag)


 Where SLAFLAG represent the lags of every member of the ensemble and SLAFK are the different scales (including [[BR]]
 the sign). Theoretically the user may set SLAFK as she/he likes but it seems to be more convenient choosing ± in order [[BR]]
 to keep symmetry of the perturbations around control. '''Note that SLAFK may need to be tuned.''' See here for how to diagnose the perturbations: (TODO)

Note that no further control on the equilibrium among the perturbed variables (temperature, humidity and so on) is done, so [[BR]]
perhaps you have to check the spin-up if you are interested in the first hour of the ensemble.

Below is an example for 2016052006 for the two different approaches of SLAF described above:

 [[Image(SLAF_table_default.png,60%)]]

 [[Image(SLAF_table_orig.png,60%)]]


