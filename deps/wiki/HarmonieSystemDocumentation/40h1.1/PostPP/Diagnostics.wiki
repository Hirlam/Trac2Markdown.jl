[[PageOutline]]
[[Center(begin)]]
= '''Diagnostics''' =
[[Center(end)]]

== Xtool ==

[wiki:HarmonieSystemDocumentation/40h1.1/PostPP/gl#xtool xtool]



== SAL ==

[wiki:HarmonieSystemDocumentation/40h1.1/PostPP/gl#SAL SAL]


== DDH ==

Diagnostics par Domaines Horizontaux (Diagnostics by Horizontal Domains) is a tool to create budgets of different processes in the model. Please read on in the gmap documentation: http://www.cnrm.meteo.fr/gmapdoc/spip.php?page=recherche&recherche=DDH

== EZDIAG ==

From Lisa: Note, this is for printing out full 3D fields from the model physics to the FA-file. 

 1. In the routine that you would like to print out your fields add args:

{{{
     & PDIAG, KNDIAG,&
}}}

  and declare them

{{{
INTEGER(KIND=JPIM),INTENT(IN) :: KNDIAG
REAL(KIND=JPRB)   ,INTENT(OUT)   :: PDIAG(KLON,KLEV,KNDIAG)
}}}

  Put values in the array if its dimension allows it, e.g.

{{{
IF (KNDIAG.GE.1) THEN
    PDIAG(KIDIA:KFDIA,KTDIA:KLEV,1)= YOURVAL(KIDIA:KFDIA,KTDIA:KLEV)
ENDIF
}}}

  or anything you wish. Note that the variable YOURVAL is now stored in NGFL_EZDIAG=1.

  You can store this way up to 25 diagnostic 3D fields in the historic files.

  If you want to store 2D fields, you can put them at different levels in the same 3D array.

 2. Remake the interfaces if running AROME (not needed if running ALARO), before recompiling.

 ''Comment by Laura 28.9.2019, valid at least in CY43:''

 If you bring your variable to apl_arome level, it is sufficient to assign it to the PEZDIAG variable, something like this:
 
{{{
    !vertically integrated aerosol optical depth at 550 nm:
    PEZDIAG(KIDIA:KFDIA,1,4)=ZAETOT(KIDIA:KFDIA)
    IF (LRAY.OR.LRAYHL) THEN
    !broadband SW and LW vertically integrated aerosol optical depths:
       PEZDIAG(KIDIA:KFDIA,2,4)=ZVIATAUS(1,KIDIA:KFDIA)    
       PEZDIAG(KIDIA:KFDIA,3,4)=ZVIATAUL(1,KIDIA:KFDIA)    
    ENDIF
    ! of aerosol preparation for radiation
}}}

 In this example, 3 2D fields ZAETOT, ZVIATAUS, ZVIATAUL were added to levels 1-3 of PEZDIAG(:,:,4), which is already in the 
 apl_arome.F90 interface, called from mf_phys. In the namelist (next in Lisa's list), you can give whatever name to the resulting 
 3D array, e.g. YEZDIAG_NL(4)%CNAME='PDIAGAE', 

 ''end of Laura's comment''

 3. In the NAMGFL namelist:

{{{
! ADDITIONAL FIELDS FOR DIAGNOSTIC
   NGFL_EZDIAG=1,          ! <=25
   YEZDIAG_NL(1)%CNAME='YOURVAL',
   YEZDIAG_NL(1)%LADV=.F.,
}}}

  If you add more fields (e.g. you set NGFL_EZDIAG=4), I think you will also need to set the grib parameter, e.g.
  (the default is 999, that you can leave for the first one).

{{{
   YEZDIAG_NL(2)%IGRBCODE=998,
   YEZDIAG_NL(3)%IGRBCODE=997,
   YEZDIAG_NL(4)%IGRBCODE=996,
}}}

  Note that the two first places are already defined in harmonie_namelist.pm.

 4. In order to have your variable converted from FA to grib, add the new variable in util/gl/inc/trans_tab.h

 5. If running ALARO, you need to add following lines to mf_phys.F90 (after the call of aplpar subroutine):

{{{
IF (NGFL_EZDIAG>0) THEN
  DO JLEV=1,NFLEVG
    DO JROF=KST,KEND
      PGFL(JROF,JLEV,YEZDIAG%MP)=ZEZDIAG(JROF,JLEV,1:NGFL_EZDIAG)
    ENDDO
  ENDDO
ENDIF
}}}
