[[PageOutline]]

[[Center(begin)]]

== ''Harmonie System Documentation'' ==
= Post processing with gl =
[[Center(end)]]

== GL == 

 gl ( as in griblist ) is a multi purpose tool for file manipulation and conversion. It uses grib and bufr libraries and can be compiled with and without support for HARMONIE FA/LFI or NETCDF files. The gl package also includes software for extraction for verification, fldextr, and field comparison, xtool.

{{{
 
 USAGE: gl file [-n namelist_file] [-o output_file] -[lfgmicpasdetq]
 
 gl [-f] file, list the content of a file, -f for FA/lfi files  
 -c    : Convert a FA/lfi file to grib ( -f implicit )          
 -p    : Convert a FA file to grib output without extension zone
         (-c and -f implicit )                                  
 -musc : Convert a SCUM FA file ASCII ( -c implicit )           
 -a    : Convert a HIRLAM file to ALADIN input                  
         climate_aladin assumed available                       
 -d    : Together with -a it gives a (bogus) NH boundary file   
 -e    : Convert a ECMWF file to ALADIN input                   
         climate_aladin assumed available                       
 -s    : Work as silent as possible                             
 -g    : Prints ksec/cadre/lfi info                             
 -m    : Prints min,mean,max of the fields                      
 -i    : Prints the namelist options (useless)
 -tp   : Prints the GRIB parameter usage                         
 -t    : Prints the FA/lfi/GRIB table (useful)                  
 -q    : Cross check the FA/lfi/GRIB table (try)                
 -pl X : Give polster_projlat in degrees                         
 
 gl file -n namelist_file : interpolates file according to      
                            namelist_file                       
 gl -n namelist_file : creates an empty domain according to     
                       specifications in namelist_file          
 -igd  : Set lignore_duplicates=F                               
 
}}}

 === GRIB/FA/LFI manipulation ===

Listing of GRIB/ASIMOF/FA/LFI files.

 gl [-l] [-f] [-m] [-g] FILE

 * gl GRIB1/ASIMOF-FILE
 * gl -[l|f] FA/LFI-FILE. -l and -f have equal meaning.
 * gl -g gives you the GRIB/FA/LFI header
 * gl -m prints min/mean/max values

Conversion of FA/lfi files to grib by gl

  gl [-c] [-p] FILE [ -o OUTPUT_FILE ] [ -n NAMELIST_FILE ]

 * gl -c FA/LFI-FILE, converts the full field (including extension zone)
 * gl -p FAFILE, excludes the extension zone ( p as in physical domain ) 

Conversion can be tuned, to a subset of fields 

 {{{
  &naminterp
    readkey%ppp =011,033,034,011,061,228
    readkey%lll =-01,-01,-01,002,  0, 10
    readkey%ttt =109,109,109,105,105,105
    readkey%tri =  0,  0,  0,  0,  4,  2,
  /
 }}}

 Where ppp, lll, ttt and tri means parameter, level, level type and time range indicator. The first three ones are well known to most users. The time range indicator is used in HARMONIE to distinguish between instantaneous and accumulated fields. Read more about the options [wiki:HarmonieSystemDocumentation/37h1.2/Forecast/Outputlist/37h1#TimeunitsWMOcodetable4 here] Note that for level type 109 setting lll=-1 means all. We can also pick variables by their FA/lfi name:

 {{{
  &naminterp
    readkey%name = 'SPECSURFGEOP','SNNNTEMPERATURE',
  /
 }}}

Where {{{SNNNTEMPERATURE}}} means that we picks all levels.

Fields can be excluded from the conversion by name

 {{{
  &naminterp
    exclkey%name = 'SNNNTEMPERATURE'
  /
 }}}


The FA/LFI to grib mapping is done in a table defined by a [source:tags/harmonie-37h1.2/util/gl/inc/trans_tab.h translation table]

  '''AD HOC coding of the translation'''

 * gl -t or -tp to view the table
 * gl -q to cross check duplicates

Translation can be changed through the namelist by

 {{{
  &naminterp
    user_trans%full_name ='CLSTEMPERATURE',
    user_trans%tab       = 253,
    user_trans%par       = 123,
    user_trans%typ       = 105,
    user_trans%lev       = 002,
  /
 }}}


 === gl postprocessing ===

 * To pressure levels or MSLP
 {{{
  &naminterp
    pppkey%ppp   =001,011
    pppkey%lll   =000,50000
    pppkey%ttt   =103,100,
    lwrite_pponly=T,
  /
 }}}
 
 If you don't set lwrite_pponly all fields will be written to the file, not only the postprocessed fields.

 * To height interpolation (LEVEL in cm, type=125)
 {{{
  &NAMINTERP
    PPPKEY%ppp=011
    PPPKEY%lll=20000
    PPPKEY%ttt=125
    LWRITE_PPONLY=T
    VINT_Z_ORDER=1
    OUTPUT_FORMAT='ASCII',
  /
 }}}

 * Several other choices are defined in [source:tags/harmonie-37h1.2/util/gl/grb/postprocess.F90@ postprocess.F90] 
   * Pseudo satellite pictures
   * Total precipitation and snow
   * Wind (gust) speed and direction
   * Cloud base, cloud top, cloud mask and significant cloud top

 For a comprehensive list please check the [wiki:HarmonieSystemDocumentation/37h1.2/Forecast/Outputlist/37h1#Variablespostprocessedbygl output information] for each cycle

 * Interpolation/resampling between different geometries such as regular lat lon, Lambert conformal, Polar steregraphic, rotated lat lon and rotated Mercator.

The interpolation methods available are nearest grid-point (order=0) and bi-linear (order=1).
   * To rotated lat lon
 {{{
 &NAMINTERP
   OUTGEO%NLON       =  50 ,
   OUTGEO%NLAT       =  50,
   OUTGEO%NLEV       =  -1,
   OUTGEO%PROJECTION =  10,
   OUTGEO%WEST       = -10.0
   OUTGEO%SOUTH      = -10.0
   OUTGEO%DLON       =   0.1
   OUTGEO%DLAT       =   0.1
   OUTGEO%POLON      = -30.
   OUTGEO%POLAT      = -30.
   ORDER             = 1,
 /
 }}}
   Where DLON/DLAT are in degrees.
   * To lambert projection
 {{{
 &NAMINTERP
   OUTGEO%NLON       =  50 ,
   OUTGEO%NLAT       =  50,
   OUTGEO%NLEV       =  -1,
   OUTGEO%PROJECTION =  03,
   OUTGEO%WEST       =  15.0
   OUTGEO%SOUTH      =  50.0
   OUTGEO%DLON       = 10000.
   OUTGEO%DLAT       = 10000.
   OUTGEO%PROJLAT    =  60.
   OUTGEO%PROJLAT2   =  60.
   OUTGEO%PROJLON    =  15.
 /
 }}}
   Where DLON/DLAT are in meters.
   * To polar stereographic projection
 {{{
 &NAMINTERP
   OUTGEO%NLON       =  50 ,
   OUTGEO%NLAT       =  50,
   OUTGEO%NLEV       =  -1,
   OUTGEO%PROJECTION =  05,
   OUTGEO%WEST       =  15.0
   OUTGEO%SOUTH      =  50.0
   OUTGEO%DLON       = 10000.
   OUTGEO%DLAT       = 10000.
   OUTGEO%PROJLAT    =  60.
   OUTGEO%PROJLON    =  15.
 /
 }}}
   Where DLON/DLAT are in meters.
   Note that the GRIB1 standard assumes that the projection plane is at 60 degrees north whereas HARMONIE assumes it is at 90 degrees north.
   * To rotated Mercator
 {{{
 &NAMINTERP
   OUTGEO%NLON       =  50 ,
   OUTGEO%NLAT       =  50,
   OUTGEO%NLEV       =  -1,
   OUTGEO%PROJECTION =  11,
   OUTGEO%WEST       =  15.0
   OUTGEO%SOUTH      =  50.0
   OUTGEO%DLON       = 10000.
   OUTGEO%DLAT       = 10000.
   OUTGEO%PROJLAT    =  60.
   OUTGEO%PROJLON    =  15.
 /
 }}}
   Where DLON/DLAT are in meters
   Note that roated Mercator is not supported in GRIB1.
   * Geographical points is a special case of projection 0
 {{{
 &NAMINTERP
   OUTGEO%NLON       =   3 ,
   OUTGEO%NLAT       =   1,
   OUTGEO%NLEV       =  -1,
   OUTGEO%PROJECTION =   0,
   OUTGEO%ARAKAWA    =  'A',
   ORDER             =   0
   READKEY(1:18)%ppp  = 011,011,011,011,011,011,002,122,121,005,061,062,079,201,003,004,005,001,
   READKEY(1:18)%lll  = 002,760,770,775,780,785,775,775,775,775,000,755,755,755,750,750,750,750,
   READKEY(1:18)%ttt  = 105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,
   READKEY(1:18)%nnn  = 000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,000,
   LINTERP_FIELD     = F,
   GPLAT          = 57.375,57.35,57.60
   GPLON          = 13.55,13.55,14.63
 /
 }}}

 The result will be written to a ASCII file with the name gpYYYYMMDDHHLLL.

* To convert a history FA file from MUSC to an ascii file simply run
 {{{
    gl -musc FAFILE
 }}}

 === fldextr and obsextr ===

 Read about the verification extraction programs [wiki:HarmonieSystemDocumentation/37h1.2/PostPP/Extract4verification here]

== xtool ==

'''Xtool''' is part of '''gl'''-package provides utility to calculate differences between GRIB/FA files and give output to a new GRIB file. See xtool part of [source:tags/harmonie-37h1.2/util/gl/README#L221 gl-README]. The main commands are:

{{{
 
                          xtool                                 
 
 Simple usage:                                                  
  xtool -f1 FILE1 [ -fN FILEN ] -op OPERATOR [ -o OFILE ]       
  i.e. apply OPERATOR on FILEN and output to OFILE              
  operator is one of SUM/DIFF/AVE/STDV/RMS/MS                      
  1 file : SUM/AVE/SQR                                          
  2 files: SUM/AVE/PROD/DIFF/RMSE/STDV/SAL                      
  3 files: DIFF/SAL                                             
 
 Accumulated usage:                                             
  xtool -sdtg1 YYYYMMDDHH -edtg1 YYYYMMDDHH -ll1 LLL -ll2 LLL \ 
        -p1 PATH1 -p2 PATH2 -fcint HH -op OPERATOR              
  i.e. accumulate OPERATOR on FILE1 and FILE2 during the period 
  sdtg1 to edtg1 with step of fcint.                            
  sdtg2/edtg2=sdtg1/edtg2 - (LL1-LL2) unless given              
 
 Time information in the path should be given as                
  -p1 /data/test/fc@YYYY@@MM@@DD@@HH@+@LLL@ or something like   
  -p2 /data/@YYYY@/@MM@/@DD@/@HH@/fc@YYYY@@MM@@DD@_@HH@+@LLL@   
 
 Different parameters can be compared by using the xkey         
 variable in the namelist                                       
 
 Flag summary :                                                 
  -h                : Print this help                           
  -fN FILE          : Single file name                          
  -pN PATH          : Path name                                 
  -sdtgN YYYYMMDDHH : Start date/time                           
  -edtgN YYYYMMDDHH : End date/time                             
  -llN LLL          : Forecast length to use                    
  -fcint HH         : Forecast cycle interval in hours          
  -iN               : format of the input file GRIB/FA          
  -s                : Run silent                                
  -of               : Output format GRIB/FA/SCREEN              
  -g                : Prints ksec/cadre/lfi info                
  -p                : Use FA file without extension zone        
  -f                : Global FA switch                          
  -a FILE           : Accumulation file to be read              
  -n namelist       : Use namelist to set additional options    
  -igd              : Set lignore_duplicates=F                  
  -r VALUE          : Rescale the output with a constant VALUE  
 
}}}

One of the things xtool is useful for is to check if the result from two different experiments differ. This is done by applying the DIFF operator and writing the output to the screen like

{{{
 xtool [-f] -f1 FILE1 -f2 FILE2 -of SCREEN
}}}

The is heavily used in the [wiki:HarmonieSystemDocumentation/37h1.2/Evaluation/HarmonieTestbed Harmonie testbed] to check the difference between versions of the system.

Below is a simple example of how to use '''xtool'''. You may also check the [source:tags/harmonie-37h1.2/scr/Fldver field extraction] to find examples. 

 What is the difference between +24h and +48h MSLP forecasts during August 2008?

 1. Namelist for '''xtool''', which lists the parameters (here mean sea level pressure) to be examined:

{{{
&NAMINTERP
  PPPKEY%ppp = 001,
  PPPKEY%lll = 000,
  PPPKEY%ttt = 103,
/
}}} 

 2. Run xtool.

{{{
xtool -sdtg1 2008080100 -edtg1 2008083000 -ll1 48 \
      -sdtg2 2008073100 -edtg2 2008082900 -ll2 24 \
      -p1 /your_model_data/YYYY/MM/HH/fcYYYYMMDD_HH+LLL \
      -p2 /your_model_data/YYYY/MM/HH/fcYYYYMMDD_HH+LLL \
      -fcint 6 -op DIFF -n your_namelist \
      -o output.grb
}}}

  * '''-sdtg1''', '''-edtg1''', '''-ll1''': The cycles to look for the +48h forecast.
  * '''-sdtg2''', '''-edtg2''', '''-ll2''': The cycles to look for the +24h forecast.
  * '''-p1''', '''-p2''': Naming rules for the files in cycle 1 and 2, respectively.
  * '''-fcint''': Interval between forecast cycles.
  * '''-op''': Operation to be applied. Possible choices ''DIFF'', ''SUM'', ''AVE'', ''STDV'' or ''SAL''
  * '''-n''': Namelist file.
  * '''-o''': Name of the output grib file.

 3. Output file ('''output.grb''') now contains one 2D-field with accumulated 48-24h difference of mean sea level pressure.  


== SAL ==

'''S'''tructure '''A'''mplitude '''L'''ocation ('''SAL''') is object based quality measure for the verification of QPFs ([http://ams.allenpress.com/perlserv/?request=get-abstract&doi=10.1175%2F2008MWR2415.1 Wernli et al., 2008]). '''SAL''' contains three independent components that focus on Structure, Amplitude and Location of the precipitation field in a specified domain. 

 * '''S''': Measure of structure of the precipitation area (-2 - +2). Large '''S''', if model predicts too large precipitation areas.
 * '''A''': Measure of strength of the precipitation (-2 - +2). Large '''A''', if model predicts too intense precipitation.
 * '''L''': Measure of location of the precipitation object (0 - +2). Large '''L''', if modelled precipitation objects are far from the observed conterparts. 

 * '''SAL''' can be activated in '''xtool''' by using ''-op SAL'' option. e.g.

{{{
 xtool -f1 model.grib -f2 observation.grib -op SAL -n namelist
}}}

 * Output of the '''SAL''' are 2 simple ascii-files:
  1. ''scatter_plot.dat'' containing date, '''S''','''A''' and '''L''' parameters.
  2. ''sal_output.dat'' containing more detailed statistics collected during the verification (location of center of mass, number of objects, measure of object size etc.).


== create_forcing ==
'''create_forcing''' is based on the gl tool, but is a tool to read a list of input files like grib files without extension zone and convert this to a data set of forcing to be used for offline '''SURFEX'''
