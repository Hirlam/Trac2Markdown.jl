[[PageOutline]]
[[Center(begin)]]
= '''Harmonie Working Days on DA Algorithms''' =
''De Bilt, the Netherlands ,  9-13th January 2017''

Last modified [[LastModified]]
[[Center(end)]]


The HARMONIE Working Week on Data assimilation Algorithms 2017 will be held at KNMI.

== Attendees ==
||=Name                  =||= Institute     =||=    Arr.-Dep.    =|| Hotel   ||
||Roger Randriamampianina || MET Norway      ||  Sun - Friday     || Van der Valk, De Bilt  ||
||Roel Stappers           || MET Norway      ||  Sun - Friday     || Van der Valk, De Bilt  ||    
||Ole Vignes              || MET Norway      ||  Sun - Friday     || Van der Valk, De Bilt  ||
||Jelena Bojarova         ||SMHI             ||  Sun - Friday     || Van der Valk, de Bilt  ||
||Magnus Lindskog         ||SMHI             ||  Sun - Friday     || Van der Valk, de Bilt  ||
||Nils Gustafsson         ||SMHI             ||  Sun - Friday     || Van der Valk, de Bilt  ||
||Xiaohua Yang            ||DMI              ||  Sun - Friday     || Van der Valk, de Bilt  ||    
||Jan Barkmeijer          ||KNMI             ||                   ||         ||
||Wim Verkley             ||KNMI             ||                   ||         ||
||Sigurdur Thorsteinsson  ||IMO              ||                   ||         || 
||Siebren de Haan         ||KNMI             ||                   ||         ||
||Carlos Geijo            ||AEMET            ||   Sun-Friday      || THEATER FIGI           ||

== Aim of the Working Days ==
During this working week, apart of discussing the latest achievement and new issues related to data assimilation algorithms, expert groups will focus on very specific tasks. The tasks are defined in the HIRLAM rolling work plan and also were raised up and specified during previous video and working week meetings, as follows.  

The meeting started with short progress report from the participants. 

 -- Siebren: Development of observation operator for GNSS slant delay(see [https://hirlam.org/trac/attachment/wiki/HarmonieWorkingWeek/ALGO201701/DA-WW-2017-NWP-1.pdf the presentation here];[[BR]]
    Personal impression: I (Roger) really appreciated, apart of his excellent development work, the comparison of the forecast performance against observations. Here, we mean all observation having good working operator can be used. This is done through running screening with the different forecasts and extract the "fg_depar" (obs - model) for verification.[[BR]]
 -- Magnus: Computation of the background error statistics with parallel festat ( see [https://hirlam.org/trac/attachment/wiki/HarmonieWorkingWeek/ALGO201701/magnus_jb_knmi.pdf the presentation here ] and document from Ryad about parallelization Festat tool [https://hirlam.org/trac/attachment/wiki/HarmonieWorkingWeek/ALGO201701/festat_guidelines.pdf  here ] );[[BR]]
 -- Xiaohua: Data assimilation with overlapping observation window (see [https://hirlam.org/trac/attachment/wiki/HarmonieWorkingWeek/ALGO201701/Data%20assimilation%20with%20overlapping%20window(1).pdf the presentation here] );[[BR]]
 -- Ole: New look at nudging : Back and Forth nudging technique (see  [https://hirlam.org/trac/attachment/wiki/HarmonieWorkingWeek/ALGO201701/bfn_ww.pdf  the presentation here] );[[BR]]
 -- Jan shared his idea about the use of a forcing term in the variational system that can be used for triggering convection and as weak constraint (**task 15 below**);[[BR]]
 -- Carlos: Variational constraint in data assimilation. (see [https://hirlam.org/trac/attachment/wiki/HarmonieWorkingWeek/ALGO201701/BalancesWW.pptx the presentation here] );[[BR]]
 -- Sigurdur: Implementation of ATOVS at IMO (see [https://hirlam.org/trac/attachment/wiki/HarmonieWorkingWeek/ALGO201701/3DVarobs.3.pdf the presentation here] );[[BR]]
 -- Nils and Jan introduced to the WW participants what they succeed to check so far with respect to the convergence problem in 4D-VAR.[[BR]]
 -- Roel: Matrix free linear algebra in OOPS (see the presentation [https://hirlam.org/trac/attachment/wiki/HarmonieWorkingWeek/ALGO201701/mfla.2.pdf here] );[[BR]]
    He also briefly introduced the development work and plans at ECMWF. Some info [https://hirlam.org/trac/attachment/wiki/HarmonieWorkingWeek/ALGO201701/1YearPlan_OOPS_Dec2016_RD.docx here] [https://hirlam.org/trac/attachment/wiki/HarmonieWorkingWeek/ALGO201701/Why%20Git_-v1-20170110_1049.pdf here] and [https://hirlam.org/trac/attachment/wiki/HarmonieWorkingWeek/ALGO201701/wc4dvar.pdf here] );[[BR]]
 -- Roger briefly talked about the use of Geo and polar winds in MetCoOp, AROME-Arctic and in rapid refresh systems. See [https://hirlam.org/trac/attachment/wiki/HarmonieWorkingWeek/ALGO201701/AMV_in_NWP.pdf the presentation here] ). [[BR]]
    Note: the presentation was uploaded after the meeting; [[BR]]
    Access to the locally produced high resolution geo AMV data was discussed and it was suggested that MET Norway can look after a possibility of sharing the wind data through ftp server or similar solution.[[BR]]

Prior to the meeting Nils gave higher priority to some tasks related to 4D-VAR system development, using numbering of the tasks listed below: 1, 2, 3, 12, 13 and continue with change of resolution and JcDFI testing.[[BR]]

We decided that this time most of participants are suggested to work with the most burning issue (or doubt) the variational system: convergence during the minimization.[[BR]]

**The following decision was taken with the outcomes**:[[BR]]
 -**Jan and Xiaohua**: look for the **convergence issue in 4D- and 3D-Var**, respectively;[[BR]]
 **Outcome**: 
     --**Jan**: using q with radiosonde data gives bad convergence, without q gives better convergence (I have the opposite of this in my note???)
                checking all the symmetry tasks in Var, adjoint can be the problematic one; [[BR]]
                switching off the simplified physics, sim4d is resetting it, so better solution/checking should be worked out;[[BR]]

     --**Xiaohua**: checking the convergence behaviour in 3D- and 4D-Var: it's suspicious often at the same assimilation time (also in CY38);[[BR]]
                Gradient test: both CONJGRAD and M1QN3 give bad gradient. M1QN3 gives less digits but judged as good(!), which is contradictory.[[BR]]
                checking CY40 runs, 2 weeks ran with no exit, unfortunately that was accidentally without ATOVS. Adding ATOVS in the system, 2 cycles are already showing problematic results.[[BR]]
                These results open questions: Do we have problem of change between T and Tv? Should we have have LSPRT False in the Var system?[[BR]]
                SeeÂ also **point 18** below for more information.[[BR]]
                

 -**Nils**: start to work with implementation of large extension zone;[[BR]]
  **Outcome**:
               use of new code from Ryad; [[BR]]
               climate and boundary files created;[[BR]]
               forecast was possible;[[BR]]
               issue with use of extended observation data;[[BR]]
               Next step: work on truncation between low and high resolution.[[BR]]

 -**Magnus**: look at the failure related to satellite observations in 4D-VAR;[[BR]]
  **Outcome**:
              The problem was identified and we have a fix for solving it while waiting for more careful identification of details of the cause of the problem. [[BR]]
              
 -**Siebren**: Porting/implementation of the use of GNSS slant delay data in CY40;[[BR]]
  **Outcome**:
              After porting, the screening works, but thhe minimization cannot find ODB. Lack of information about, for ex. elevation and azimuth angle.[[BR]]
              Shuffling ECMA to CCMA miss some important variables.[[BR]]
              Siebren have faced this kind of problem earlier, so it familiar with him. It will be handled properly.[[BR]]

 -**Carlos**: Add/implement Field alignment (FA) in CY40;[[BR]]
   **Outcome**:
              FA compiles correctly with makeup in CY40 and the FA package can now be included in the repository for analysis and experimental use by other partners.
              Carlos will adapt the package to domains and radar data different from the Spanish, and check results.[[BR]]
              Note: In its current version, FA does not take advantage of the capacity of overlaping radar data to resolve the full 2D-wind.[[BR]]
              This represents an interesting extension that was not implemented in this first version because it has a negligible impact for [[BR]]
              sparse radar networks as the Spanish network. This extension represents however a significant amount of work and it is postponed until[[BR]]
              the above mentioned tests have been conducted. [[BR]]              
              Carlos pointed out that makeup is not practical for developers, who need compile and build executables frequently in the course of their work.[[BR]]
              As it is now, makeup takes hours to re-build an executable when only minor modifications have been introduced. He requested a solution. [[BR]]
              He mentioned that gmkpack utility gave much better performance in this respect. Unfortunately, gmkpack is in a process of dropping from [[BR]]
              the official releases and not being mantained.[[BR]]  
            

 -**Roel**: look after possible ways for better implementation of incremental and additional forcing in variational under OOPS framework;[[BR]]
  **Outcome**: 
             Found comment from Mike Fisher (June 2015) in CY43 about "more broken code for LSPRT (famous conversion T <--> Tv).[[BR]]
             He presented he first idea on formulations of weak constraint. Be it nudging or forcing.[[BR]]

 -**Jelena**- the alpha control variable through extension of control vector space is implemented now in CY40 in the HARMONIE system (trunk);[[BR]]  
  **Outcome**:
             There are though problems with the convergences of the minimization in hybrid mode (hybrid 3DVAR). The minimization stops after 20-24 iterations
             out of 60 simulations with output mode 5 (m1qn3) indicating problems with the gradient. The scalar product test does not hold as well : 
             <x,ATAx>/<Ax,Ax> = 0.977866464. 
             Jelena knows in what subroutine error occurs. 
             Jelena is happy with the flexibility of code in CY40 : GRIDPOINT_FIELD and SPECTRAL_FIELD sctructure where used to implement the algorithm. 
             Jelena and Roel will discuss the implementation of the algorithm in OOPS layer, based on the code environment of CY45
           
 -**Sigurdur**- Implementation of ATOVS radiances at IMO
  **Outcome**:
             Restart of the experiments with MARS data was decided to see if the problem comes from a local and temporary data processing. This gave the same results as for local data. [[BR]]
             Two possible sources of the problem is actually under investigation: sudden change of the model performance in September 2016, and impact of assimilation of channels 5 from AMSU-A and AMSU-B/MHS;[[BR]]

 -**Ole**- Back and Forth nudging technique in Harmonie:
  **Outcome**: 
             The working week allowed to have better understanding of the code. It also allowed to think more about how to do the the back and forth integration. Ole observed odd computation in the extension zone, which creates problem.
             
 -**Roger**- porting of LETKF in CY40 (continue Pau's implementation work).[[BR]]
  **Outcome**:
             The compilation problem with makeup could not be repeated;[[BR]]
             After correcting/skipping some of the ported scripts, the experiment could executed using mSMS;[[BR]]
             Also the persisting problem with LBCs was solved.
             The experiment needs to be set up to perform LETKF properly. So far the setup of some member was not good enough. For ex. the control is still trying to do 3D-VAR, while the TDF file is doing what is expected after LETKF.[[BR]] 

 
== Possible tasks of the week with some short status ==

**1- Poor convergence issue** â test TL and AD (Magnus, Roel, Jan)[[BR]]
 Jan reported that with LPROCLD=.TRUE., which is the default setting in 4DVAR, the identity test  [M^TM x,y] = [x, M^TMy] failed. With LPROCLDTL=.FALSE., he succeeded to get good results. But, when Nils tried to run the 4DVAR with the same setting of the key, the minimization crashed. Nils and Jan will investigate the reason of the crash.[[BR]]

**2- Check the performance of the physics in minimisation** (Xiaohua, Magnus,Jan)[[BR]]
 This task is dependent to the task 1-. So, it will be tackled later.[[BR]]

**3- Extension zone â use B for preconditioning** (Nils, Xiaohua, Carlos)[[BR]]
 **Xiaohua** and **Nils** will keep in touch and decide about the test to be done.

**4- Where to put the change of resolution in the scheduler** (Nils, Jan)
 **Nils** succeed to implement the ECMWF technique to change resolution (in spectral space) of the control vector during 4DVAR process. The ECMWF procedure to similarly change resolution of the trajectory (including the background state) has not yet been introduced, since the LAM version of this was never completed. Nils will continue utilizing as far as possible existing ECMWF code.[[BR]]

**5- Test of VarQC or VarBC for Synop data** (Roger, Magnus, Jelena, Martin, Sigurdur)[[BR]]
 **Magnus** got in touch with experts from ECMWF asking about how to activate the VarBC for only ship data. He got some hits on where to look at more carefully.[[BR]]
 **Roger** started with the implementation of VarBC for ship data. Although for APD (GNSS ZTD) use of VarBC is well implemented, the move to another Synop subtype is not trivial. All implementation process needs to be repeated again. Roger is still thinking about how to start a good coldstart with Ship data VarBC.[[BR]]
 To check the functionality of VarQC one may need an outerloop process also working for 3DVAR. So, this will wait for the task 16- to be done.[[BR]]

5.1- **Karl-Ivar** was invited to present his work in MetCoOp with respect to **MSLP model bias** [ref to pres here][[BR]]

6- **Check the functionality of background check during the screening** (Roger, Magnus, Jan, Sigurdur)[[BR]]
 This task has not yet started.[[BR]]

7- **Use of field alignment (FA) with winds in 4DVAR** (Carlos, Nils)[[BR]]
 The group decided to test different ways of implementation of the FA with 4DVAR:[[BR]]
 â Use FA to correct the first-guess;[[BR]]
 â Use FA in different slot configurations:[[BR]]
    1- use it in the first slot only;[[BR]]
    2- use it in all slots.[[BR]]

**8- Check the humidity increment and its evolution in time** (Xiaohua, Jan, Roger)[[BR]]
 **Xiaohua** reported that they started working with this task at DMI, and they will check the results and report later. Roger will help him on what to check from different files.[[BR]]

**9- Use of radar data in 4DVAR** (Martin, Xiaohua, Jan)[[BR]]
 **Martin** succeed to have the radar data in all slots of ODB and have Bator and Screening running successfully. It seems that there is a problem with the minimization when other data are used on top of conventional (??). This problem is blocking further tests of the new structure of radar data in 4DVAR(??).[[BR]]

**10- Incremental analysis â strong vs weak** (Nils, Roel)[[BR]]
 This task was heavily discussed at some point during the meeting and 3 different solutions were considered:[[BR]]
 1--  Incremental analysis update during the non-linear model integration;[[BR]]
 2-- use solution 1-) also into TL/AD of 4D-Var;[[BR]]
 3-- use a weak constraint 4D-Var formulation.[[BR]]

**11- LETKF with 4DVAR screening** (Jelena, Roger)[[BR]]
 **Jelena** set up one experiment with LETKF. She faced problem with some ODB updates in the code. This work is progressing.[[BR]]

**12- Check that the correct innovation is extracted from ODB (NUPTRA)** (Nils, Roger)[[BR]]
 **Roger** will check the evolution of increments in ODB through the 4DVAR process. Note that Nils have checked one of his runs, which looked quite good except the last solution, which looked erroneous. He was not sure about the correctness of that last check.[[BR]]

**13- Warm start of minimisation** (Nils, Magnus)[[BR]]
 **Nils** knows how to proceed with this task  (information about Hessian should be transferred between outer loop iterations â code exists and needs to be activated).[[BR]]

**14- Coordinated effort in B computation** (Xiaohua, Roger, Nils, Jan)[[BR]]
 The participants would like to discuss first before proceeding with task. [[BR]]

**15- Proxy weak constraint** (Jan)[[BR]]
 **Jan** would like to have LFORCE and LFORCENL working under LELAM. It is implemented under LELAM=.false. and enables to determine optimal tendency perturbations.  It also provides the possibility to run 4DVAR with solely tendency increments (and without analysis increments). [[BR]]

**16- 3D-VAR outerloop** (Nils, Xiaohua)[[BR]]
 **Nils** and **Xiaohua** will work this task out.[[BR]]

**17- EnVar implementation in the AROME model [[BR]]

**18- Convergence issue with 3DVAR and 4DVAR [[BR]]
  * It has been seen in both 3DVAR and 4DVAR experiments problems with convergence. Nils encountered bad convergence with m1qn3 but in those cases use of CG helped with convergence. From the DMI operational archive, the log data for 3DVAR with both 38h1.2 and 40h1.1 contain numerous cases with unsatisfactory convergence, in which m1qn3 minimisation exit at maximum allowed iteration. One suspicion is on handling of moisture information associated with operation with virtual temperature. During the week Xiaohua and Ole tested use of CG in 3DVAR, which seemed to work, but the gradient test returns bad diagnosis. When testing with m1qn3 at hindcast mode, a two week test results showed quite normal exit (with output mode of m1qn3 as 1, meaning normal convergence). However, these runs were done without ATOVS data (conventional + AMV + RO). The new test with inclusion of ATOVS data are ongoing.
  * example output of gradient test with m1qn3
    * m1qn3, (ltest=T, lgrtest=T, ntestvar=1) 
      * GRTEST TENTATIVE CONCLUSIONS :
      * GRTEST function f looks continous.
      * GRTEST the best gradient test found has            7  satisfactory digits.
      * GRTEST SAYS: THE GRADIENT IS EXCELLENT.
      * GRTEST Gradient convergence is suspicious
      * GRTEST small-scale Taylor estimate of d2f=   5820443.7197034732     
      * GRTEST WARNING: small- and large scale  d2f estimates disagree.
      * GRTEST large-scale Taylor estimate of d2f=   5921879.9064941779     
      * GRTEST large-scale d3f/d2f=   102.07124235642513     
      * GRTEST the Taylor quadraticity test has           -1  satisfactory digits.
      * GRTEST: THE T-QUADRATICITY IS BAD.
      * GRTEST finite diff. d2f estimate no1:   5922888.3603442237     
      * GRTEST finite diff. d2f estimate no2:   5923066.0554021597     
      * GRTEST the fin.dif. estimates of d2f have            4  satisfactory digits.
      * GRTEST: THE FD-QUADRATICITY IS ACCEPTABLE.

    * conjugate gradient (l_check_gradient=T)

**Agenda:**

We will start with short report from participants in the first day. Otherwise, the normal daily agenda is described below.


 Normal daily agenda:[[BR]]
09:00 - 10:00: Working in groups[[BR]]
10:00 - 10:30: coffee break[[BR]]
10:30 - 12:00: working in groups[[BR]]
12:00 - 13:00: lunch break[[BR]]
13:00 - 15:00: working in groups[[BR]]
15:00 - 15:30: coffee break[[BR]]
15:30 - 17:30: working in groups[[BR]]
We checked twice the progress from different tasks during the meeting  [[BR]]


== Practical local information ==


== Reference: previous HARMONIE working weeks ==

* [wiki:HarmonieWorkingWeek/4DVAR201605 201606], Norrkoping, Extended 4Dvar working week 2016
* [wiki:HarmonieWorkingWeek/UseObs201605 201605], Madrid, UO working week 2016
* [wiki:HarmonieWorkingWeek/4DVAR201511 201512], ECMWF, 4D-Var Working Week 2016
* [wiki:HarmonieWorkingWeek/UseObs201509 201509], Dublin, The Harmonie DA&UO Working Week 2015
* [wiki:HarmonieWorkingWeek/4DVAR201503 201503], NorrkÃ¸ping, The Harmonie 4DVAR Working Week 2015
* [wiki:HarmonieWorkingWeek/UseObs201410 201410], Santander, The Harmonie DA&UO Working Week 2014
* [wiki:OOPS/KNMI_201409 201409], KNMI, The HARMONIE OOPS/C++ Working Meeting

