[[PageOutline]]

[[Center(begin)]]
== '''Hirlam System Documentation''' ==
= '''Running Reference Hirlam on DMI HPC''' =
[[Center(end)]]

== Reference Hirlam Installation on DMI Cray XT4 ==

The main reference Hirlam versions are installed, and daily updated when applicable, on DMI's supercomputer platform, XT4, under
{{{
   /home/xiaohua/hirlam_release            # for recently tagged HIRLAM releases, trunk, branches
   /home/xiaohua/harmonie_release          # for recently tagged HARMONIE releases, trunk
}}}
Users may check Hirlam source code and scripts for each installed versions.

At present, interested users are advised to use the special DMI branch '''cisdmi''', for experimentation. '''cisdmi''' is assembled on top of the HIRLAM '''cis''' branch, which is set to become the basis of Hirlam 7.3 after tagging of [https://hirlam.org/trac/wiki/Hirlam_7.2 Hirlam_7.2]. See reference information on  
[https://hirlam.org/trac/wiki/CIS080424 a tagged '''cis''' version on 20080424].

'''cisdmi''' branch will be synchronized to '''cis''' branch, and adapted thereafter when '''cis''' branch is merged into Hirlam trunk. 

Note that as a svn branch, '''cisdmi''', similar to other untagged branch versions, may be updated irregularly. If users need to work on a frozen code version, a frozen reference installation need to be made, see below.

== Individual Hirlam Installation on DMI Cray XT4 ==

If you would prefer to base your experiment on a "frozen' HIRLAM code which stay unchanged, you may make your own personal copy and refer your experiment setup to that. In the following, an example is given for user $user to make his own copy of the '''cisdmi''' branch on 20080629.

{{{
   mkdir -p $HOME/hirlam_release
   cd $HOME/hirlam_release
   cp -r ~xiaohua/hirlam_release/cisdmi cisdmi20080629
}}}

== Perform Hirlam experiment on DMI Cray XT4 ==

 1. create an experiment directory $exp under $HOME/hl_home,
{{{
   mkdir -p $HOME/hl_home/$exp; cd $HOME/hl_home/$exp
}}}
 1. link utility script Hirlam
{{{
   alias Hirlam ~xiaohua/Hirlam
}}}
 1. set up basic setting for Hirlam experiment
{{{

   Hirlam setup        # this will install minimum settings for running Hirlam experiment using default settings on XTÂ¤
                       # which uses Gfortran compiler, with source code based on CISDMI branch and with model domains on DMI-G45
}}}
 1. alternatively, if you have made a frozen '''cisdmi''' code in your $HOME/hirlam_release, you can base your experiment on that source
{{{
   Hirlam setup -d $HOME/hirlam_release -r cisdmi20080630       
}}}
 1. or, if you would like to try PGI compiler, you may add an -h option for that compiler. In the above example,
{{{
   Hirlam setup -d $HOME/hirlam_release -r cisdmi20080630 -h xt4linuxpgi      
}}}
 1. if applicable, 'check out' relevant source codes or scripts and do modification
{{{
   Hirlam co scripts/Env_domain               # e.g, to specify different request for number of nodes/PEs for the chosen model domain
   Hirlam co scripts/Env_expdesc              # e.g., change domain, analysis scheme, physics scheme, obs types etc.
   Hirlam co phys/hlconds.F                   # e.g., modify physics subroutine hlconds.F
}}}
 1. launch experiment, e.g.,
{{{
   Hirlam start DTG=2008062500 DTGEND=2008062512 LL=06 # this runs forecast with start cycle 2008062500 and last cycle on 2008062512,
             # with a forecast length of 6h. Note that due to limited storage space on XT4 only obs and boundary data for the past few 
             # days are available. It is thus safer to pick up recent dates for experiments
}}}
 1. The experiment data including log files are in /datadirs/data/$USER/hl_home/$exp
    * Log files are in form of HL_*html
    * experiment data for several cycles earlier will be automatically deleted
    * full set of experiment data are archived in /datadirs/data/$USER/hl_arc/$exp
 1. You can follow your model runs either via links in the Graphic User Interface (GUI) pop-up window
    * You can turn off the graphic user interface prior to launch of experiment by
{{{
   setenv mXCdp DISABLE
}}}
    * You can exit from the graphic user interface using File-> Quit GUI on the GUI window while keeping the experiment running
    * You can then recover the previously closed GUI by
{{{
   cd ~/hl_home/$exp
   Hirlam mXCdp                                                 
}}}
    * You can terminate the experiment completely by using File->Exit miniSMS button via the GUI

== Test of different configurations on DMI Cray XT4 ==

=== Resource request with batch jobs ===

 * Some parameters have been devised in order for users to change resource requests with batch jobs in [https://hirlam.org/trac/browser/branches/cisdmi/scripts/Env_domain?rev=6000 Env_domain]
{{{
    DMINPROC=10               # total nr of PE's for forecast and 4DVAR jobs
    DMINODES=5                # total nr of computer nodes for forecast and 4DVAR jobs
    DMINTASKS=2               # number of tasks per node
    DMINPROCX=2               # domain decomposition with forecast model, x-direction
    DMINPROCY=5               # domain decomposition with forecast model, y-direction, DMINPROCX*DMINPROCY+NHGS=DMINPROC!!
    DMINPROCX4D=2             # domain decomposition with forecast model, x-direction with 4DVAR 
    DMINPROCY4D=5             # domain decomposition with forecast model, y-direction with 4DVAR. DMINPROCY4D*DMINPROCX4D=DMINPROC!!
}}}
 * Please be watchful to avoid over-subscription of system resources
   * Keep an eye on http://nydmirrd/CRAY/odin.html
   * Use 'apstat' on ODIN to check status of used, available PEs etc. 

=== Additional Reference ===
Check other [https://hirlam.org/trac/wiki/Hirlam_7.2#PerformingexperimentswithHIRLAM7.2 instructions about alternative settings of running recent versions of reference HIRLAM]

== Existing utilities for verification, monitoring and diagnosis of experiment results ==

=== Observation verification ===

 * Reference Hirlam runs extract automatically model equivalent to a pre-selected SYNOP and TEMP observation station lists. 
   * The ASCII format data are stored in /datadirs/data/$USER/hl_arc/$expdir/$YYYY/$mm/$dd/$hh/vfld$expdir$dtg.tar.gz
 * Offline (stand-alone) extraction of model and observation data to pre-defined station list is possible using HARMONIE gl/fldextr utility.
   * On ECMWG HPC, monthly ASCII-format observation data derived from MARS data set are archived in ec:/hirlam/oprint/OBS; The corresponding data for current month is available on ecgate:/scratch/ms/dk/nhz/oprint/OBS2
 * Statistics inter-comparing model and observations for specific station/area list can be done using HARMONIE/monitor utility verobs
 * see [https://hirlam.org/trac/wiki/HirlamSystemDocumentation/PostPP/CommonVerification documentations on common verification]

=== Forecast and analysis statistics ===
=== Analysis monitoring ===

== Status of platform adaptations with '''cisdmi''' on Cray XT4 ==

In terms of reference Hirlam system, following [https://hirlam.org/trac/changeset/6000 adaptations] have been done on XT4 for '''cisdmi''' branch:

 * Creation of XT4 specific architecture files [https://hirlam.org/trac/browser/branches/cisdmi/config-sh/config.odingfortran config-sh/config.odingfortran], using Gnu Fortran compiler, and [https://hirlam.org/trac/browser/branches/cisdmi/config-sh/config.odinpgi config-sh/config.odinpgi] using PGI compiler. The latter has not been fully tested through with problems in data assimilation.
 * Creation of XT4 specific compiler configuration [https://hirlam.org/trac/browser/branches/cisdmi/config/config.xt4gfortran config/config.xt4gfortran] and [https://hirlam.org/trac/browser/branches/cisdmi/config/config.xt4linuxpgi config/config.xt4linuxpgi]
 * Script adaptation to use data available to DMI platform, such as [https://hirlam.org/trac/browser/branches/cisdmi/scripts/Env_input?rev=6000 Env_input], [https://hirlam.org/trac/browser/branches/cisdmi/scripts/MakeCMA?rev=6000 MakeCMA], [https://hirlam.org/trac/browser/branches/cisdmi/scripts/Prepob?rev=6000 Prepob] etc.
 * Script adaptation for [https://hirlam.org/trac/browser/branches/cisdmi/scripts/submission.crayxt4?rev=6000 batch and background job submission]
 * Source code changes to use DMI bufr data with [https://hirlam.org/trac/browser/branches/cisdmi/span/prcsyn.F?rev=6000 prsyn.F], [https://hirlam.org/trac/browser/branches/cisdmi/span/prcsyn.F?rev=6000 prcshp.F]
 * Source code changes in Span [https://hirlam.org/trac/browser/branches/cisdmi/span/cntrol.F?rev=6000 span/cntrol.F ] to apply MPI in surface analysis (Bjarne Stig Andersen and Claus Petersen)
 * The current default configuration, as defined mainly in [https://hirlam.org/trac/browser/branches/cisdmi/scripts/Env_expdesc?rev=6000 scripts/Env_expdesc], features following basic characteristics
   * 202x190x40 domain (DMI_G45), as defined in [https://hirlam.org/trac/browser/branches/cisdmi/scripts/Env_domain?rev=6000 scripts/Env_domain ], changeable via [https://hirlam.org/trac/browser/branches/cisdmi/scripts/Env_expdesc?rev=6000 scripts/Env_expdesc] to other domains, such as T15, S05, M15 etc
   * 4DVAR with 6 hr cycling
   * STRACO, 6th order horizontal diffusion, SETTLS
   * assimilation of conventional data + AMSU-A, AMSU-B, AMV and Seawinds

== TODOs and known deficiencies with '''cisdmi''' on Cray XT4 ==

 1. Compilation
   * Some problems with PGI compiler for DA code
   * Pathscale compiler has not been tried
 1. Optimisation
   * -O2 option is used in Gfortran compiler but no serious work has been done
 1. Problems with use of parallel experiment data 
 1. Seawinds does not seem to work in 4DVAR
 1. Reference Span do not use OSI-SAF yet, although it might be possible, now thanks to MPI-Span, that OSI-SAF are linked directly as pseudo OBS and used in reference code too
 1. Nesting scenario has not been tried yet


[[Center(begin)]]
[https://hirlam.org/trac/wiki/HirlamHowto See also the corresponding pages on HIRLAM Howto]
[[Center(end)]]


[[Center(begin)]]
[https://hirlam.org/trac/wiki/HirlamSystemDocumentation Back to the main page of the HIRLAM System Documentation]
[[Center(end)]]
----

[[Center(begin)]]
[[Disclaimer]]

[[Color(red, Last modified on)]] [[LastModified]]
[[Center(end)]]