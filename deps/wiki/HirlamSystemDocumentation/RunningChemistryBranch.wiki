[[PageOutline]]

[[Center(begin)]]
== '''Hirlam System Documentation''' ==
= '''Running Hirlam Chemistry Branches''' =
[[Center(end)]]

== The current versions of HIRLAM Chemistry Branches  ==

At present, the branch combines the current HIRLAM NWP code with the online chemistry scheme for gas phase (with 19 species), based on similar work at DMI by Ulrik Korsholm et al. The script system is based on that of Reference HIRLAM.

The current code already allows specification of emmissions but a general framework for easier use is to be developed.

For more details about source code of the chemgas branch, please contact Ulrik Korsholm (usn at dmi.dk). For general discussion and technical assistance, please address to mailing-list chemical@hirlam.org or system@hirlam.org

== Installations  ==
=== System requirements ===
 * Compilers, tools
   * Compiler for F77/F90, C
   * Perl, Shell
   * HDF 4.0 (mandatory for climate generation)
 * Data that is not included in the standard HIRLAM source code repository
   * Sample observation data for conventional data (bufr-format); satellite data (atovs etc.), and sample ECMWF lateral boundary data including SST information in GRIB format
   * Physio-geographical database, see [wiki:HirlamSystemDocumentation/Configure/ClimateGeneration infor about climate data base], and [wiki:HirlamHowto/Install/General#WhatisanHDFSETandwherecanIfindtheHDFsets HDF files for physiographic data]
 * Preferably, also the Subversion revision control client svn
=== Where and How to download source ===
 * via internet revision control tool Subversion client
   * Hirlam source code repository is maintained in the server hirlam.org. Access control is enforced if accessing outside of headquarters of the HIRLAM member services and ECMWF platform. 
   * the following can be used to extract the current source:
{{{
   svn export https://svn.hirlam.org/branches/CHEM/chemgas
}}}
 * via ECMWF server ecgate, the official reference platform of HIRLAM system
  * Experiments can be made on ECMWF computer platform using HIRLAM release installed there
  * A tarball, chemgas0519.tar.gz, can be fetched from hirlam server at https://hirlam.org/portal/download/src. Under the same directory you may find the climate data base "hl_cldata-7.2.tgz" and a set of sample data for experimentation, "testdata_chemgas.tar.gz" including scripts and source updates that enable experimentation on simple (Linux) platform

== Reference Hirlam Installation at ECMWF  ==

The latest chemgase version is installed on ECMWF server ecgate:
{{{
   /ms_perm/hirlam/hirlam_release/chemgas        
}}}

== Chemgas Installation at local platform ==
 * with svn, the repository can be built by
{{{
   svn export https://svn.hirlam.org/branches/CHEM/chemgas
}}}
 * with a tarball, e.g., ~/chemgas20100519.tar.gz, the repository can be established by
{{{
   mkdir -p $installation_directory/hirlam_release; tar zxvf ~/chemgas20100519.tar.gz
}}}
 * At DMI, the chemgas version is installed on the supercomputer platform, XT5, under
{{{
   /home/xiaohua/hirlam_release/chemgas        
}}}

== Perform Hirlam experiment on local platform ==

 1. create an experiment directory $exp under $HOME/hl_home, where $exp is a name of your free choice
{{{
   mkdir -p $HOME/hl_home/$exp; cd $HOME/hl_home/$exp      # note that in practice, the directory structure
                  #  is compulsory, i.e, the settings with $HOME/hl_home/ is expected by the mini-SMS script.
}}}
 1. link utility script Hirlam
{{{
   alias Hirlam $installation_directory/hirlam_release/chemgas/config-sh/Hirlam
}}}
 1. set up basic setting for Hirlam experiment, assuming you are on Linux platform,
{{{
   Hirlam setup -r chemgas -d $installation_directory/hirlam_release -h LinuxPC   
}}}
 1. The above 'setup' option will install minimum settings for running Hirlam experiment using default settings on LinuxPC
{{{
   config-sh/hl_rev           # this file contain the directory path of the reference source, in this case:
                              # $installation_directory/hirlam_release/chemgas
   config-sh/Main             # Hirlam start scripe
   Env_system => config-sh/config.LinuxPC             # platform definition file about compiler and data structures
}}}
 1. if applicable, 'check out' relevant source codes or scripts in order to do modification. See more details in next chapters.
{{{
   Hirlam co scripts/Env_domain               # e.g, for domain specifications, output intervals etc.
   Hirlam co scripts/Env_expdesc              # e.g., change domain, analysis scheme, physics scheme, obs types etc.
   Hirlam co scripts/Env_input                # e.g., change location of various input data
   Hirlam co phys/hlconds.F                   # e.g., modify physics subroutine hlconds.F
   Hirlam co phys                             # e.g., check out the entire phys library and modify some of them
}}}
 1. The default 'LinuxPC' setup specifies designated location of local data in the following files. Modify them accordingly
    * in $HOME/$exp/Env_system:
{{{
HIRLAM_CONFIG=linuxgfortran             # compiler version, which requires a corresponding file in 
                                        # src/config/config.$HIRLAM_CONFIG
SCRATCH=$HOME/scratch
HL_CLDATA=$SCRATCH/hl_cldata/dat        # climate data directory
HL_REF_FS=$SCRATCH                      # location of input data
HL_DATA=$SCRATCH/hl_home/$exp           # location of runtime experiment data/results
HL_ARC=$SCRATCH/hl_arc                  # permanent storage location of experiment data/results
}}}
 1. before launching any HIRLAM experiment, make sure that you have some basic input data
   * physio-geographic data base
   * input data with observations and lateral boundaries, surface (sst and sea ice cover) data
     * as a bare minimum, one needs surface and upper air observation data
     * some lateral boundary data with full coverage of the chosen domain, e.g. those from global model ECMWF
   * if you do not have other options to acquire sample data, please use following links to download physio-geographic data and sample test data
{{{ 
https://hirlam.org/portal/download/hl_cldata.tar.gz             # physio-geographic data needed for generation of climate constants
                 # go to $SCRATCH and ungzip/untar the above to place data under $SCRATCH/hl_cldata/dat
https://hirlam.org/portal/download/testdata_chemgas.tar.gz      # some observation data and lateral boundary data
                 # ungzip/untar the above and place files *mars to $SCRATCH/dat/bnd and ob* into $SCRATCH/dat/obs
}}}
   * if you wish to jump over the generation of climate data, you may find a sample climate file cl00030000 from the above testdata_chemgas.tar.gz which is valid for March month and for the TST domain, and place it in directory $HL_DATA so as to skip the step
 1. launch experiment, e.g.,
{{{
   Hirlam start DTG=2010032000 DTGEND=2010032006 LL=06 # this runs forecast with start cycle 2010032000 and last cycle on 2010032006,
             # with a forecast length of 6h.
}}}
 1. The experiment results including log files are in $SCRATCH/hl_home/$exp
    * Log files are in form of HL_*html and stored in $SCRATCH/hl_home/$exp/$cyclename
{{{
      HL_Cycle*html: log files for computations 
      HL_MakeCycleInput*html: log files for cycle preparation
      HL_PPcycle*html: logfiles for post-processing
}}}
    * experiment data for several cycles earlier will be automatically deleted
    * full set of experiment data are archived in $HL_ARC/$exp/$yyyy/$mm/$dd/hh/$ll
 1. You can follow your model runs via links in the Graphic User Interface (GUI) pop-up window
    * You can turn off the graphic user interface prior to launch of experiment by
{{{
   setenv mXCdp DISABLE
}}}
    * You can exit from the graphic user interface using File-> Quit GUI on the GUI window while keeping the experiment running
    * You can then recover the previously closed GUI by
{{{
   cd ~/hl_home/$exp
   Hirlam mXCdp                                                 
}}}
    * You can terminate the experiment completely by using File->Exit miniSMS button via the GU

== Modification of source codes ==
 * if you want to modify, add, delete source code from the reference setting, you may do so on the experiment set-up directory. Assuming again you have an experiment setting on $HOME/hl_home/$exp
   1. First, 'check out' the relevant source codes for modification.
{{{
   Hirlam co phys/hlconds.F                   # e.g., if you want to modify physics subroutine hlconds.F
   Hirlam co phys                             # e.g., check out the entire phys library and modify some of them
}}}
   1. modify the source codes
   1. eventually, modify also the scripts in similar fashion, see examples below.
   1. all done, launch the experiment:
{{{
   Hirlam start DTG=2010032000 DTGEND=2020032006 LL=06 
}}}

== Modification of [https://hirlam.org/trac/browser/branches/CHEM/chemgas/scripts scripts], experiment configurations ==
 * Most of the experiment configuration settings are defined in scripts [https://hirlam.org/trac/browser/branches/CHEM/chemgas/scripts/Env_expdesc Env_expdesc], [https://hirlam.org/trac/browser/branches/CHEM/chemgas/scripts/Env_domain Env_domain], [https://hirlam.org/trac/browser/branches/CHEM/chemgas/scripts/Env_input Env_input], [https://hirlam.org/trac/browser/branches/CHEM/chemgas/scripts/submission.db submission.db]
 * In $HOME/hl_home/$exp, use commands like following to retrieve reference scripts and modify
{{{
   Hirlam co Env_expdesc
   Hirlam co Env_input           # You are likely to need modifying the script if your experiment is about historical episode, in which 
                                 # the input data are not in the current operational data directories
   Hirlam co Boundaries           
}}}
  * Selection of model domain and resolution
     * edit [https://hirlam.org/trac/browser/branches/CHEM/chemgas/scripts/Env_expdesc scripts/Env_expdesc] for selection of DOMAIN other than "RCR_7.1", such as TST 
     * edit [https://hirlam.org/trac/browser/branches/CHEM/chemgas/scripts/Env_domain scripts/Env_domain] for selection of output frequency etc.
 * Selection of analysis scheme
   * edit [https://hirlam.org/trac/browser/branches/CHEM/chemgas/scripts/Env_expdesc scripts/Env_expdesc] for selection of 
    * ANALYSIS scheme ('''3DVAR''', 4DVAR, NOUA and NONE) for your interest. 
  * Data assimilation with 3D-VAR. For working with chemgas, it is adviced not to change those settings related to data assimilation
   * For 3D-VAR, the default options is 6h cycling (FCINT=06) with FGAT.
   * Default background error structure function is based on statistical balance, which is available for both 40 and 60 levels. The structure function data are obtained from RCR forecast using the NMC method.
   * The default 3DVAR minimisation uses full resolution (LOWRESINCR=no) assuming the resolution in the background error structure function is the same as forecast model. When used for finer resolution 3DVAR such as 5 to 10 km, please consider to change LOWRESINCR in scripts/Env_expdesc to yes to avoid too noisy analysis increment, unless you use locally derived B.
 * Selection of coupling scheme
   * Current default in chemgas assumes boundary coupling to ECMWF data, with independent data assimilation
   * If upper air assimilation is wished, please do following adjustment in scripts/Env_expdesc
{{{
   ANALYSIS=NOUA
   MIXINT=no
   INCMOD=2
   BDSTRATEGY=analysis_only               # use ECMWF 6 hourly analysis as lateral boundary
   BDINT=6
}}}
 * Choice of physics scheme
   * Currently only STRACO condensation scheme has been tested with CHEMISTRY=yes option
 * Choice of output data streams
   * Edit Env_domain to request more model level output data than the default
   * Edit Env_expdesc for OUTSTREAM to add or reduce post-processing data stream and parameters
 * Launch of single/multi cycle jobs. progress.log and progressPP.log in the experiment home directory $HOME/hl_home/$exp are automatically generated and updated during HIRLAM cycle to enable tracking of current forecast cycles. progress.log contains following parameters:
   * DTG                # current cycle date $YYYY$MM$DD$HH          
   * DTGBEG             # date of the first cycle (cold start, set to DTG value at first launch of "Hirlam start DTG="
 * At the end of each forecast cycle, progress.log is updated with DTG information. Use 
{{{
   Hirlam prod          # to resume a cycle with the DTG information taken from progress.log
}}}
 * Please be watchful to avoid over-subscription of system resources
== Additional Reference ==
 * [wiki:Hirlam_7.3 HIRLAM7.3 ]
 * [wiki:HirlamSystemDocumentation Hirlam system documentation]



[[Center(begin)]]
[https://hirlam.org/trac/wiki/HirlamHowto See also the corresponding pages on HIRLAM Howto]
[[Center(end)]]


[[Center(begin)]]
[https://hirlam.org/trac/wiki/HirlamSystemDocumentation Back to the main page of the HIRLAM System Documentation]
[[Center(end)]]
----

[[Center(begin)]]
[[Disclaimer]]

[[Color(red, Last modified on)]] [[LastModified]]
[[Center(end)]]