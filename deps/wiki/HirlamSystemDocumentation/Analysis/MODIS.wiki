[[PageOutline]]

[[Center(begin)]]
== '''Hirlam System Documentation''' ==
= '''Assimilation of MODIS data''' =
[[Center(end)]]

= Introduction =

Several modifications have been implemented in HIRVDA 7.1 beta1 for assimilation of MODIS wind data. It is fair to say that HIRVDA v7.0 was in most aspects already prepared for assimilation of these data due to previous work carried out by K. Mogensen. However, some aspects of the system had become outdated and required upgrades. In addition some enhancements have been introduced. 

= MODIS Wind Data =

Wind retrievals over the Polar Regions of the Earth by tracking clouds and moisture patterns on sequences of MODIS (Moderate Resolution Imaging Spectroradiometer) images have been produced since November 2003 at NOAA-NESDIS. Before that time, the technique was tested and developed at CIMSS (Cooperative Institute for Meteorological Satellite Studies, University of Wisconsin-Madison). The extraction method is based on similar principles to those used in producing winds from sequences from imagers in geo-stationary orbits. MODIS is embarked on the polar platforms EOS-I and EOS-II of NASA, also known as “Terra” and “Aqua”. As of the time of this writing (February 2007), MODIS sensors on both platforms are operating nominally (http://modis.gsfc.nasa.gov). These satellites orbit the Earth with a period of about 90 minutes. Nominal observation times from one platform are therefore at time intervals of roughly this length. Products from different platforms arrive shifted in time by of about 30 minutes. The number of wind fields that can potentially be used with a six hours assimilation window usually fluctuates between five and seven. As of July 2004, the timeliness of about 5 hours was too long for some assimilation systems. However, by using DB (Direct Broadcast) sites and by alternating passes of Terra and Aqua, it was believed at that time that a significant improvement in this important issue could be achieved, at least for the Northern Hemisphere. The overall satisfaction with the quality of the results obtained has promoted the extension of this data coverage mission in different ways, for example using AVHRR imagery and AIRS radiance data. Who writes this lines does not know about the present status of these important (from the perspective of routinely exploiting these data in near-real-time) issues.

Traditionally, these data consist of vectors whose channel frequency is 10.69μ (so-called “infra-red”) and 6.8μ (so called “water-vapour”). The water-vapour winds are in turn classified as cloudy or clear-sky vectors depending on the type of tracer used in the retrieval. All of them have a nominal spatial resolution of 60 Km and a nominal time resolution of about 3 hours (i.e. represent mean atmospheric motions on these scales). Another piece of information that can be found in the buffer messages is the algorithm employed to assign a height level. This can be: CO2 slicing, suitable for opaque and thin clouds when there is a good contrast between the cloudy and the clear-sky portion of the scene; H2O intercept, suitable for semi-transparency corrections for thin or broken clouds in the middle and upper troposphere; and Equivalent Black Body Temperature or EBBT for opaque clouds. Three different confidence or quality indexes are included in the buffer messages as well. The first and second differ in that the first does not contain a previous check versus a background field, while the second does. The third has been found meaningless. The following table summarises this traditional classification of MODIS winds (Note that this information could be different for winds produced at present ! )


|| Vector type [[BR]] '''Key 15 in buffer Message''' || Channel frequency (in microns) [[BR]] '''Key 19 in b.m''' || Height assignment Method [[BR]] '''Key 22 in b.m''' || Description ||
||1|| 10.69 || 1 or 3 || IR winds opaque (EBBT) or semitransparent (CO2 slicing) respectively ||
|| 0 || 6.8 || 2 or 3 || Water vapour cloudy tracers (H2O intercept or CO2 slicing ) respectively ||
|| 5 || 6.8 || 2 or 3 ||Clear Sky with moisture  patterns as tracers.  (H2O intercept or CO2 slicing) respectively ||

Height assignment for MODIS winds is strongly affected by specific qualities of the polar atmosphere, e.g. : low water vapour amounts, optically thin clouds, strong surface inversions, high surface albedo, etc… Experts propose the following recommendations regarding height assignment: a) CO2 slicing should not be used for clouds below 700 hPa because of uncertainties regarding radiative properties of the surface, b) H2O intercept method in clear sky conditions is not reliable when Total Precipitable Water is below about 0.3 cm. For cloudy conditions the use of this method is not reliable below 600 hPa. c) Use of EBBT should only be used if optical depth estimates are consistent with the opaque cloud assumption and special care is required when handling T profiles with inversions.

= How to run HIRLAM with MODIS winds =

This is straightforward if done with the HIRLAM installation on ECMWF machines and the data is extracted from MARS (i.e. off-line or experimental runs). Simply set the environment variable '''AMVPOL''' that you
will find in '''Env_expdesc''' equal to "yes". If runs in passive mode are wanted (for example for the production of data to tune the blacklisting and
bias correction scheme presented below), make sure that the '''LLMODISWIND''' switch is set to ".false." in '''minobstypes.dat'''. 

The buffer tables '''B0000981101.TXT and D0000981101.TXT''' are necessary. You should make sure that the binaries are produced and reachable to '''obsproc.x'''. The script '''Prepob''' will create a buffer file '''ob${DTG}amv''' holding the data. '''obsproc.x''' will assign to these data the CMA observation codes (3,90) and sequence numbers (3,4). The CMA codes (3,91) and sequence numbers (3,6) have been reserved for Geo-stationary AMVs.

You should be aware that if you intend to run HIRLAM with MODIS data on a local HIRLAM installation some changes in the obsproc software will be required. These typically include new buffer tables and new mapping between buffer and CMA codes. The former belong to the "outer world" and may change depending on how you get access to the data. The latter (already in "HIRLAM territoty") must not be changed. For an idea of the overhead implied in doing this kind of adaptaions take a look at the first table of the last section of this doc "Detailed List of Changes". In addition, some driving scripts (e.g. '''Prepob''') will very likely have to be changed too.  

Finally, the production of statistical feedback from ACMA is left to a big extent to the user. In this respect, you should be aware that
the header optional part of the CMA record has been changed to accomodate new parameters extracted from the buffer message. See below for more 
detailed information on this. Moreover, the use of the new blacklisting and bias correction scheme will add the correction to the back-obs differences and therefore it will not be possible to recover the whole set of background and observed values from the current cmastat.x files because they only give observation and differences. This of course can be easily solved by reading the background values from ACMA.   

= Blacklisting and Bias Correction =

The v7.0 has no bias correction scheme for this kind of data and the blacklisting is not adequate because it is only based on satellite id., while an analysis of the structure of this systematic error indicates that other control parameters like: vector and height assignment type ( see previous table ), underlying surface type, height or observed wind speed, are necessary to characterise it. For example, the figure shows the speed bias structure for Terra MODIS winds of type (1,1), i.e. infra-red with EBBT height assignment method, the upper graph is for vectors over sea surface and the lower graph for vectors over land surface.
[[Center(begin)]]
[[Image(SpBias1.jpg, border:solid 5px green)]] 
[[Image(SpBias2.jpg, border:solid 5px green)]] 
[[Center(end)]]
The red curve is for the bias ( defined as obs-back! ) expressed as percentage of observed speed. The green line is for the number of observations over the period considered (January 2006). In light of these curves, one possible blacklisting and bias-correction strategy can be: “''From platform Terra infra-red vectors with EBBT height assignment, consider vectors irrespective of their qc index. Over sea surface consider only vectors between 850 hPa and 300 hPa and speed between 10 and 60 m/s and apply a correction of +3%. Over land consider only vectors between 700 hPa and 300 hPa and speed between 15 and 40 m/s and apply no correction''”. These instructions can be translated in two lines of a small text file:

783 1 1 0. 0. 85000. 30000. 10. 60. -3. 0. [[BR]]
783 1 1 1. 0. 70000. 30000. 15. 40.   0. 0.

The '''first column''' refers to the sat id (783=Terra 784=Aqua) and '''the second and third''' to the vector type and height assignment method as in table 1. The '''next column (4th)''' refers to surface type: 0 for sea-surface and 1 for land-surface. The '''5th column''' is the qc index threshold below which all vectors will be blacklisted (i.e. 0 if none is to be blacklisted, 100 or bigger if all are to be blacklisted).'''The next four numbers( columns 6th 7th 8th and 9th)''' are the atmospheric layer boundaries (in Pa) and observed speed limits (in m/s) to consider (out of these thresholds the vector is blacklisted !) and '''the last two numbers (10th and 11th)''' are the offset and slope of the bias (note the sign!) expressed in % of the observed wind speed (not the background speed !).

This bias correction simply computes a coefficient according to this information in this manner:

Bc_coefficient = a0 + a1*(obs_speed – s0) ; 

where a0, a1 and s0 are the 10th 11th and 8th columns in the text file. Rudimentary as it might seem, this scheme gives some bias-correction and blacklisting functionality for this type of data that the v7.0 system does not have. MODIS wind data whose sat id, vector type, height assignment method and surface type are not included in the text file will be blacklisted. Obviously, inclusion of these vectors in the text file with a qc index lower threshold (5th column) above 100 will blacklist them too. The expression of bias correction coefficient in percent was found convenient because many plots like those in the figure suggest that in terms of percentage, a linear fit adjusts sufficiently well the speed bias for all the range of observed speeds. Note that if two rows are given with the same first to four columns but different in any of the other seven, only the first row read out from the text file will be consider (this makes at this time not possible to consider, for example, two different layers or two different observed speed intervals for the same vector type).

This functionality has been implemented in a new piece of code '''modis_bl_and_bc.F''', placed in the '''scrobs library'''. The text file driving it is named '''modis_bl_and_bc.dat''' and at run time this file must be found in '''$hl_wd/hirlam/data/hirvda/modis_data'''. This functionality is activated when the switch '''lmodisbl_and_bc''' in the '''namelist scrnam''' is set to ”.true.”. Failure to find or read the text file when this switch is on will make the run abort and an informative message will be sent to the log. Keeping with the current definitions for status and events flags a MODIS report blacklisted will be flagged as (8,64). A bias corrected report will be flagged as (1, 1) (this is a new feature). The increments (defined as back-ob!) and the observation values (rotated) passed to “modis_bl_and_bc.F” return corrected according to the formulas:

du=du + Bc_coefficient * u_obs ; [[BR]]
dv=dv + Bc_coefficient * v_obs; 

and 

u_obs=(1 - Bc_coefficient) * u_obs ; [[BR]]
v_obs=(1 - Bc_coefficient) * v_obs ;

This implies that observations read off from the ACMA archive will include the correction if they are given in the rotated frame and will not include the correction if they are given in the standard frame. Increments read off from the ACMA archive will always include the correction. In order to recover all the information, the “cmastat.x” statistical files will have to be expanded. 

Small speed biases of 5% or so might be regarded acceptable and the overhead implied in setting this bias correction scheme excessive. In this case, it is advised to employ instead the old low winds (clearly the most problematic) rejection scheme. The price to pay is that then no low level data will be retained. The piece of software that performs this rejection of low level MODIS vectors according to type and surface type in v7.0, namely “modis_rejectlow.F”, has been updated and recoded into '''rejectlow_modis.F'''. As in v7.0, it is active if the switch '''lmodiswindrejectlow''' in the '''namelist scrnam''' is on. The parameters that determine the rejection thresholds are the same as in v7.0. Note however that this low level rejection scheme is prepared to work only with the vector types given in table 1, therefore new updates in the MODIS winds data stream from the providers can presumably be more easily handled by using the new blacklisting and bias correction functionality.Vectors rejected by '''rejectlow_modis.F''' are flagged as in v7.0. 

The new blacklisting and bias correction functionality and the recoded low-level rejection functionality can be used jointly, in this case those vectors blacklisted by '''modis_bl_and_bc.F''' will be skipped by '''rejectlow_modis.F''' but those that were only corrected could still be rejected.


= Detailed List of Changes =

== AMV data pre-processing (OBSPROC) ==

|| '''obsproc/control/cmoctmap.F90''' || Mapping between MODIS CMA obs codes (3,91) and CMA sequence numbers (3,6) ||
|| '''obsproc/control/defmkcma.F90''' || Inizialize new switch LCD091 (.true.) for populating CMA records with MODIS data ||
|| '''obsproc/control/defrun.F90'''   || Inizialize new switch LCD091 (.false.).Apparently contradictory with previous change.[[BR]] However, one should keep in mind that obsproc.x can run in different modes [[BR]] and each mode has different default settings ||
|| '''obsproc/control/sucmaho.F90'''  || Pointers for new records in AMV's CMA optional header (note that this applies to both Polar and Geo AMVs). The extension of this header was done at a preliminary stage of the developments in an attempt to make visible to the screening scheme information that finally turned out to be not useful. Only those pieces of information in bold characters are actually used in the final processing. The new structure of this optional header part is as follows: [[BR]] ''__instrument specification__'' [[BR]]''__events__'' [[BR]] ''__cloud vector computation method__'' '''contains the vector type (see table)''' [[BR]] ''__data instrumnet used in processing__'' [[BR]]''__data processing technique used__'' [[BR]]''__data quality indicator 1__'' '''contains the first quality indicator''' [[BR]] ''__data quality indicator 2__'' contains the second quality indicator [[BR]] ''__data quality indicator 3__'' contains the third quality indicator [[BR]] ''__number of quality indicators__'' actual number of QI's (could be less than 3) [[BR]] ''__originating centre__'' 160 for NOAA-NESDIS [[BR]] ''__channel frequency__'' in microns [[BR]] ''__spatial resolution__'' in meters [[BR]] ''__satellite senith angle__'' [[BR]] ''__land-sea mask__'' provided by NOAA_NESDIS [[BR]] ''__height asignment method__'' '''contains height asignment method used (see table)''' [[BR]] ''__number of height asignments__'' number of additional height asignments kept in the next eight records[[BR]] ''__height asignment 1__'' first height asigment [[BR]] ''__height asignmnet 2__'' [[BR]] .... [[BR]] ''__height asignmnet 8__'' height asignmnet number eight ||
|| '''obsproc/control/sucmoctp.F90''' || Increase the maximum number of CMA sequence numbers from 5 to 6 in order to accomodate MODIS as (3,6) ||
|| '''obsproc/control/sulim.F90'''    || Increase the maximum possible value for satellite identifier from 500 to 800 in order to include "Terra" (sat id 783) and "Aqua" (sat id 784) ||
|| '''obsproc/make_cma/bufrtot.F90''' || Do the buffer format check less stringent so that it is possible to use the same template for Geo-AMV and Polar-AMV (the differences are irrelevant) ||
|| '''obsproc/make_cma/cmoctmap.F90''' || Introduce changes consistent with obsproc/control/cmoctmap.F90 ||
|| '''obsproc/make_cma/obscreen.F90''' || Separate Polar and Geo AMVs which are archived in MARS under the same buffer codes (5,87) to CMA observation codes (3,91) and (3,90) respectively ||
|| '''obsproc/make_cma/repsel.F90''' || Make the new switch LCD091 visible to this report selection piece of code ||
|| '''obsproc/make_cma/satamin.F90''' || The "new" buffer reading and extraction subroutine for AMVs (both Polar and Geo) ||
|| '''obsproc/make_cma/satamohd.F90''' || The "new" subroutine for populating the optional header part of the AMV CMA record (both Polar and Geo) || 
|| '''obsproc/make_cma/scanbufr.F90''' || Update the processing of some AMV buffer codes (all but 5,87 and 5,10 discarded) ||
|| '''obsproc/make_cma/sucmaho.F90''' || Introduce changes consistent with obsproc/control/sucmaho.F90 ||
|| '''obsproc/make_cma/sucmoctp.F90''' || Introduce changes consistent with obsproc/control/sucmoctp.F90 ||
|| '''obsproc/module/yomglp.F90''' || Include the new switch LCD091 in the YOMGLP module
|| '''obsproc/namelist/namglp.h''' || Include the new switch LCD091 in the namelist for the YOMGLP module ||
|| '''obsproc/obs_error/suoberr.F90''' || Asign the MODIS winds observation errors to CMA sequence numbers (3,6) ||

== AMV data transfer to/from the CMA array (HIRVDA) ==


|| '''hlcmaio/cmoctmap.F''' || Make this code consistent with obsproc/control/cmoctmap.F90 and obsproc/make_cma/cmoctmap.F90 ||
|| '''hlcmaio/setcmform.F''' || Make this code consistent with obsproc/make_cma/sucmaho.F90 ||
|| '''hlcmaio/setcmoctp.F''' || Make this code consistent with obsproc/control/sucmoctp.F90 ||
|| '''modules/modiswinddata.F90 || Expand the MODIS wind data module to accomodate the following new parameters extracted from the buffer messages. Note that the quality indicator was already accomodated in this module for v7.0 though not used in the processing. [[BR]]  ''__modiswind_ham__'' for height asignmnet method [[BR]] ''__modiswind_lsm__'' for land sea-mask [[BR]] ''__modiswind_tcm__'' for vector type ||
|| '''modules/satobdata.F90''' || Expand the SATOB wind data module to accomodate the following new parameters extracted from the Geo-AMV buffer messages. [[BR]] ''__satob_index__'' quality index value [[BR]] ''__satob_ham__'' height asignment method [[BR]] ''__satob_tcm__'' vector type [[BR]] ''__satob_lsm__'' land sea-mask ||
|| '''obsalloc/alloc_modiswind.F''' || Dynamic memory allocation of new MODIS wind data module variables ||
|| '''obsalloc/alloc_satob.F'''     || Dynamic memory allocation of new SATOB wind data module ||
|| '''obsalloc/dealloc_modiswind.F''' || Reverse operation as that in alloc_modiswind.F ||
|| '''obsalloc/dealloc_satob.F''' || Reverse operation as that in alloc_satob.F ||
|| '''cmatoobs/cmatomodiswind.F''' || New transfer from the CMA array to MODIS wind data module ||
|| '''cmatoobs/cmatoobsmod.F''' || The previous transfer to SATOB data module was, for some reason, disabled by the transfer to MODIS data module. Now both are enabled.||
|| '''cmatoobs/cmatosatob.F''' || New transfer from the CMA array to SATOB wind data module ||
|| '''cmatoobs/modiswindtocma.F''' || Reverse operation of that in cmatomodiswind.F ||
|| '''cmatoobs/obsmodtocma.F''' || To handle separately CMA observation codes (3,91) and (3,90) ||
|| '''cmatoobs/satobtocma.F''' || Reverse operation of that in cmatosatob.F ||
|| '''obsupport/print_modiswind.F''' || To print out the new parameters in the MODIS wind module ||
|| '''obsupport/print_satob.F''' || To print out the new parameters in the Geo-AMV (i.e. SATOB) wind module ||

== MODIS AMVs Data Screening (HIRVDA) ==

|| '''scrobs/scrcom_default.F''' || To initialise a new screening switch lmodiswindbl_and_bc = .false. Therefore the new blacklisting and bias correction scheme is not active by default. The rationale behind this decisition is that, of course, the scheme must be first tuned ||
|| '''scrobs/screen_modiswind.F''' || New MODIS screening. No asymmetry check and no RDB check included ||
|| '''scrobs/bl_and_bc_modis.F''' || New MODIS blacklisting and bias correction. See above for more details ||
|| '''scrobs/rejectlow_modis.F''' || Recoded software for "quick" blacklisting ||
|| '''scrobs/chkfirstguess_modis.F''' || Background check. Minor changes from previous chkfirstguess.F ||
|| '''scrobs/chk_windir_modis.F''' || Wind direction check. Minor changes from previous chkwindir.F ||
|| '''scrobs/thinning_modis.F''' || New thinning for MODIS wind data. The v7.0 thinning is based on selection of those tors closer in time to nominal analysis time. However, dense wind fields usually consist of vectors all with the same nominal time, so that the selection finally turns out to be quite arbitrary. here the logic is different. The time difference criterion is used if vectors have different observation times, but uses instead the quality index if vectors with the same observation time are compared. Note that the modisdeltax/y in scrnam must be given in grid points.The current default values are 6 ||
|| '''scrobs/collect_modis.F''' || Changes in the MPP interface to concentrate some new parameters required by the new thinning scheme ||
|| '''scrobs/distrib_modis.F''' || Changes in the MPP interface to disperse new observation event flags produced by the new thinning scheme ||
|| '''include/varpar/obsmodpar.h''' || New observation event flags for thinning and bias correction. These are as infdicated in the last table ||
|| '''include/varcom/scrcom.h''' || Include the new lmodisbl_and_bc switch in the shared memory holding different screening parameters ||
|| '''include/varcom/scrnam.h''' || Include the new lmodisbl_and_bc switch in the scrnam namelist ||

The distinction between report and datum flags for single level, single parameter observations (u and v are rejected or accepted jointly) does not make much sense. This is the rerason why the third column of the following table is redundant.

|| Description || Flags at repport level (status and event) || Flags at datum level (status and event) ||
|| Balcklisted [[BR]] (bl_and_bc_modis.F) || 8, 64 || 0 ,0 ||
|| Bias correction [[BR]] (bl_an_bc_modis.F) || 1, 1 || 0, 0 ||
|| Rejected by rejectlow_modis.F || 4, 1048576 || 0, 0 ||
|| Rejected by FGcheck [[BR]] (chkfirstgue and chkwindir_modis) || 4,2 || 4, 512 ||
|| Thinned [[BR]] (thinning_modis.F) || 4,512 (if time difference) [[BR]] 4,513 (if quality index) || 0, 0 ||
  


[[Center(begin)]]
[https://hirlam.org/trac/wiki/HirlamHowto See also the corresponding pages on HIRLAM Howto]
[[Center(end)]]

[[SubWiki]]

[[Center(begin)]]
[https://hirlam.org/trac/wiki/HirlamSystemDocumentation Back to the main page of the HIRLAM System Documentation]
[[Center(end)]]
----
[[Center(begin)]]
[[Disclaimer]]

[[Color(red, Last modified on)]] [[LastModified]]
[[Center(end)]]