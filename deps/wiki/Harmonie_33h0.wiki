[[PageOutline]]
[[Center(begin)]]
== '''HARMONIE 33h0''' ==
(Tagged on April 22, 2008)
[[Center(end)]]

== Highlights of Harmonie 33h0 ==

Harmonie 33h0 is an HARMONIE system adaptation to the IFS/ALADIN [http://www.cnrm.meteo.fr/aladin/partner/docoper/Memorandum/cy33.pdf Cycle 33 ] and [http://www.cnrm.meteo.fr/aladin/partner/docoper/Memorandum/cy33t0.pdf Cycle 33T0]. 33h0 features the preliminary script implementation for upper air and surface data assimilation components, as well as numerous enhancement of the Harmonie mini-SMS scripts, such as the introduction of full cycling structure and the dual-hosts setup on the ECMWF HPC platform.

HARMONIE is the acronym for Hirlam's meso-scale forecast system (Hirlam Aladin Regional/Meso-scale Operational NWP In Europe). The HARMONIE system is the product of the HIRLAM-ALADIN joint project HARMONIE: Hirlam-Aladin Research towards Meso-scale Operational NWP in Europe.

== Source code and script updates in Harmonie 33h0 ==

Compared to the previous tagged Harmonie release Harmonie_32h3, the new release contains   [https://hirlam.org/trac/log/trunk/harmonie?action=stop_on_copy&rev=5859&stop_rev=5655&mode=stop_on_copy many new features and modifications] in source codes, scripts and utilities, which include
 * Source code adaptation from [http://www.cnrm.meteo.fr/aladin/partner/docoper/Memorandum/cy33.pdf Cycle 33 ] and [http://www.cnrm.meteo.fr/aladin/partner/docoper/Memorandum/cy33t0.pdf Cycle 33T0 ](Andrae)
   * changeset [5731]
 * script implementation for Upper air and surface data assimilation 
   * Source code modification and scripts and mSMS adaptation for running 3D-VAR upper air analysis and CANARI surface analysis, (Storto, Randriamampianina, Andrae, Yang)
     * changeset [5677], [5768], [5771], [5772], [5832]
   * inclusion of observation data pre-processor OULAN (Andrae [5683])
 * mini-SMS script extension and enhancement for cycling including build, time stepping, observation data pre-processing, boundary data preparation, assimilation, forecast, verification and post-processing and archiving etc. (Andrae, Yang, Niemela, Vignes)
   * changeset [5659], [5667-5668], [5681], [5682], [5691], [5656],  [5680], [5708], [5716], [5720], [5722], [5724], [5767], [5774], [5799], [5800-5801], [5826], [5840-5846], [5848-5849], [5851-5852], [5855-5858]   
 * dual-hosts configuration to enable launch of mini-SMS job and part of verification and monitoring processing on ecgate at the ECMWF HPC (Vignes, [5763], Andrae [5835])
 * modification on default experiment configuration (Andrae, Yang, Niemela)
   * changeset [5786], [5788], [5801], [5828-5830], [5855], [5856], [5861]
 * enhancement of data conversion, interpolation and extraction tool (GL)
   * enhanced model data extraction algorithm ( Andrae, Yang, Niemela [5662], [5734], [5754], [5790])
   * update on WMO station-list (Yang [5690]
 * enhancement of interpolation algorithm in GL
   * support for polar stereographic projection (Andrae [5675-5676], [5679], [5713-5714], [5720])
   * interpolation to height level (Andrae [5789])
   * enhanced interpolation algorithm and functionalities (Andrae, [5684], [5739], [5824])
   * calculation of MSLP, total precipitation (Storto [5688], Bengtsson [5729] )
 * enhancement of monitoring utility and graphic tool WebgraF
   * Observation verification statistics (Andrae, Yang, Rontu)
     * changeset [5666], [5735-5740], [5742], [5756], [5824], [5825], [5791], [5809]
   * verification of mast-profile (Andrae [5793], [5794], [5796])
   * Web presentation (Andrae [5663], [5784])
 * update on forecast scripts, namelists (Niemela, Andrae, Bengtsson)
   * changeset [5722], [5724], [5761], [5768], [5773], [5787], [5788], [5797]
 * update in coupling algorithm (Storto [5658],
 * source code adaptation and bug fixes (Andrae, Wilhelmsson, Mckinstry) 
   * Changset [5673], [5686], [5730], [5732-5733], [5743], [5748], [5771], [5773], [5776-5780], [5833]
 * domain and platform-specific configurations (Andrae,Niemela,GutiÃ©rrez-Marco,Yang)  
   * Changset [5681], [5685], [5775], [5782], [5828], [5829], [5830], [5859])

== Harmonie-32h3 source code downloads ==

 * On ECMWF, the check-out version of the harmonie-33h0 is available on,
{{{
   ecgate:/home/ms/dk/nhz/harmonie_release/33h0  # on ecgate
   hpce:/ms_perm/hirlam/harmonie_release/33h0    # on hpce
}}}
 * harmonie-33h0 release can also be obtained via Subversion command, (At ECMWF, the svn client is available on ecgate but not on HPCE)
{{{
   svn co https://svn.hirlam.org/tags/harmonie-33h0
}}}
 * The export tarball of the harmonie-33h0 is available on ECMWF:ecgate as /scratch/ms/dk/nhz/harmonie-33h0.tar.gz, or on ECFS: ec:/hirlam/src/tar/harmonie-33h0.tar.gz

== New features and functionalities with Harmonie-33h0 ==

=== Default experiment configuration and available alternatives ===

Harmonie experiments are configured via various settings defined by environmental variables, name-list etc. which are grouped under various script directories such as
{{{
   config-sh, mainly config.$COMPUTER             # platform-specific settings
   config, mainly config.$ARCH                    # platform and compiler-specific settings
   sms, mainly config_exp.h                       # specifications about model, domain, cycling, data etc.
   nam                                            # name-lists for model features and coupling
}}}

The configuration file in [source:tags/harmonie-33h0/sms/config_exp.h sms/config_exp.h] provides default values for various basic experiment settings concerning
 * general paths (source, data, archive)
 * definition of ROOTPACK (model versions etc.)
 * domain, resolution
 * data (climate, observation and verification, coupling)
 * model components (data assimilation, initialisation, forecast, post-processing, verification)

Up till now we have not arrived to a reference Harmonie configuration as is the case with RCR in the synoptic Hirlam. Presently, the main characteristics of the 'default' values as defined in config_exp.h includes:
 * A 50*50*40 test domain at 11 km resolution (TEST_11), which can be switched to other domains like
   * 11 km domain NORWAY_POLAR, NORWAY, SCANDINAVIA, MEDITERRANEAN
   * 5.5 km domain SWEDEN_5.5
   * 2.5 km domain TEST_2.5, SWEDNE_NORTH, SWEDEN-SOUTH, DENMARK, FINLAND_SOUTH, ICELAND, IBERIA
 * Hydrostatic, ALADIN physics, compiled with AROMODB which allows switches for 
   * AROME, ALADIN, ALARO and HIRALD physics
   * nonhydrostatic or hydrostatic dynamics
 * Coupling data from ECMWF IFS archive, switchable to
   * RCR archive (hir)
   * Existing/local nesting ALADIN run (ald)
 * No data assimilation, switchable to
   * 3DVAR upper air analysis, (currently only tested for NORWAY domain. The extension to other domain without corresponding B-matrix derived from same model domain is currently impossible)
   * CANARI surface analysis (needs additional modifications to work, such as changeset [5890], [5891])

=== Configure and Launch Harmonie experiments from ECMWF-ecgate ===

With 33h0, the reference Harmonie system on ECMWF platform assumes dual-hosts setup, resembling now more the traditional settings for the synoptic Hirlam using mini-SMS. By default, the mSMS script uses the front-end ecgate to configure and launch experiments, whereas HPCE is used for all computations except those for operations related to observation verification and monitoring. 

As in the previous versions, the reference ROOTPACK for 33h0 has been pre-built and available on ECMWF HPCE computer, under /ms_perm/hirlam/harmonie/pack/

Following example shows the steps to launch an Harmonie-33h0 experiment H33H0 on ECMWF platform:

 1. Create an experiment directory under $HOME/hm_home and run the setup
{{{
   mkdir -p $HOME/hm_home/H33H0; cd $HOME/hm_home/H33H0
   PATH_TO_HARMONIE33h0/config-sh/Harmonie setup -r PATH_TO_HARMONIE_33h0 -h YOURHOST   
                                    # e.g., ~nhz/Harmonie setup -r ~nhz/harmonie_release/33h0
}}}
 1. If applicable, put your local source or script changes, which are different but consistent with the reference version as installed in the ROOTPACK, into the current $HOME/hm_home/H33H0 directory, with exactly the same subdirectory structure as in the reference. e.g, if you want to modify a subroutine 
{{{
   cd $HOME/hm_home/H33H0; mkdir -p src/arp/setup/src/arp/setup
   cp ~nhz/harmonie_release/33h0/src/arp/setup/src/arp/setup/suphy.F90 src/arp/setup/src/arp/setup  # retrieve default source code
   vi src/arp/setup/src/arp/setup/suphy.F90                                                         # modify the source code
}}}
 1. Edit basic configuration files such as [source:tags/harmonie-33h0/config-sh/config.hpce Env_system -> config-sh/config.YOURHOST] and [source:tags/harmonie-33h0/sms/config_exp.h sms/config_exp.h] to configure your experiment scenarios. Modify specifications for model versions (ALADIN, AROME, ALARO), data locations, settings for dynamics, physics, domain, coupling host model etc. e.g, 
{{{
   ~nhz/Harmonie co scr/RunCanari         # retrieve default script RunCanari
   vi scr/RunCanari                       # modify the script
}}}
 1. Launch the experiment
{{{
      PATH_TO_HARMONIE/config-sh/Harmonie start DTG=YYYYMMDDHH DTGEND=YYYYMMDDHH
                                    # e.g., ~nhz/Harmonie start DTG=2008030500 DTGEND=2008030506 LL=12
}}}
If successful, mSMS will identify your experiment name, launch mXcdp and start build and run. If not, you need to examine the mSMS log file $HM_DATA/mSMS.log. $HM_DATA is defined in your Env_system file

On ecgate, you can follow the progress of the runs on $SCRATCH/hm_home/H33H0. More complete results data are available on HPCE:$TEMP
under $HM_DATA: $TEMP/hm_home/H33H0. Under this directory you will find:

   * All binaries under lib/ibmecmwf/bin
   * Model libraries, object files and source code under lib/gmkpack_build
   * Scripts, config files, sms and msms definitions under lib/
   * Utilities such as gmkpack, gl and verification under lib/util
   * Climate files under climate
   * Archived files under archive
   * Working directory for the current cycle under YYYYMMDD_HH
   * Verification working directory on ecgate:$SCRATCH/hm_home/$EXP/lib/util/monitor.
   * Log files under H33H0. All logfiles are also archived in archive

=== Making 3DVAR experiment ===

=== Performing model inter-comparison using Harmonie verification tools ===

For comparison between HIRLAM and HARMONIE experiments it is now possible to extract verification files from your HIRLAM experiment
[source:trunk/hirlam/scripts/VER_create_fld VER_create_fld]. Read more on how to use the 
[source:tags/harmonie-33h0/util/monitor/doc verification].

See also previous documentations on 
 * HARMONIE ROOTPACK and reference installation on ECMWF-HPCE 

 * Build HARMONIE ROOTPACK on non-ECMWF platform 

== Technical aspects with 33h0 ==

=== Tested model domains, components and computer architecture ===

||model domain ||computer platform||reporting tester(s) ||tested configurations || additional information ||

|| TEST_11 || HPCE || Trygve Aspelien, Xiaohua Yang || forecast_only[[FootNote(modification in Env_submit needed to reduce requested nr of tasks and/or nodes, e.g., 2 nodes with 2 tasks)]] || ||
|| SCANDINAVIA || HPCE || Xiaohua Yang || forecast_only || ||
|| IBERIA || HPCE || Maria Diez || forecast_only[[FootNote(with modifications similar to trunk [5890] for config_exp.h to correct domain definition)]]|| ||
|| NORWAY || HPCE || Xiaohua Yang, Ulf Andrae, Sami Niemela || 3DVAR, forecast_only[[FootNote(with ALADIN, ALARO, AROME physics)]], 3DVAR, Canari[[FootNote(with modifications similar to trunk [5890], [5891] )]]|| Using the B-statistics derived from same domain ||
|| RCR_POLAR || HPCE || Magnus Lindskog, Xiaohua Yang || forecast_only, 3DVAR and 3DVAR+Canari[[FootNote(need additional modifications sinilar to [5874], [5877], and Env_submit needed to increase requested nr of tasks and/or nodes, e.g., 5 nodes with 8 tasks; additionally increased memory request to 5 GB  per task for scalar job and 2 GB for parallel batch jobs)]] || RCR-equivalent domain with polarstereographic projection; own B-statistics||

 [[FootNote]]

== Acknowledgement ==

Andrea Storto and Roger Randriamampianina are acknowledged for their pioneering work on data assimilation-related scripts at the ECMWF-HPC platform. Ulf Andrae adopted the scripts to the Harmonie mini-SMS framework, with contributions from Ole Vignes and Xiaohua Yang. Ulf Andrae, Sami Niemela, Tomas Wilhelmsson, Ole Vignes, Xiaohua Yang et al contributed to the other parts of the system components for Harmonie-33h0.

== References and documentation ==
 * Meteo France Memorandum on [http://www.cnrm.meteo.fr/aladin/partner/docoper/Memorandum/cy33.pdf Cycle 33 ],available on MF's restricted-access page
 * Meteo France Memorandum on [http://www.cnrm.meteo.fr/aladin/partner/docoper/Memorandum/cy33t0.pdf Cycle 33T0 ],available on MF's restricted-access page
 * Kert'esz, S., 2001: [http://www.cnrm.meteo.fr/gmapdoc/spip.php?article64 A short overview of ODB]
 * Puech, D., 2006: Documentation technique sur ODB. compilation of internal notes (generally in French) 
 * Kert'esz, S., 2002: Using ODB in ALADIN. Internal note, 21pp, available on "http://www.cnrm.meteo.fr/gmapdoc/" (topics "ODB")
 [http://www.cnrm.meteo.fr/gmapdoc/spip.php?rubrique1 General ALADIN/Arome documentation link]

----
[[Center(begin)]]
[[Color(red, Last modified on)]] [[LastModified]]
[[Center(end)]]''
