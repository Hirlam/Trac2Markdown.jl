[[PageOutline]]
[[Center(begin)]]
= '''Phasing information for Cycle 41''' =
[[Center(end)]]


= Cycle Master =

Cycle Master: Toon Moene.

= Base Version, Deadlines for Contributions =

Base line: CY41_bf.01.

Deadline of HIRLAM contributions: December 1st, 2014.

Deadline for the latest contributions: January 15th, 2015 (CY41_t1.03).

= Initial main contributions from HIRLAM =

Done during December, 1st:

Initial contribution: branch phasing/cy41_send1_main (Prepared by Ulf Andrae).

[13650] branches/phasing/cy41_send1_main (copied from branches/phasing/cy41/src).

== Description ==

{{{
HIRLAM contributions for CY41T1
All changes are based on CY41_bf.01


Ulf Andrae
Rename/move files with wrong name or wrong location
ifsaux/programs/lfi_alt_remv.F90 to ifsaux/misc/lfi_alt_remv.F90
utilities/bcov_lam/programs/stat.F90 to utilities/bcov_lam/programs/festat.F90
surfex/OFFLIN/soda.F90 to mse/programs/soda.F90

Ulf Andrae: 
Remove duplicated file
surfex/OFFLIN/pgd.F90

Rimvudas Jasinskas:
Add surfex file to enable netcdf (-DNC) compilations.
surfex/OFFLIN/close_namelist_nc.F90 

Roger Randriamampianina:
Introduction of observation perturbation:
Observation perturbations
odb/ddl.CCMA/pertcma.sql
odb/ddl.ECMA/pertcma.sql
odb/ddl/pertcma.sql
odb/tools/Pertcma.F90


Mariano Hortal:
Correct uninitialized value
aladin/c9xx/ebicli.F90

Ulf Andrae:
LAM FEMARS changes
Enable creating forecast differences with NAMVAR/LFEMARS=T. In case of Q in gridpoint space set NEMCT0/L_GPQ_DIFF=T
arpifs/control/cnt3.F90
aladin/setup/suect0.F90
arpifs/ald_inc/namelist/nemct0.nam.h
arpifs/module/yemct0.F90
arpifs/module/yomvar.F90
arpifs/namelist/namvar.nam.h
arpifs/setup/suctrl_gflattr.F90
arpifs/var/suvar.F90

Ulf Andrae:
Correct order of declaration of variables to minimize compile time warnings
algor/internal/fourier/qpassf.F
algor/internal/fourier/rpassf.F
arpifs/canari/caspia.F90
arpifs/fullpos/fpsampl.F90
arpifs/module/varbc_airep.F90
arpifs/module/varbc_pred.F90
arpifs/module/varbc_rad.F90
arpifs/module/varbc_sfcobs.F90
arpifs/module/varbc_tcwv.F90
arpifs/module/varbc_to3.F90
arpifs/obs_preproc/radar_profs.F90
ifsaux/support/isrcheq.F
ifsaux/support/isrchfltpv.F
ifsaux/support/qsorti4.F
mse/new/sfxlfi2fa.F90
odb/module/binterpol.F90
odb/module/odb1.F90
odb/pandor/fcq/man_orders.F90
satrad/bias/getbccoef.F90
surf/module/tridag_mod.F90
surfex/ASSIM/oi_latlon_conf_proj.F90
surfex/SURFEX/coupling_seawat_sbln.F90
utilities/bcov_lam/others/sbdiacov.F90
utilities/ctpini/module/fonctions_donnees.F90

Maria Derkova:
Correct location of call to final DR_HOOK
algor/internal/minim/mlis0r.F


Laura Rontu, Kristian Pagh Nielsen, Emily Gleeson:
- Add output of SW radiation of diagnostics
arpifs/adiab/cpg.F90
arpifs/adiab/cpg_dia.F90
arpifs/dia/cpcfu.F90
arpifs/fullpos/hpos.F90
arpifs/fullpos/sufpcfu.F90
arpifs/fullpos/sufptr2.F90
arpifs/module/parfpos.F90
arpifs/module/ptrgfu.F90
arpifs/module/yoerad.F90
arpifs/module/yoesw.F90
arpifs/module/yomafn.F90
arpifs/namelist/naerad.nam.h
arpifs/phys_dmn/apl_arome.F90
arpifs/phys_dmn/aplpar.F90
arpifs/phys_dmn/mf_phys.F90
arpifs/phys_dmn/surdi15.F90
arpifs/phys_ec/callparad.F90
arpifs/phys_ec/radheat.F90
arpifs/phys_ec/radlsw.F90
arpifs/phys_ec/suclopn.F90
arpifs/phys_radi/suecrad.F90
arpifs/phys_radi/sw.F90
arpifs/phys_radi/sw1s.F90
arpifs/phys_radi/swni.F90
arpifs/setup/suafn1.F90
arpifs/setup/suafn2.F90
arpifs/setup/suafn3.F90
arpifs/setup/sucfu.F90

Ulf Andrae
Correct intent in variable declaration to minimize compile time warnings
arpifs/adiab/laconead.F90
arpifs/op_obs/kernel_pbp_ad.F90
arpifs/phys_dmn/acconvsad.F90
arpifs/phys_dmn/aclspsad.F90
arpifs/phys_dmn/acnebsmad.F90
arpifs/phys_dmn/acnuagesad.F90
arpifs/phys_ec/cloud_layer.F90
arpifs/phys_ec/convection_layer.F90
arpifs/phys_ec/convection_s_layer.F90
arpifs/phys_ec/sltend_layer.F90
arpifs/phys_ec/turbulence_layer.F90
arpifs/prism/couplo4_inimpi.F90
arpifs/var/jbtomodelad.F90
etrans/module/euvtvd_comm_mod.F90
etrans/module/euvtvd_mod.F90
etrans/module/suemplatb_mod.F90
mse/internals/write_surft1_aro.F90
odb/pandor/extrtovs/extr_lib_1c.F90
surf/module/ocean_ml_driver_v2_mod.F90
surf/module/srfsn_rsn_mod.F90
surfex/SURFEX/bem.F90
surfex/SURFEX/default_teb_veg.F90
surfex/SURFEX/init_from_data_greenroofn.F90
surfex/SURFEX/init_veg_gardenn.F90
surfex/SURFEX/init_veg_pgd_gardenn.F90
surfex/SURFEX/init_veg_pgdn.F90
surfex/SURFEX/mode_sltmbl.F90
surfex/SURFEX/mode_splines.F90
surfex/SURFEX/mode_write_surf_fa.F90
surfex/SURFEX/prep_hor_snow_fields.F90
surfex/SURFEX/read_gridtype_cartesian.F90
surfex/SURFEX/snowcro.F90
surfex/SURFEX/teb_morpho.F90

Mariken Holmleid:
Correct check on missing values in case of LECSST=T in CANARI
arpifs/canari/caclsst.F90

Trygve Aspelien:
Include call to SODA from CANARI
Changes for EKF under SODA
arpifs/canari/canali.F90
arpifs/module/qactex.F90
arpifs/namelist/nactex.nam.h
arpifs/utility/openfa.F90
arpifs/utility/openfainfo.F90
mse/externals/aroini_surfa.F90
mse/externals/aroini_surfc.F90
mse/externals/canari_sx_ics.F90
mse/externals/deallmse.F90
mse/externals/sugridsfx.F90
mse/externals/suphmse_surface.F90
mse/interface/aroini_surfa.h
mse/interface/sugridsfx.h
mse/internals/fminit.F90
mse/programs/driver_off_omp.F90
mse/programs/prep.F90

Sami Saarinen:
Use ec_getenv rather than getenv
arpifs/canari/canari.F90
arpifs/canari/casgra.F90
arpifs/obs_preproc/hatbiasc.F90
arpifs/obs_preproc/readoba.F90
arpifs/obs_preproc/sudimo.F90
arpifs/obs_preproc/tempin.F90
arpifs/var/writeoba.F90


Ulf Andrae:
Correct kind declaration of constant
arpifs/chem/tm5_chem_ini.F90
arpifs/phys_ec/vdfmain.F90

Lisa Bengtsson:
Updates to Cellular automata
arpifs/control/cuconvca.F90
arpifs/module/yoe_cuconvca.F90
arpifs/module/yomphy0.F90
arpifs/namelist/namphy0.nam.h
arpifs/phys_dmn/accvud.F90
arpifs/phys_dmn/suphy0.F90


Magnus Lindskog:
GNSS varbc handling
arpifs/module/varbc_sfcobs.F90
arpifs/obs_preproc/black.F90
arpifs/op_obs/hop.F90
arpifs/op_obs/hopad.F90
arpifs/op_obs/hoptl.F90
arpifs/utility/prtjo.F90
odb/ddl/getsfcobsid.sql
odb/ddl/varbc_sfcobs_robhdr.sql

Ulf Andrae:
Lower JPFORC to fit with FA name conventions/grib 
arpifs/module/yom_ygfl.F90

Karl-Ivar Ivarsson:
Mixed phase cloud parametrisation
arpifs/module/yomparar.F90
arpifs/namelist/namparar.nam.h
arpifs/phys_dmn/suparar.F90
mpa/micro/externals/aro_adjust.F90
mpa/micro/externals/aro_rain_ice.F90
mpa/micro/interface/aro_adjust.h
mpa/micro/interface/aro_rain_ice.h
mpa/micro/internals/condensation.F90
mpa/micro/internals/ice_adjust.F90
mpa/micro/internals/ini_cst.F90
mpa/micro/internals/ini_rain_ice.F90
mpa/micro/internals/rain_ice.F90
mpa/micro/module/modd_cst.F90
mpa/micro/module/modi_condensation.F90
mpa/micro/module/modi_ice_adjust.F90
mpa/micro/module/modi_rain_ice.F90

NN
Corrections to run alaro with SURFEX
arpifs/phys_dmn/aplpar.F90
arpifs/phys_dmn/initaplpar.F90
mse/externals/aro_ground_diag.F90
mse/interface/aro_ground_diag.h
surfex/SURFEX/get_fluxn.F90
surfex/SURFEX/get_surf_varn.F90

Ulf Andrae
Correct IVDEP directive locations 
arpifs/phys_ec/cuadjtq.F90
arpifs/phys_ec/cubasmcn.F90
arpifs/phys_ec/cuflxn.F90
arpifs/phys_ec/cumastrn.F90
etrans/module/eprfi2b_mod.F90
trans/module/updspbad_mod.F90

Ulf Andrae:
Correct erroneous format statement
arpifs/setup/suvert.F90
odb/extras/emos/bugbts.F

Sami Saarinen:
Corrected memory diagnostics
arpifs/utility/opdis.F90
ifsaux/utilities/gethwm.c
ifsaux/utilities/getrss.c
ifsaux/utilities/getstackusage.c
ifsaux/utilities/getstk.c

Sami Saarinen, Trygve Aspelien:
Increase max length of line and correct possible "Buffer overflow" problem in blacklist compiler when line was too long.
blacklist/compiler/generate.c
blacklist/include/defs.h

Sami Saarinen:
Dr Hook updates
ifsaux/include/drhook.h
ifsaux/module/dr_hook_watch_mod.F90
ifsaux/support/dr_hook_prt.F90
ifsaux/support/drhook.c
ifsaux/utilities/linuxtrbk.c

Ulf Andrae:
Remove SAMIO leftovers
ifsaux/lfi/lfiecc.F90
ifsaux/lfi/lfiedo.F90
ifsaux/lfi/lfilcc.F90
ifsaux/lfi/lfildo.F90

Ole Vignes:
Less verbose output
ifsaux/misc/facat.F90
mse/internals/fmlook.F90

Trygve Aspelien:
Correct string length for HREC argument
mse/internals/error_read.F90
mse/internals/error_write.F90
mse/internals/fmreadt0.F90
mse/internals/fmwritt0.F90
mse/internals/old_ndim.F90
mse/internals/read_in_lfi_x2.F90
mse/internals/read_in_lfi_x3.F90
mse/internals/read_surfc0_aro.F90
mse/internals/read_surfl0_aro.F90
mse/internals/read_surfl1_aro.F90
mse/internals/read_surfn0_aro.F90
mse/internals/read_surfn1_aro.F90
mse/internals/read_surft0_aro.F90
mse/internals/read_surft1_aro.F90
mse/internals/read_surfx0_aro.F90
mse/internals/read_surfx1_aro.F90
mse/internals/read_surfx2_aro.F90
mse/internals/write_in_lfi_x1.F90
mse/internals/write_in_lfi_x2.F90
mse/internals/write_in_lfi_x3.F90
mse/internals/write_surft0_aro.F90

Sami Saarinen
ODB updates
odb/aux/curses.c
odb/aux/generic.c
odb/aux/memory.c
odb/aux/newio.c
odb/aux/odb2mysql.c
odb/aux/odbi_direct.c
odb/aux/qtar_sub.c
odb/aux/result.c
odb/aux/upcma.c
odb/cma2odb/create_averaged_values.F90
odb/cma2odb/shuffle_odb.F90
odb/compiler/memory.c
odb/compiler/odb_macros.h
odb/ddl/odb_macros.h
odb/extras/mpi_serial/cmpi.c
odb/extras/mpi_serial/mpi_buffer_attach.F
odb/include/odb_macros.h
odb/lib/evaluate.c
odb/lib/funcs.c
odb/lib/inside.c
odb/lib/symtab.c
odb/lib/vecloops.c
odb/module/odbshared.F90
odb/tools/b4.c
odb/tools/odbi_direct_main.c

Eoin Whelan:
Changes to allow ODB1 to ODB2 conversion
odb/scripts/dcagen

Ulf Andrae: 
Extrapolation in prep and OI_main. Add NDIM_EXTRAP to allow different search radius
surfex/ASSIM/oi_hor_extrapol_surf.F90
surfex/SURFEX/default_prep_isba.F90
surfex/SURFEX/modd_prep_isba.F90
surfex/SURFEX/modn_prep_isba.F90
surfex/SURFEX/prep_isba_buffer.F90
surfex/SURFEX/prep_snow_buffer.F90

Ulf Andrae:
Change where statement to loop to avoid use of undefined variables
surfex/SURFEX/mode_read_extern.F90

Ulf Andrae:
Correct generic interface
surfex/OFFLIN/mode_read_surf_ol.F90

Sami Saarinen
Add back missing OpenMP
surfex/SURFEX/av_pgd.F90

Jakob Sueld & Trygve Aspelien:
Import needed change from later SURFEX version to be able to run PREP from one LFI file to another. Needed when input and output domain sizes are not equal.
surfex/SURFEX/prep_snow_extern.F90

Jana Sanches Arriola:
Adaptation of GNSS preprocessing
utilities/pregpssol/filter_gpssol.F90
utilities/pregpssol/pregpssol.F90
utilities/pregpssol/read_obsoul_gpssol.F90
utilities/pregpssol/write_obsoul_gpssol.F90
}}}

== Commit into Meteo France´s git repository ==

Commands to enter the contribution as a git branch (to be performed on merou):

{{{
cd ~/hirlam_sends                                                                  # Working directory
svn export https://svn.hirlam.org/branches/phasing/cy41_send1_main                 # Export the branch with changes
cd ~/git-dev/arpifs/                                                               # Move over to the local git repo
git_branch -r 41 -b bf -v 01 -u bf.01_hirlam                                       # Create the branch
git branch                                                                         # Check it's the active one
(cd ~/hirlam_sends; diff -r cy41_send1_main/ ~/git-dev/arpifs/ > diffs.txt)        # Create a diff between us & them
(cd ~/hirlam_sends; diff -w -r cy41_send1_main/ ~/git-dev/arpifs/ > diffs-w.txt)   # Create a don't-care-whitespace diff
(cd ~/hirlam_sends; grep ^diff diffs-w.txt > cp.txt)                               # Create a file to contain the copy commands
vi ~/hirlam_sends/cp.txt                                                           # (Watch for any new files: "Seulement dans ~/hirlam_sends..."
                                                                                   #    ... some are nieuw, some are files to be moved to a new location)
sh ~/hirlam_sends/cp.txt                                                           # Execute it
cp ~/hirlam_sends/cp.txt ~/hirlam_sends/add.txt                                    # Create a file to
vi ~/hirlam_sends/add.txt                                                          #   contain the 'git add' commands
git status                                                                         # Check if the result makes sense
sh ~/hirlam_sends/add.txt                                                          # 'git add' all of them
git commit --dry-run                                                               # See what the commit would look like
git commit -m "Initial commit of HIRLAM B contributions to Cycle 41"               # Just Do It
git_post                                                                           # To conclude, post it
}}}

= Initial contribution of Mariano Hortal´s dynamics changes =

Mariano Hortal's Dynamics changes are sent in a separate branch (Prepared by Ulf Andrae):

[13674] branches/phasing/cy41_send1_dyn (copied from vendor/aladin/current)

== Description ==

{{{
Mariano Hortal:
Corrections for LUNBC and LGRADSP
    aladin/adiab/espfilt.F90
    aladin/control/espcm.F90
    aladin/coupling/ecoupl1.F90
    aladin/coupling/elswa3.F90
    aladin/setup/suehdf.F90
    aladin/setup/sueldynb.F90
    aladin/transform/etransinv_mdl.F90
    arpifs/module/yomdyna.F90
    arpifs/setup/su0yomb.F90
    etrans/external/etrans_end.F90
}}}

== Commit into Meteo France´s git repository ==

Commands to enter the contribution as a git branch (to be performed on merou):

{{{
mkdir hirlam_sends2                                                               # Make a new working directory
cd hirlam_sends2                                                                  # Go there
svn export https://svn.hirlam.org/branches/phasing/cy41_send1_dyn                 # Export the subversion branch
cd ~/git-dev/arpifs/                                                              # Go to the git repository
git_branch -r 41 -b bf -v 01 -u bf.01_hirlam_dyn                                  # Create the git branch for our changes
git branch                                                                        # Check it's the current one
(cd ~/hirlam_sends2; diff -r cy41_send1_dyn/ ~/git-dev/arpifs/ > diffs.txt)       # Create and
less ~/hirlam_sends2/diffs.txt                                                    #    check the differences to add
(cd ~/hirlam_sends2; diff -w -r cy41_send1_dyn/ ~/git-dev/arpifs/ > diffs-w.txt)  # Differences minus white space trivialities
(cd ~/hirlam_sends2; grep ^diff diffs-w.txt > cp.txt)                             # Create a list of files to copy
view ~/hirlam_sends2/diffs-w.txt                                                  # Add the single new file to that list
vi ~/hirlam_sends2/cp.txt                                                         # Change 'diff' to 'cp'
sh ~/hirlam_sends2/cp.txt                                                         # Execute the resulting list of commands
cp ~/hirlam_sends2/cp.txt ~/hirlam_sends2/add.txt                                 # Next, use this list
vi ~/hirlam_sends2/add.txt                                                        #    to create a list of 'git add' commands
git status                                                                        # Check whether it still makes sense
sh ~/hirlam_sends2/add.txt                                                        # Execute 'git add' commands
git commit --dry-run                                                              # See if the commit would make sense
git commit -m "Mariano Hortal: Corrections for LUNBC and LGRADSP"                 # Then, Just Do It
git_post                                                                          # Finally, post the results
}}}

On Tuesday, 9th of December, I redid all of this, but now with a branches/phasing/cy41_send1_dyn branch based on CY41_bf.01.

After a lengthy review process, this contribution was rejected as is, but a renewed attempt at the LGRADSP changes was allowed (see below).

= Building/testing CY41_bf.01 with the main HIRLAM contributions =

Done during December 10-12 (several iterations):

Building the main HIRLAM-B contributions branch on beaufix:

== Get the branch ==

On merou, perform the following:
{{{
cd git-dev/arpifs/                        # Go to the git repository
git fetch                                 # Update to the latest content
git checkout moene_CY41_bf.01_hirlam      # Switch to the contributions branch
git branch                                # Check that we got the right one
tar zcvf ~/moene_CY41_bf.01_hirlam.tgz .  # Tar the contents
}}}

== Build the executable ==

Then, on beaufix:
{{{
ftp merou                       # Fetch
<login>                         #  the
bin                             #    contributions
get moene_CY41_bf.01_hirlam.tgz #      branch
quit                            #        tar file
#
# Then, create the gmkpack environment:
#
(export PATH=$PATH:/home/gmap/mrpm/khatib/public/bin/gmkpack.6.6.0/util; gmkpack -r 41 -b bf -v 01 -a -l IMPI411IFC1301 -o 2x -p masterodb)
#
# Go to the source location ...
#
cd pack/41_bf.01.IMPI411IFC1301.2x/src/local
#
#   ... and unpack the contributions branch
#
tar zxvf ~/moene_CY41_bf.01_hirlam.tgz
#
# Remove the projects we do not deal with yet:
#
rm -rf cope obstat oops scat scripts
#
# Back up
#
cd ../..
#
# Execute the build script
#
(export PATH=$PATH:/home/gmap/mrpm/khatib/public/bin/gmkpack.6.6.0/util; ./ics_masterodb)
}}}

On the 12th of December (after 3 updates of the branch, due to several misunderstandings about git´s workings) this lead to a working executable MASTERODB.

== Test the resulting executable with mitraillette ==

On the 13th of December, I was able to run mitraillette with the resulting executable:
{{{
I set up my own mitraillette on beaufix by copying Karim´s in:

/home/gmap/mrpm/yessadk/mitraille

The only adaptation I made was not to use $HOME/SAVE directory (but $HOME).

I did use the input data in

/home/gmap/mrpm/yessadk/SAVE/anal_a_mitraille

and others as in Karim´s scripts.

Mitraillette command, with the second executable name in the PRO_FILE pointing to the one produced by my gmkpack build of the moene_CY41_bf.01_hirlam branch):

./mitraillette_v122014.x CY41N PRO_FILE.cy41n_aldmultiref multi
./test.x0003

Most tests completed normally.  Those having problems:

OAH4T014.o24400663:*** glibc detected *** ./ALDEXE: corrupted double-linked list: 0x000000002e5d63b0 ***
OAH5E010.o24400583:*** glibc detected *** ./ALDEXE: double free or corruption (out): 0x000000002fbafa00 ***
OAH6E016.o24400703:*** glibc detected *** ./ALDEXE: corrupted double-linked list: 0x000000002e1bc000 ***
OAH6T017.o24400716:*** glibc detected *** ./ALDEXE: corrupted double-linked list: 0x000000002ea642c0 ***
OAH6T018.o24400740:*** glibc detected *** ./ALDEXE: corrupted double-linked list: 0x000000002e0de6c0 ***

Usually this means that an allocatable array is either not allocated when written or written beyond its bounds.

Segmentation faults (all in the same spot, so probably all due to the same cause):

AH4E013:

forrtl: severe (174): SIGSEGV, segmentation fault occurred
Image              PC                Routine            Line        Source            
ALDEXE             00000000010CCBE0  copy_spec2spa_            166  copy_spec2spa.F90
ALDEXE             0000000000C87E33  traj_main_mod_mp_         627  traj_main_mod.F90
ALDEXE             0000000000971A39  cnt4tl_                   452  cnt4tl.F90
ALDEXE             0000000000915FC3  cnt3tl_                    81  cnt3tl.F90
ALDEXE             0000000000C4D455  tesadj_                   241  tesadj.F90
ALDEXE             00000000006BBC5F  cad1_                      69  cad1.F90
ALDEXE             00000000005EF7D0  cnt0_                     197  cnt0.F90
ALDEXE             00000000005EF107  MAIN__                     76  master.F90
ALDEXE             00000000005EEE9C  Unknown               Unknown  Unknown
libc.so.6          00002B8FD95F7CDD  Unknown               Unknown  Unknown
ALDEXE             00000000005EED99  Unknown               Unknown  Unknown

AH4T015:

forrtl: severe (174): SIGSEGV, segmentation fault occurred
Image              PC                Routine            Line        Source            
ALDEXE             00000000010CCBE0  copy_spec2spa_            166  copy_spec2spa.F90
ALDEXE             0000000000C87E33  traj_main_mod_mp_         627  traj_main_mod.F90
ALDEXE             0000000000971A39  cnt4tl_                   452  cnt4tl.F90
ALDEXE             0000000000915FC3  cnt3tl_                    81  cnt3tl.F90
ALDEXE             0000000000C4D455  tesadj_                   241  tesadj.F90
ALDEXE             00000000006BBC5F  cad1_                      69  cad1.F90
ALDEXE             00000000005EF7D0  cnt0_                     197  cnt0.F90
ALDEXE             00000000005EF107  MAIN__                     76  master.F90
ALDEXE             00000000005EEE9C  Unknown               Unknown  Unknown
libc.so.6          00002AF85FA14CDD  Unknown               Unknown  Unknown
ALDEXE             00000000005EED99  Unknown               Unknown  Unknown

AH5T011:

forrtl: severe (174): SIGSEGV, segmentation fault occurred
Image              PC                Routine            Line        Source            
ALDEXE             00000000010CCBE0  copy_spec2spa_            166  copy_spec2spa.F90
ALDEXE             0000000000C87E33  traj_main_mod_mp_         627  traj_main_mod.F90
ALDEXE             0000000000971A39  cnt4tl_                   452  cnt4tl.F90
ALDEXE             0000000000915FC3  cnt3tl_                    81  cnt3tl.F90
ALDEXE             0000000000842E06  testli_                   255  testli.F90
ALDEXE             00000000006237FA  ctl1_                      81  ctl1.F90
ALDEXE             00000000005EF75D  cnt0_                     203  cnt0.F90
ALDEXE             00000000005EF107  MAIN__                     76  master.F90
ALDEXE             00000000005EEE9C  Unknown               Unknown  Unknown
libc.so.6          00002AD7EA38ECDD  Unknown               Unknown  Unknown
ALDEXE             00000000005EED99  Unknown               Unknown  Unknown

AH5T012:

forrtl: severe (174): SIGSEGV, segmentation fault occurred
Image              PC                Routine            Line        Source            
ALDEXE             00000000010CCBE0  copy_spec2spa_            166  copy_spec2spa.F90
ALDEXE             0000000000C87E33  traj_main_mod_mp_         627  traj_main_mod.F90
ALDEXE             0000000000971A39  cnt4tl_                   452  cnt4tl.F90
ALDEXE             0000000000915FC3  cnt3tl_                    81  cnt3tl.F90
ALDEXE             0000000000842E06  testli_                   255  testli.F90
ALDEXE             00000000006237FA  ctl1_                      81  ctl1.F90
ALDEXE             00000000005EF75D  cnt0_                     203  cnt0.F90
ALDEXE             00000000005EF107  MAIN__                     76  master.F90
ALDEXE             00000000005EEE9C  Unknown               Unknown  Unknown
libc.so.6          00002B0727C5CCDD  Unknown               Unknown  Unknown
ALDEXE             00000000005EED99  Unknown               Unknown  Unknown

5 jobs didn´t produce all the output, although they completed normally (with CNT0):

AR1T057,58,59,60,61: no AROMOUT_.0003.des, no AROMOUT_.0003.fa.
}}}
These problems were resolved by taking the following four files from CY41_bf.02:
{{{
arpifs/control/forecast_error.F90
arpifs/var/suallr.F90
arpifs/var/suallt.F90
arpifs/var/suecges.F90
}}}

= Inclusion of the remaining updates by Eoin Whelan on cycle 40 =

This update was performed on the 12th of December.

== An overview of the changes ==

{{{
ewhelan@eddy:aladin> diff --exclude=.svn -r  cy40t1_bf.0[1,2]/arp/dia/wrgathflnm.F90
472a473,474
> DEALLOCATE (ZBUF)
>
ewhelan@eddy:aladin> diff --exclude=.svn -r  cy40t1_bf.0[1,2]/arp/dia/wrspeca.F90
234a235
> DEALLOCATE(ITO, ZSPBUFL)
ewhelan@eddy:aladin> diff --exclude=.svn -r  cy40t1_bf.0[1,2]/tal/external/etrans_end.F90
110c110
<  DEALLOCATE(LENABLED)
---
>  IF (ALLOCATED(LENABLED)) DEALLOCATE(LENABLED)
ewhelan@eddy:aladin> diff --exclude=.svn -r  cy40t1_bf.0[1,2]/mse/module/modd_io_surf_aro.F90
1211a1212
> IF (ALLOCATED(IDIM1)) DEALLOCATE(IDIM1)
1234a1236
> DEALLOCATE (IND)
1443c1445
< DEALLOCATE (YDSC%P)
---
> IF (ASSOCIATED(YDSC%P)) DEALLOCATE (YDSC%P)
ewhelan@eddy:aladin> diff --exclude=.svn -r  cy40t1_bf.0[1,2]/surfex/SURFEX/read_prep_greenroof_snow.F90
36a37
> USE MODN_PREP_ISBA_SNOW,       ONLY : CSNOW,NSNOW_LAYER,LSWEMAX,XSWEMAX
78,79d78
< CHARACTER(LEN=3) :: CSNOW
< INTEGER :: NSNOW_LAYER
100,101c99,100
<                             XSG1SNOW, XSG2SNOW, XHISTSNOW, XAGESNOW
<
---
>                             XSG1SNOW, XSG2SNOW, XHISTSNOW, XAGESNOW,     &
>                             LSWEMAX,XSWEMAX
132c131,135
<   XAGESNOW_GR(:)    = XUNDEF
---
>   XAGESNOW_GR(:)    = XUNDEF
>   !
>   LSWEMAX=.FALSE.
>   XSWEMAX=500.
>
}}}

A large update to mse/module/sfxflddesc_mod.F90 was left out because the cycle 41 code contained new data statements which conflicted with Eoins change.

== Creating the branch with changes ==

This update was added by hand, because the differences with the original cycle 40 code were too large to be handled by the utility ¨patch¨.
{{{
git_branch -r 41 -b t1 -v 01 -u t1.01_hirlam_whelane_cy40_rest  # Create the new branch relative to CY41_t1.01
vi arpifs/dia/wrgathflnm.F90                                    # First update
vi arpifs/dia/wrspeca.F90                                       # Second update
find . -name etrans_end.F90                                     # Where is this file ?
vi ./etrans/external/etrans_end.F90                             # Third update
vi mse/module/modd_io_surf_aro.F90                              # Fourth update
vi surfex/SURFEX/read_prep_greenroof_snow.F90                   # Fifth update
vi mse/module/sfxflddesc_mod.F90                                # ... OK, give up - too much new code overlapping
git status                                                      # Check, check, double check
git add arpifs/dia/wrgathflnm.F90 arpifs/dia/wrspeca.F90 etrans/external/etrans_end.F90 mse/module/modd_io_surf_aro.F90 surfex/SURFEX/read_prep_greenroof_snow.F90
git commit --dry-run                                            # Final check
git commit -m "Eoin Whelans left over changes to CY40, minus those to mse/module/sfxflddesc_mod.F90 (too different in CY41)"
git_post                                                        # Committed and posted
}}}

= The final attempt at adding HIRLAM´s contribution with respect to LGRADSP =

On the 19th of December, I committed the final attempt at the HIRLAM contribution with respect to LGRADSP.

== Description ==

{{{
Mariano Hortal: De-aliasing the pressure gradient term, implementation for limited area models.
aladin/adiab/espfilt.F90 (new)
aladin/control/espcm.F90
aladin/setup/suehdf.F90
aladin/setup/sueldynb.F90
aladin/transform/etransdir_mdl.F90
aladin/transform/etransinv_mdl.F90
aladin/transform/etransinvh.F90
arpifs/module/yemdyn.F90
arpifs/module/yomsp.F90
arpifs/utility/sualspa.F90
}}}

== Create the branch with changes ==

{{{
tar zxvf /home/mrpe737/lgradsp_CY41_t1.01.tgz
git_branch -r 41 -b t1 -v 02 -u t1.02_hirlam_lgradsp
git branch
cp -viR /home/mrpe737/lgradsp_CY41_t1.01/* .
git status
git add aladin/control/espcm.F90 aladin/setup/suehdf.F90 aladin/setup/sueldynb.F90 aladin/transform/etransdir_mdl.F90 aladin/transform/etransinv_mdl.F90 aladin/transform/etransinvh.F90 arpifs/module/yemdyn.F90 arpifs/module/yomsp.F90 arpifs/utility/sualspa.F90 aladin/adiab/espfilt.F90
git commit --dry-run
git commit -m "HIRLAM contribution LGRADSP for inclusion in CY41_t1.03"
git_post
}}}

= Relaxation of upper boundary condition =

On the 12th of February 2015 I created a branch containing Mariano Hortal's work on "relaxation of the upper boundary condition".

== Description ==

{{{
branch: moene_CY41_t1.04_hirlam_lunbc

+ added:

aladin/coupling/ecoupl2.F90
aladin/coupling/ecoupl2ad.F90
coupling/external/gpcou/esurlxt1.F90
coupling/external/gpcou/esurlxt1ad.F90
coupling/interface/esurlxt1.h
coupling/interface/esurlxt1ad.h

+ modified:

aladin/coupling/ecoupl1.F90
aladin/coupling/ecoupl1ad.F90
aladin/coupling/elswa3.F90
aladin/coupling/eseimpls.F90
aladin/coupling/eseimplsad.F90
arpifs/ald_inc/namelist/nemelbc0a.nam.h
arpifs/control/stepo.F90
arpifs/control/stepoad.F90
arpifs/control/stepotl.F90
arpifs/module/elbc0a_mod.F90
arpifs/module/elbc0b_mod.F90
arpifs/module/elbc0c_mod.F90

Author: Mariano Hortal, HIRLAM

Description:

"A Davies relaxation of the upper boundary in a limited area run has been implemented
following the same procedure as the lateral boundary conditions.

The relaxation factor is a function of level number and therefore it has the same values
as the one for the horizontal and the extension of the relaxation is the same as the lateral boundary NBZONL.

Several high resolution runs which exploded due to too strong winds at the upper levels were kept stable by
the application of this boundary condition, an effect which was not achieved by the spectral nudging available
for the LAM model".
}}}

== Create the branch with changes ==

{{{
cd ~/git-dev/arpifs
git fetch
git_branch -r 41 -b t1 -v 04 -u t1.04_hirlam_lunbc
patch -p1 -l < ~/hirlam_sends4/lunbc/lunbc.diff2
cp -v ~/hirlam_sends4/lunbc/aladin//coupling/ecoupl2ad.F90 aladin//coupling/ecoupl2ad.F90
cp -v ~/hirlam_sends4/lunbc/aladin//coupling/ecoupl2.F90 aladin//coupling/ecoupl2.F90
cp -v ~/hirlam_sends4/lunbc/coupling/external/gpcou/esurlxt1ad.F90 coupling/external/gpcou/esurlxt1ad.F90
cp -v ~/hirlam_sends4/lunbc/coupling/external/gpcou/esurlxt1.F90 coupling/external/gpcou/esurlxt1.F90
cp -v ~/hirlam_sends4/lunbc/coupling/interface/esurlxt1ad.h coupling/interface/esurlxt1ad.h
cp -v ~/hirlam_sends4/lunbc/coupling/interface/esurlxt1.h coupling/interface/esurlxt1.h
git status
git add aladin/coupling/ecoupl1.F90
git add aladin/coupling/ecoupl1ad.F90
git add aladin/coupling/elswa3.F90
git add aladin/coupling/eseimpls.F90
git add aladin/coupling/eseimplsad.F90
git add arpifs/ald_inc/namelist/nemelbc0a.nam.h
git add arpifs/control/stepo.F90
git add arpifs/control/stepoad.F90
git add arpifs/control/stepotl.F90
git add arpifs/module/elbc0a_mod.F90
git add arpifs/module/elbc0b_mod.F90
git add arpifs/module/elbc0c_mod.F90
git add aladin/coupling/ecoupl2.F90
git add aladin/coupling/ecoupl2ad.F90
git add coupling/external/gpcou/esurlxt1.F90
git add coupling/external/gpcou/esurlxt1ad.F90
git add coupling/interface/esurlxt1.h
git add coupling/interface/esurlxt1ad.h
git commit --dry-run
git commit -m "Mariano Hortal: A Davies relaxation of the upper boundary (HIRLAM contribution)"
git_post
}}}

= Update the HARMONIE repository to CY41T1 in the branch phasing/cy41 =

Done on the 11th of May, 2015.

== Get the CY41T1 release from Meteo France ==

Log into 'merou'. Then perform the following:

{{{
#
# Go to the local extraction of the git repository
#
cd git-dev/arpifs/
#
# Bring it up-to-date
#
git pull
#
# Create an archive of the release (CY41T1)
#
git archive --format=tar -o $HOME/CY41T1.tar --prefix=CY41T1/ CY41T1
#
# Back to the home directory - gzip the created tar file
#
cd
gzip CY41T1.tar
#
# Copy it home
#
scp CY41T1.tar.gz harmonie@moene.org:
}}}

== Enter the source code into our repository ==

Go to your local machine (in my case: at home):

{{{
#
# Login to local machine
#
ssh harmonie@moene.org
#
# Create a working directory with the current contents of vendor/aladin:
#
svn co https://svn.hirlam.org/vendor/aladin/current current-wc
#
# Unpack the new sources obtained on merou at Meteo France:
#
tar zxvf CY41T1.tar.gz
#
# Remove the directories we do not use
#
cd CY41T1
rm -rf scripts/ obstat/
cd ..
#
# Use the Perl script auto_svn_load_dirs from the subversion 'contrib'
# directory to make it possible to rename source files that have been
# moved, but not changed.
#
# The script indicated that various files had attributes (in casu, execute
# bits set) that conflicted with our repository. Fixed with chmod -x.
#
# Choose "Finish" when you are convinced all files have been identified
# and processed correctly. The script will then do the final commit.
#
./svn/contrib/util/auto_svn_load_dirs.pl  -v -wc current-wc https://svn.hirlam.org/vendor/aladin current  CY41T1
#
# Tag the current directory in vendor/aladin with the correct version name
# of the imported sources.
#
svn copy -m "Tag vendor/aladin/current as vendor/aladin/cy41t1." https://svn.hirlam.org/vendor/aladin/current https://svn.hirlam.org/vendor/aladin/cy41t1
}}}

== Merge the new vendor/aladin/current branch into phasing/cy41 ==

{{{
#
# Check out a working copy of the phasing/cy41 branch
#
svn co https://svn.hirlam.org/branches/phasing/cy41 working-copy
#
# Start the merge; all conflicts seem minor and are resolved by taking
# the CY41T1 version of the source
#
svn merge https://svn.hirlam.org/vendor/aladin/cy41_t1.02 https://svn.hirlam.org/vendor/aladin/current working-copy/src
#
# However, according to CY41T1, aladin/adiab/espfilt.F90 is new, whereas
# already have it (part of our version of LGRADSP).
#
cd working-copy/src
cd aladin/adiab
diff espfilt.F90 espfilt.F90.orig
#
# OK, that was a merging mess, so take a fresh copy from merou:
#
cp ~/tmp/lgradsp_CY41_t1.01/aladin/adiab/espfilt.F90 .
#
# Check - it's OK
#
svn diff
#
# Continue the commit - oops: espfilt.F90 still conflicts;
# resolve "by hand".
#
cd ../../..
(export EDITOR=/usr/bin/vi; svn commit)
svn resolve --accept working src/aladin/adiab/espfilt.F90
#
# Check the diff, again.  It's still OK
#
cd src/aladin/adiab
svn diff
#
# Conclude the commit now all conflicts are resolved
#
cd ../../..
(export EDITOR=/usr/bin/vi; svn commit)
}}}