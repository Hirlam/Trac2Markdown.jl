[[PageOutline]]
[[Center(begin)]]
= '''Phasing information for Cycle 47T1''' =
[[Center(end)]]


= Cycle Master =

Cycle Master: Toon Moene & Bert van Ulft

= Potential contributions =

Summary of all differences between develop from #6ff796 20181203   to  #66993a 20190923

[https://hirlam.org/trac/attachment/wiki/Phasing/cy46t1/content46T1_rollingversion.pdf List of contributions coordinated by MF]

Last updated:2019-09-26

= TECHNICAL =

Changeset [https://hirlam.org/trac/changeset/f8a6c9f93026be4283b1341cfedf49701ad270d9/Harmonie f8a6c9]

Author: Ole Vignes 

Message: Fix various uninitialized or out of bounds problems

Files:
{{{
arpifs/canari/cacsts.F90 
arpifs/canari/cancer.F90 
surfex/ASSIM/assim_nature_isba_oi.F90 
}}}

Changeset: [https://hirlam.org/trac/changeset/afffddc0e8dd640ad9e208d0b78f8fb91be681c1/Harmonie afffdd]

Author: Ole Vignes

Message: Fix 2D decomposition bug reintroduced by splitting of mkglobstab

File:
{{{
arpifs/obs_preproc/mkglobstab_model.F90 
}}}

Changeset: [https://hirlam.org/trac/changeset/7479bbf6dc1748b00f4b92a072a344d5d59a992b/Harmonie 7479bb] 

Author: Ole Vignes

Message: OpenMP bugfix

File:
{{{
aladin/coupling/ecoupl2.F90
}}}

Changeset: [https://hirlam.org/trac/changeset/216403531c450745cb13209f38dd14021f596907/Harmonie 216403]

Author: Ulf Andrae 

Message: Correct mpi-dummy routine

File:
{{{
odb/extras/mpi_serial/mpi_comm_split.F 
}}}




= Physics = 

Changeset: [https://hirlam.org/trac/changeset/9bd6d32e04bef592bae95b28164a0261603a706c/Harmonie 9bd6d3]

Author: Eoin Whelan 

Message:Emily Gleeson: write model level height (MUSC LFA) Add writing of ZELEVATION, model level height to default   
                 MUSC LFA output.
File:
{{{ 
arpifs/phys_dmn/writemusc.F90 
}}}

Changeset:[https://hirlam.org/trac/changeset/747ddffea0a3099818359d0fd9c5a3b901d7f94b/Harmonie 747ddf]

Author:Ulf Andrae 

Message: CAMS aerosol implementation
Files:
{{{
aladin/c9xx/eincli9.F90 
arpifs/c9xx/incli0.F90 
arpifs/module/yomcli.F90 
arpifs/namelist/namcli.nam.h 
}}}

Changeset: [https://hirlam.org/trac/changeset/3c6dedb81fa13a89c7117f4dba9a8322047d37da/Harmonie 3c6ded] 

Author: Daniel Santos 

Message: Microphysics changes and logical switch for height dependent VQSIGSAT (Karl-Ivar
Ivarsson)

Files: 
{{{
arpifs/module/yomparar.F90 
arpifs/namelist/namparar.nam.h 
arpifs/namelist/namphy2.nam.h 
arpifs/phys_dmn/acnpart.F90 
arpifs/phys_dmn/apl_arome.F90 
arpifs/phys_dmn/suparar.F90 
arpifs/phys_dmn/suphy2.F90 
mpa/micro/externals/aro_adjust.F90 
mpa/micro/externals/aroini_micro.F90 
mpa/micro/interface/aro_adjust.h 
mpa/micro/internals/condensation.F90 
mpa/micro/internals/ice_adjust.F90 
mpa/micro/internals/rain_ice.F90 
mpa/micro/module/modd_rain_ice_param.F90 
mpa/micro/module/modi_condensation.F90 
mpa/micro/module/modi_ice_adjust.F90 
}}}

Changeset [https://hirlam.org/trac/changeset/314a16e6673c14e448d6e550733a6ff95ed34f1f/Harmonie 314a16]

Author: Ulf Andrae

Message: Fixes 

Files: 
{{{
arpifs/module/control_vectors_base_mix.F90
arpifs/module/spectral_fields_mod.F90
arpifs/parallel/dot_product_ctlvec.F90 
arpifs/phys_dmn/apl_arome.F90 
arpifs/phys_dmn/vdfparcelhl.F90 
mpa/turb/internals/compute_function_thermo_mf.F90 
mpa/turb/internals/compute_mf_cloud_stat.F90 
mpa/turb/internals/ini_cturb.F90 
mpa/turb/internals/turb.F90
}}}


Changeset: [https://hirlam.org/trac/changeset/94e863aa6982b361a102cdadac4a9ac785a6ebae/Harmonie  94e863]

Author: Daniel Santos

Message: Wim de Rooy: Update 00e0fa modifications on set clouds, turbulence and convection scheme

Files:
{{{
arpifs/phys_dmn/apl_arome.F90 
arpifs/phys_dmn/vdfparcelhl.F90 
mpa/turb/internals/compute_function_thermo_mf.F90 
mpa/turb/internals/compute_mf_cloud_stat.F90
mpa/turb/internals/ini_cturb.F90 
mpa/turb/internals/turb.F90
}}}
Changeset: [https://hirlam.org/trac/changeset/fd9dbe40749635d1b567e3d7c33cf130b631ea7a/Harmonie fd9dbe] 

Author:Ulf Andrae

Message: Fix physics 

Files:
{{{
namelist/namphy0.nam.h (1 diff)
arpifs/phys_dmn/apl_arome.F90 (4 diffs)
arpifs/phys_dmn/suphy0.F90 (1 diff)
arpifs/phys_dmn/vdfexcuhl.F90 (2 diffs)
}}}



= EPS =


Changesets:[https://hirlam.org/trac/changeset/7c4669f652fe176987c891e9d7ceea7f70e7cfe0/Harmonie 7c4669] [https://hirlam.org/trac/changeset/6a56c07ee47d75827405022b2145ffc38fe1aeff/Harmonie  6a56c0] [https://hirlam.org/trac/changeset/386fe9a6d5f9e26d2bb7ce44519bab39cf6c783a/Harmonie  386fe9] [https://hirlam.org/trac/changeset/bd6f2c973f216a6fb3cf72e3eda683f24c59b2d0/Harmonie  bd6f2c]

Author: Ulf Andrae 

Message:SPP implementation

Files:
{{{
aladin/programs/spg.F90 
arpifs/adiab/cpg.F90 
arpifs/adiab/cpg_drv.F90 
arpifs/control/stepo.F90 
arpifs/dia/gridpoint_norm.F90 
arpifs/module/spp_mod.F90
arpifs/module/yoevdf.F90 
arpifs/module/yomparar.F90 
arpifs/namelist/namphy0.nam.h 
arpifs/namelist/namspp.nam.h
arpifs/phys_dmn/apl_arome.F90
arpifs/phys_dmn/aplpar.F90 
arpifs/phys_dmn/evolve_spp.F90
arpifs/phys_dmn/ini_spp.F90
arpifs/phys_dmn/mf_phys.F90 
arpifs/phys_dmn/suparar.F90
arpifs/phys_dmn/suphy0.F90 
arpifs/phys_dmn/vdfexcuhl.F90 
arpifs/phys_dmn/vdfhghthl.F90 
arpifs/phys_dmn/vdfhghtnhl.F90
arpifs/phys_dmn/vdfstcucrithl.F90 
arpifs/phys_radi/acradin.F90 
arpifs/phys_radi/radlsw.F90 
arpifs/phys_radi/recmwf.F90
arpifs/setup/get_spp_conf.F90
arpifs/setup/su0yomb.F90 
mpa/micro/externals/aro_adjust.F90
mpa/micro/externals/aro_rain_ice.F90 
mpa/micro/externals/aroini_micro.F90
mpa/micro/interface/aro_adjust.h
mpa/micro/interface/aro_rain_ice.h
mpa/micro/internals/condensation.F90
mpa/micro/internals/ice_adjust.F90 
mpa/micro/internals/ini_rain_ice.F90 
mpa/micro/internals/rain_ice.F90
mpa/micro/module/modd_rain_ice_param.F90 
mpa/micro/module/modd_spp_type.F90
mpa/micro/module/modi_condensation.F90
mpa/micro/module/modi_ice_adjust.F90 
mpa/micro/module/modi_rain_ice.F90 
}}}

Changeset [https://hirlam.org/trac/changeset/1e513433a8634ad05bff65baba9dab3a155a074e/Harmonie 1e5134] [https://hirlam.org/trac/changeset/d415269f32d3f398eac1a62697e7e1e4c1d1bff1/Harmonie  d41526]

Author: Ulf Andrae 

Message:Porting of SPG stuff from cy40 with some corrections of bad phasing

Files:
{{{
arpifs/module/spectral_arp_mod.F90 
arpifs/setup/suspsdt.F90 
}}}


= DA =  

=== BATOR ===

Changeset:  [https://hirlam.org/trac/changeset/b143baa67137abd2c500a34663b305dffbfbea13/Harmonie#file17 b143ba]

Author: Ulf Andrae 

Message:  Assimilation fixes

Files:
{{{
arpifs/obs_preproc/defrun.F90 
odb/pandor/module/bator_init_mod.F90 
}}}

Changesets:  [https://hirlam.org/trac/changeset/b143baa67137abd2c500a34663b305dffbfbea13/Harmonie#file17 c924b2] [https://hirlam.org/trac/changeset/1fb1190de7c450397ad14c3273479d8f80639b9f/Harmonie 1fb119] [https://hirlam.org/trac/changeset/d76a29b7ca9e3683199978c883ffbbf594e6c0a8/Harmonie d76a29]

Author: Eoin Whelan

Message: remove hard-coding of SHIP and BUOY stalt
                Allow the assimilation of Ps observations
                - blacklist Ps/PMSL (by defaul) - this will the Z/PS switch
                - allow assimilation of Ps in NOTVAR settings
                - process either Ps/PMSL observations depending on your param settings
                - remove PMLS (108) output using ifdef OLDBUFR
Files:
{{{
 odb/pandor/module/bator_decodbufr_mod.F90
}}}

Changeset:https: [//hirlam.org/trac/changeset/bea7517efa00df171b2d0edd05ca59563c3a4909/Harmonie bea751]

Author: Eoin Whelan 

Message: initial set of changes to assimilate Ps Namelist and code changes to assimilate Ps and/or PMSL from SYNOP and BUOY observations.

Files:

{{{

arpifs/canari/calico.F90
arpifs/obs_preproc/prech.F90 
arpifs/obs_preproc/settc.F90 
arpifs/op_obs/exheiz2p.F90
arpifs/op_obs/hretr_conv.F90 
arpifs/op_obs/obshor.F90 
odb/pandor/module/bator_decodbufr_mod.F90 
odb/pandor/module/bator_ecritures_mod.F90 
odb/pandor/module/bator_init_mod.F90
}}}


=== Blacklisting ===

Changeset: [https://hirlam.org/trac/changeset/d90eccd6ea4154081ca7f7909ca731344e3d6074/Harmonie d90ecc] [https://hirlam.org/trac/changeset/ac126d62be7ba49e66175680d5ad7bc3b72e923a/Harmonie ac126d] [https://hirlam.org/trac/changeset/ac126d62be7ba49e66175680d5ad7bc3b72e923a/Harmonie b797f2c] [https://hirlam.org/trac/changeset/ac126d62be7ba49e66175680d5ad7bc3b72e923a/Harmonie c781a8] [https://hirlam.org/trac/changeset/2327f4f30c7a51ed4276e1e8134d57b197873a80/Harmonie 2327f4] [https://hirlam.org/trac/changeset/e188935be6b4914b34fb9a5b99c5705bed0b540a/Harmonie e18893]

Author: Ulf Andrae, Daniel Santos

Message:  Add blacklisting functionality based on ECMWF bl info

Files:

{{{
arpifs/obs_preproc/black.F90 
blacklist/mon_black2019011600.b 
blacklist/mon_black2019070100.b 
blacklist/hirlam_blacklist.b.data_selection_after_20140601 
blacklist/blacklisthirlam_blacklist.b.data_selection_before20081209 
blacklist/hirlam_blacklist.b.data_selection_from20081209_to_20140601 
blacklist/hirlam_blacklist.b.monthly_after_20140601 
blacklist/hirlam_blacklist.b.data_selection_after_20140601 
blacklist/hirlam_blacklist.b.data_selection_before20081209 
blacklist/hirlam_blacklist.b.data_selection_from20081209_to_20140601
blacklist/hirlam_blacklist.b.monthly_after_20140601 
blacklist/README 
blacklist/hirlam_blacklist.B
blacklist/hirlam_blacklist.b.data_selection_after_20140601
blacklist/hirlam_blacklist.b.data_selection_before20081209
blacklist/hirlam_blacklist.b.data_selection_from20081209_to_20140601
blacklist/hirlam_blacklist.b.monthly_after_20140601
blacklist/hirlam_blacklist.b.monthly_before20081209
blacklist/hirlam_blacklist.b.monthly_from20081209_to_20140601
blacklist/hirlam_blacklist.b.monthly_recent
blacklist/hirlam_blacklist.b.monthly_recent_carra
blacklist/hirlam_external
blacklist/mon_black2019070100.b
}}}

=== EnVar ===

Changeset: [https://hirlam.org/trac/changeset/30e1029faff21d3a177ecbbc376e3d483dc725ab/Harmonie 30e102]

Author: Eoin Whelan 

Message: Merge branch 'develop_jelena_EnVar' 

Files:
{{{
arpifs/module/control_vectors_base_mix.F90 
arpifs/module/spectral_fields_mod.F90 
arpifs/parallel/dot_product_ctlvec.F90 
}}}


=== BRAND ===

Changeset [https://hirlam.org/trac/changeset/36954bd86cef5854500c3b3b705f0320a6f68350/Harmonie 36954b] [https://hirlam.org/trac/changeset/d538aef327faf7947cf344841413f0d6d71f2c45/Harmonie  d538ae] [https://hirlam.org/trac/changeset/8561c86d7ca6eeed125deab2d411203bf414d01a/Harmonie 8561c8] 

Author: Jelena Bojarova Ulf Andrae

Message: BRAND

Files:
{{{
aladin/var/suevargp.F90 
arpifs/module/control_vectors_base_mix.F90 
arpifs/module/spectral_fields_mod.F90 
arpifs/module/traj_main_mod.F90 
arpifs/module/trajectory_mod.F90 
arpifs/module/yomspjb.F90 
arpifs/parallel/dot_product_ctlvec.F90 
arpifs/setup/su0yomb.F90 
arpifs/var/bgpert.F90 
arpifs/var/jbtomodel.F90 
arpifs/var/suallt.F90 
}}}


=== Hybrid EnvVar ===

Changeset: [https://hirlam.org/trac/changeset/62ad4895a16a52c1374733399aaacb1d059ae0ca/Harmonie 62ad48]

Author: Ulf Andrae

Message: Jelena Bojarova: Fixes for hybridenvar

Files:

{{{
aladin/utility/create_pert.F90 
aladin/utility/get_hybrid_ens.F90 
aladin/utility/read_pert.F90 
aladin/utility/relax_zero_bd.F90 
aladin/utility/spa2jbgp.F90 
aladin/var/ebalvert.F90 
aladin/var/ebalvertad.F90 
arpifs/utility/setimzero.F90 
arpifs/var/bgevecs.F90 
arpifs/var/cain.F90 
arpifs/var/cainad.F90 
sarpifs/var/suvar.F90 
}}}

Changeset:[https://hirlam.org/trac/changeset/57e70020fa077282873b8d54049c9bbe8013df3e/Harmonie 57e700] [https://hirlam.org/trac/changeset/ca3559f7f8e5d7b88b5a8028c8e3711151c9118d/Harmonie ca3559f]

Author:Ulf Andrae 

Message: Jelena Bojarova: HybridEnVar updates

Files:
{{{
aladin/module/yemenshyb.F90 
aladin/utility/get_hybrid_ens.F90 
aladin/utility/gp2mod_pert.F90 
aladin/utility/gp2mod_pert_ad.F90 
aladin/utility/gp2spjbf.F90 
aladin/utility/gp2spjbf_ad.F90 
arpifs/dia/gridpoint_norm.F90 
arpifs/module/control_vectors_base_mix.F90 
arpifs/module/control_vectors_data_mix.F90 
arpifs/module/control_vectors_oper_mod.F90 
arpifs/module/control_vectors_para_mod.F90 
arpifs/module/spectral_fields_data.F90 
arpifs/module/spectral_fields_mod.F90 
arpifs/module/spectral_fields_oper_mod.F90 
arpifs/namelist/namvar.nam.h 
arpifs/parallel/dot_product_ctlvec.F90 
arpifs/setup/su0yomb.F90
arpifs/transform/alpsp2gp.F90 
arpifs/transform/alpsp2gpad.F90 
arpifs/transform/spjbgp2sp.F90 
arpifs/transform/spjbsp2gp.F90 
arpifs/utility/random_ctlvec.F90 
arpifs/var/cvar2in.F90 
arpifs/var/cvar2inad.F90 
arpifs/var/ens_contrib_ad.F90 
arpifs/var/ens_contrib_tl.F90
arpifs/var/sqrtain.F90 
arpifs/var/sqrtainad.F90 
arpifs/var/sualctv.F90 
arpifs/var/sualpfld.F90 
arpifs/var/suvar.F90 
etrans/external/egpnorm_trans.F90 
mse/externals/aro_ground_param.F90 
odb/ddl/sat_aeolus.sql 
odb/pandor/module/bator_ecritures_mod.F90 
}}}

= Testing the Technical Corrections =
== Prepare on ecgate at ECMWF ==
Clone the repository made by Daniel Santos:
{{{
mkdir 47prefasing
cd 47prefasing
git clone /perm/ms/es/sp2b/mf-git/arpifs
cd arpifs/
git checkout Hirlam_tech_corrections
tar zcvf $SCRATCH/47prefasing-techcorrections.tgz .
scp /scratch/ms/nl/nkc/47prefasing-techcorrections.tgz harmonie@moene.org:
}}}
== Build on beaufix at Meteo France ==
First, get the technical corrections branch to beaufix:
{{{
scp harmonie@moene.org:47prefasing-techcorrections.tgz .
}}}
Then, use gmkpack to set up the environment for building this version of CY47:
{{{
(export PATH=$PATH:/home/gmap/mrpm/khatib/public/bin/gmkpack.6.7.1/util; gmkpack -r 47 -b main -v 01 -a -l IMPIFC1801 -o 2y -p masterodb)
cd /home/gmap/mrpe/moene/pack/47_main.01.IMPIFC1801.2y/
cd src/local/
tar zxvf ~/47prefasing-techcorrections.tgz 
}}}
And build it (after removing the "cope", "oops_src", "oopsifs" and "scripts" directory):
{{{
rm -rf cope oops_src oopsifs scripts
cd ../..
(export GMK_THREADS=20; export PATH=$PATH:/home/gmap/mrpm/khatib/public/bin/gmkpack.6.7.1/util; ./ics_masterodb) >& log &
}}}
This concluded succesfully:
{{{
$ tail log
/home/gmap/mrpm/khatib/public/bin/impifc-18.1.163 -v -fp-stack-check -qopenmp -qopenmp-threadprivate compat -shared-intel -lrt -Wl,-rpath,/home/gmap/mrpm/khatib/opt/i-16.1.150/netcdf/lib -Wl,-rpath,/home/gmap/mrpm/khatib/opt/i-16.1.150/eccodes-2.7.0-mf/lib -Wl,-rpath,/home/gmap/mrpm/khatib/opt/i-16.1.150/auxlibs/lib -Wl,-rpath,/home/gmap/mrpm/khatib/opt/i-13.1.4.183/openblas/lib -Wl,-rpath,/home/gmap/mrpm/khatib/opt/i-13.1.4.183/netlib -Wl,-rpath,/opt/bullxde/utils/boost/lib -Wl,-rpath,/opt/softs/libraries/ICC16.1.150/hdf5-1.8.16/lib -Wl,--start-group ./_odb_glue.o ./master.o -L. -l[1] -l[2] -l[3] -l[4] -l[5] -l[6] -l[7] -l[8] -l[9] -l[10] -l[11] -l[12] -l[13] -l[14] -l[15] -l[16] -l[17] -l[18] -l[19] -l[20] -l[21] -l[22] -l[23] -l[24] -l[25] -l[26] -l[27] -l[28] -Wl,--end-group -L/home/gmap/mrpm/khatib/opt/i-16.1.150/auxlibs/lib -lbufr -lgribex -L/home/gmap/mrpm/khatib/opt/i-16.1.150/netcdf/lib -lnetcdff -lnetcdf -L/home/gmap/mrpm/khatib/opt/i-16.1.150/eccodes-2.7.0-mf/lib -leccodes_f90 -leccodes -L/opt/softs/libraries/ICC16.1.150/hdf5-1.8.16/lib -lhdf5hl_fortran -lhdf5_fortran -lhdf5 -L/home/gmap/mrpm/khatib/opt/i-16.1.150/auxlibs/lib -lfdbdummy -lwamdummy -lnaglitedummy -loasisdummy -L/home/gmap/mrpm/khatib/opt/i-13.1.4.183/netlib -llapack -L/home/gmap/mrpm/khatib/opt/i-13.1.4.183/openblas/lib -lblas -L/home/gmap/mrpm/khatib/opt/i-16.1.150/auxlibs/lib -libmdummy
mpiifort for the Intel(R) MPI Library 2018 Update 1 for Linux*
Copyright(C) 2003-2017, Intel Corporation.  All rights reserved.

+ mv a.out /home/gmap/mrpe/moene/pack/47_main.01.IMPIFC1801.2y/bin/MASTERODB
+ set +x
-rwxr-xr-x 1 moene mrpe 728050952 Nov  1 21:41 /home/gmap/mrpe/moene/pack/47_main.01.IMPIFC1801.2y/bin/MASTERODB

Finished on Fri Nov 1 21:41:42 UTC 2019
}}}
== Testing with mitraillette on beaufix ==