[[PageOutline]]
[[Center(begin)]]
== '''HARMONIE 40t1 phasing''' ==

This page summarizes the difference between cy40_t1.04 branches/phasing/cy40.

[[Center(end)]]

[[BR]]

== '''Summary table''' ==
|| '''Contribution'''    || '''Author'''            || '''Comments''' || 
|| '''Bugfixes or missed contributions'''||
|| Correct use of module variables || || r12781 || 
|| Add more SURFEX FA/LFI translations || || r12785 ||
|| Add missing deallocation check || || r12787 ||
|| Make string length consistent between with surfex lfi || || r12802 || 
|| Missing SURFEX file present in NEW_PRE_HIRLAM branch ||  || r12829 || 
|| [#Portabilityfixes Portability fixes] ||  || r12772 || 
|| [#OMPthreadsafesurfexfix OpenMP in surfex]                  || Ole Vignes || This has been missed in the phasing ||
|| [#Surfextoolsubroutinesshouldnotbeinprogramdirectory Move of surfex tool subroutine] || || This has been missed in the phasing ||
|| [#lfitoolsubroutinesshouldnotbeinprogramdirectory Move of lfi tool subroutines ] || || ||
|| [#Duplicatedmainprograms Duplicated main programs] || ||  || 
|| [#Extrapolationinsurfex Extrapolation in surfex] || || Could be considered as a bugfix, r12739 ||
|| [#Updatedecoclimapconversionprogram Updated ecoclimap software] || || [https://hirlam.org/trac/changeset/12782/branches/phasing/cy40/src r12782] || 
|| [#Varbc VarBC GPS]                  || || Is this coming via MF as well? [https://hirlam.org/trac/changeset/12738/trunk/harmonie/src r12738] ||
|| [#Alarosurfexinterface Alaro surfex interface] || || Has this been introduced by Rafiq already? [https://hirlam.org/trac/changeset/12485/trunk/harmonie/src r12485] || 
|| [#FixforBE04 BE04 fix] || || What happened to this? Is this working in 40t1? r12338 ||
|| [#AssiminTEB Assim in TEB] || || This is in the NEW_PREP_HIRLAM surfex branch, missed in phasing ||
|| '''Contributions for discussion'''||
|| [#Lesslogoutput Less log output] || ||  [https://hirlam.org/trac/changeset/12741/trunk/harmonie/src/xrd/misc/facat.F90 r12741] || 
|| [#Avoidcalculationsonmissingdata Avoid calculations on missing data] || || r12412 ||
|| [#Radiationoutput Radiation output bugfix] || || r12732 ||
|| '''Contributions for next cycle (41/41t1)'''||
|| [#Solidmicrophysics] || Ivarsson || ||
|| [#SODAinCANARI SODA in CANARI] || ||
|| Output of arbitrary surfex fields || || Not yet merged from trunk || 
|| Application of boundaries in spectral space || Mariano Hortal || Not yet merged from trunk ||
|| '''To be checked'''|| 
|| [#EmptyPoolfix] || || ||
|| '''Kept in HIRLAM repository only'''||
|| [#HIRLAMspecificpregpssolfixes] || || ||
|| [#Batorchanges] || || ||
|| [#Blacklisting] || || ||
|| [#a4DVARfixes] || || || 
|| [#BDIFF] || || ||
|| [#Nameconventionofcloudfields] || || ||



== '''All differences''' ==

Below is a list of differences between the current phasing branch for [source:harmonie/branches/phasing/cy40/src cy40_phasing] based on cy40 and [source:vendor/aladin/current cy40_t1.04] as extracted from git. This is so far only an inventory and should serve as an input for further discussions.

------------------------------------------------------------------------

=== Portability fixes ===
 Eoin Whelan: Use FCGENERALIZED_GAMMA instead of GAMMA ( to keep ifort 11.1 happy), r12772

{{{
Files:
   Use a more portable form of the GAMMA function
   arp/c9xx/calc_recf_alpha.F90 
}}}

------------------------------------------------------------------------

=== OMP threadsafe surfex fix ===

{{{

Index: update_data_cover.F90
===================================================================
--- update_data_cover.F90	(.../vendor/aladin/current/surfex/SURFEX/update_data_cover.F90)	(revision 12812)
+++ update_data_cover.F90	(.../branches/phasing/cy40/src/surfex/SURFEX/update_data_cover.F90)	(revision 12812)


@@ -63,6 +63,7 @@


                !
                !-------------------------------------------------------------------------------
                IF (LHOOK) CALL DR_HOOK('UPDATE_DATA_COVER',0,ZHOOK_HANDLE)


+12215  uandrae !$OMP CRITICAL


                IF (KYEAR /= NYEAR) THEN        
                  NYEAR = KYEAR
                  CALL ECOCLIMAP2_LAI


@@ -70,6 +71,7 @@


                             PLAI=XDATA_LAI, PH_TREE=XDATA_H_TREE, PVEG_OUT=XDATA_VEG, &
                             PGREEN=XDATA_GREEN, PZ0=XDATA_Z0, PEMIS_ECO=XDATA_EMIS_ECO)
                END IF


+12215  uandrae !$OMP END CRITICAL


                IF (LHOOK) CALL DR_HOOK('UPDATE_DATA_COVER',1,ZHOOK_HANDLE)
                !-------------------------------------------------------------------------------
                

}}}

------------------------------------------------------------------------

=== Surfex tool subroutines should not be in program directory ===

{{{
  Move
  mse/programs/sfxconv.F90
  mse/programs/sfxfa2lfi.F90
  mse/programs/sfxfilter.F90
  mse/programs/sfxlfi2fa.F90
  mse/programs/sfxutil.F90
  to
  mse/new/sfxconv.F90
  mse/new/sfxfa2lfi.F90
  mse/new/sfxfilter.F90
  mse/new/sfxlfi2fa.F90
  mse/new/sfxutil.F90
}}}


------------------------------------------------------------------------

=== lfi tool subroutines should not be in program directory ===

{{{
  Move
  xrd/programs/fadate.F90
  xrd/programs/fadiff.F90
  xrd/programs/lfi_alt_copy.F90
  xrd/programs/lfi_alt_indx.F90
  xrd/programs/lfi_alt_pack.F90
  xrd/programs/lfifactm.F90
  to
  xrd/misc/fadate.F90
  xrd/misc/fadiff.F90
  xrd/misc/lfi_alt_copy.F90
  xrd/misc/lfi_alt_indx.F90
  xrd/misc/lfi_alt_pack.F90
  xrd/misc/lfifactm.F90
}}}

------------------------------------------------------------------------

=== Duplicated main programs ===

{{{
  Move
  surfex/OFFLIN/pgd.F90
  surfex/OFFLIN/soda.F90
  to
  mse/programs/pgd.F90
  mse/programs/soda.F90
}}}

------------------------------------------------------------------------


=== Extrapolation in surfex ===

  Extrapolation in prep and OI_main
  Add NDIM_EXTRAP to allow different search radius, r12739

{{{
Files:
  arp/fullpos/sufptr2.F90
  surfex/ASSIM/oi_hor_extrapol_surf.F90
  surfex/SURFEX/default_prep_isba.F90
  surfex/SURFEX/modd_prep_isba.F90
  surfex/SURFEX/modn_prep_isba.F90
  surfex/SURFEX/prep_isba_buffer.F90
  surfex/SURFEX/prep_snow_buffer.F90
}}}

------------------------------------------------------------------------

=== Updated ecoclimap conversion program ===

  [https://hirlam.org/trac/changeset/12782/branches/phasing/cy40/src r12782]
{{{
  File:
  mse/programs/convert/ecoclimap_param.F90
}}}


=== Fix for BE04 ===

 Yann Seity: Fix for proper initialization for SSO drag. r12338

  Should this be kept?

{{{
Files:
  surfex/SURFEX/read_sso_canopyn.F90
}}}

-----------------------------------------------------------------------------------------------------------------------------------------------

=== Assim in TEB ===

 Contribution missed in phasing

{{{
Files:
  surfex/SURFEX/read_tebn.F90

===================================================================
--- read_tebn.F90	(.../vendor/aladin/current/surfex/SURFEX/read_tebn.F90)	(revision 12812)
+++ read_tebn.F90	(.../branches/phasing/cy40/src/surfex/SURFEX/read_tebn.F90)	(revision 12812)


@@ -46,7 +46,9 @@


                USE MODD_BEM_n, ONLY : NFLOOR_LAYER, XT_FLOOR, XT_MASS,           &
                                       XT_WIN1, XT_WIN2, XQI_BLD, XTI_BLD                                   
                USE MODD_ASSIM, ONLY : LASSIM,XAT2M_TEB


+12779 trygveas USE MODD_ASSIM,          ONLY : LASSIM,XAT2M_TEB


                !


+12779 trygveas USE MODD_SURF_PAR,       ONLY : XUNDEF


                USE MODI_READ_SURF
                !
                USE MODI_INIT_IO_SURF_n


@@ -301,6 +303,15 @@


                YRECFM=ADJUSTL(YRECFM)
                IF (GOLD_NAME) YRECFM='Q_CANYON'
                 CALL READ_SURF(HPROGRAM,YRECFM,XQ_CANYON(:),IRESP)


+12779 trygveas 
+12779 trygveas IF ( LASSIM ) THEN
+12779 trygveas   ! Diagnostic fields for assimilation
+12779 trygveas   IF ( .NOT. ALLOCATED(XAT2M_TEB)) ALLOCATE(XAT2M_TEB(ILU))
+12779 trygveas   XAT2M_TEB=XUNDEF
+12779 trygveas   YRECFM='T2M'
+12779 trygveas   CALL READ_SURF(HPROGRAM,YRECFM,XAT2M_TEB(:),IRESP)
+12779 trygveas ENDIF
+12779 trygveas 


                IF (LHOOK) CALL DR_HOOK('READ_TEB_N',1,ZHOOK_HANDLE)
                
                IF ( LASSIM ) THEN


}}}

-----------------------------------------------------------------------------------------------------------------------------------------------



------------------------------------------------------------------------
=== Less log output ===

 [https://hirlam.org/trac/changeset/12741/trunk/harmonie/src/xrd/misc/facat.F90 r12741]
{{{
Files:
  src/xrd/misc/facat.F90
}}}

------------------------------------------------------------------------
=== Avoid calculations on missing data ===

 Ulf Andrae
 Replace WHERE statement with IF to avoid SIGFPE due to evaluation of missing data. r12412

{{{
Files:
  surfex/SURFEX/mode_read_extern.F90
}}}


------------------------------------------------------------------------

=== Solid microphysics ===
Karl-Ivar Ivarsson, r12250

More strict separation of liquid- and ice microphysics in arome condensation The scheme is controlled by the switch LOCND2 in namparar and is switched off by default 


{{{
Files:
  arp/module/yomparar.F90
  arp/phys_dmn/apl_arome.F90
  arp/phys_dmn/suparar.F90
  mpa/micro/externals/aro_adjust.F90
  mpa/micro/externals/aro_rain_ice.F90
  mpa/micro/interface/aro_adjust.h
  mpa/micro/interface/aro_rain_ice.h
  mpa/micro/internals/condensation.F90
  mpa/micro/internals/ini_rain_ice.F90
  mpa/micro/internals/ice_adjust.F9
  mpa/micro/internals/rain_ice.F90
  mpa/micro/module/modi_condensation.F90
  mpa/micro/module/modi_ice_adjust.F90
  mpa/micro/internals/rain_ice.F90
}}}



------------------------------------------------------------------------

=== Varbc ===
 - VarBC predictor levels
 - GPS changes
{{{
Files:
  arp/module/varbc_pred.F90
  arp/obs_preproc/black.F90
  arp/op_obs/hop.F90
  arp/op_obs/hopad.F90
  arp/op_obs/hoptl.F90
  arp/utility/prtjo.F90
  odb/ddl/getsfcobsid.sql
  odb/ddl/varbc_sfcobs_robhdr.sql
}}}

-----------------------------------------------------------------------

=== Alaro surfex interface ===

{{{
Files:
  arp/phys_dmn/apl_arome.F90
  arp/phys_dmn/initaplpar.F90
  arp/phys_dmn/aplpar.F90
  mse/externals/aro_ground_diag.F90
  mse/interface/aro_ground_diag.h
  surfex/SURFEX/get_fluxn.F90
  src/surfex/SURFEX/get_surf_varn.F90
}}}

------------------------------------------------------------------------

=== Radiation output ===
 - Kristian Pagh Nielsen

The SW direct/diffuse correction is two bug-fixes. Firstly, in the core SW radiation routines where SWdir and SWdiff is calculated a calculation of
direct irradiances is now used, and the diffuse irradiances are calculated as SWdiff = SWtotal - SWdir. Before SWdir and SWdiff were given the clear
sky and cloudy sky irradiances, which is wrong. The second bug-fix is to pass radiation variables correctly towards the output via MF_PHYS.

r12732

{{{
Files:
  arp/phys_dmn/apl_arome.F90
  arp/phys_dmn/aplpar.F90
  arp/phys_dmn/mf_phys.F90
  arp/phys_ec/callparad.F90
  arp/phys_ec/radheat.F90
  arp/phys_radi/sw1s.F90
  arp/phys_radi/swni.F90
}}}

-----------------------------------------------------------------------

=== SODA in CANARI ===
Trygve Asplien
- EKF changes
- SODA inline ( CANARI ) changes

{{{
Files:
  arp/canari/canali.F90
  arp/module/qactex.F90
  arp/module/yomlun.F90
  arp/utility/openfa.F90
  arp/utility/openfainfo.F90
  mse/externals/aroini_surfa.F90
  mse/externals/aroini_surfc.F90
  mse/externals/sugridsfx.F90
  mse/externals/suphmse_surface.F90
  mse/interface/aroini_surfa.h
  mse/interface/sugridsfx.h
  mse/programs/driver_off_omp.F90
  mse/externals/deallmse.F90
  mse/module/modd_io_surf_aro.F90
}}}

-----------------------------------------------------------------------------------------------------------------------------------------------
=== Compilation problem fix ===

{{{
Files:
  odb/tools/Simulobs2odb.F90
}}}

=== Empty Pool fix ===
To be removed when any other solution is introduced

{{{
Files:
  arp/obs_preproc/readoba.F90
  odb/cma2odb/shuffle_odb.F90
}}}

------------------------------------------------------------------------

=== SAMIO ===

Add back or not?

{{{

Files:
xrd/lfi/lfiecc.F90 
xrd/lfi/lfiedo.F90 
xrd/lfi/lfifer.F90 
xrd/lfi/lfilcc.F90 
xrd/lfi/lfildo.F90 
xrd/lfi/lfiouv.F90 

}}}

------------------------------------------------------------------------
=== HIRLAM specific pregpssol fixes ===
 
{{{
Files:
  uti/pregpssol/pregpssol.F90
  uti/pregpssol/read_obsoul_gpssol.F90
  uti/pregpssol/write_obsoul_gpssol.F90
}}}

------------------------------------------------------------------------

=== Bator changes ===
- Reading of HDF5
- Decoding of satellite BUFR data, LMFBUFR flag.
- Radar settings

{{{
Files:
  odb/pandor/module/bator_decodbufr_mod.F90
  odb/pandor/module/bator_init_mod.F90
  odb/pandor/module/bator_lectures_mod.F90
  odb/pandor/module/bator_module.F90
  odb/pandor/module/bator_util_mod.F90
  odb/pandor/namelist/bator_namelist.h
  odb/tools/Bator.F90
  odb/pandor/module/bator_decodhdf5_mod.F90
  odb/pandor/module/bator_rad_postproc_mod.F90
}}}
------------------------------------------------------------------------

=== Blacklisting ===

{{{
Files
  bla/mf_blacklist.b
}}}
------------------------------------------------------------------------

=== 4DVAR fixes ===
r7973 | ovignes | 2010-04-26 15:36:10 +0200 (Mon, 26 Apr 2010) | 2 lines

Port 4DVAR changesets (7141,7167,7181,7200,7220,7545,7957) from 35h1branch

{{{
Files:
  ald/fullpos/suefpg3.F90
  ald/programs/blendsur.F90
}}}

------------------------------------------------------------------------

=== BDIFF ===
Gergely Boloni, r8768

{{{
Files:
  arp/module/yemct0.F90
  arp/pp_obs/ppreq.F90
  arp/setup/suctrl_gflattr.F90
  ald/programs/bdiff.F90
}}}

------------------------------------------------------------------------

=== Name convention of cloud fields ===

r9414 | trygveasp | 2011-06-07 09:27:54 +0200 (Tue, 07 Jun 2011) | 32 lines

{{{
Files:
  ald/programs/blend.F90
}}}

------------------------------------------------------------------------

[[Color(red, Last modified on)]] [[LastModified]]
[[Center(end)]]
