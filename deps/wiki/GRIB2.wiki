[[PageOutline]]

[[Center(begin)]]

= '''HIRLAM GRIB2 adaptation''' =

[[Timestamp]]

[[Center(end)]]

This page documents the efforts at the HIRLAM and HARMONIE side for the transition at ECMWF to the GRIB 2 standard and the use of the GRIB API library. The progess of the ECMWF migration is found 
[http://www.ecmwf.int/products/changes/grib2_migration/ here].
The history of ECMWF's changes to the GRIB API software can be found
[http://www.ecmwf.int/products/data/software/history/grib_api.html here]

= Final day of GRIB 1 dissemination =

According to documentation of Cycle 37r2 sent out by the Center:

  The planned date for implementation of this new IFS cycle is '''Wednesday, 18 May 2011'''.
  The first operational run using the new cycle will be the 06 UTC analysis and forecast in the
  Boundary Conditions project, followed by the 12 UTC main forecast.

= Status of switching to GRIB 2 boundaries at various HIRLAM centers =

||= Country =||= Date of switch =||= Method =|| Contact ||
|| Norway    || February         || grib_filter || ||
|| Ireland   || 2011050912       || grib_set || Eoin Whelan ||
|| [wiki:TOON_HIRLAM TOON22] || 2011040812 || gribconv || Toon Moene ||
|| Netherlands || 2011042006 || gribconv || Toon Moene ||
|| Lithuania || pre-oper testing || grib_set ||  ||
[[BR]]

= Using GRIB API tools to convert from grib2 to grib1 =

If you have a grib2 file containing less than 126 model levels you can convert the grib2 file to grib1 by using the tool grib_set from GRIB API. This is how you use it:

{{{
grib_set -G -s edition=1 grib2-file grib1-file
}}}

This is a method that works for both HARMONIE and HIRLAM. ''met.no'' has since February 2011 got grib2 files disseminated from ECMWF and converted them to grib1 in the above described way. At the moment these files are used for operational HIRLAM runs, and will soon be used for daily HARMONIE runs.

== Met Ã‰ireann ''grib_set command'' ==

Currently grib2 files contain less than 126 model levels. Therefore, we convert the grib2 dissemintion files to grib1 by using the tool grib_set from GRIB API. This is how we use it:

{{{
grib_set -G -s edition=1,longitudeOfSouthernPoleInDegrees=-30,longitudeOfFirstGridPointInDegrees=-30.1 grib2-file grib1-file
}}}

This results in grib1 files identical to the original grib1 dissemination; (the grib2 dissemintaion contains positive only longitudes).

[[BR]]

== grib_filter ==
grib_filter can also set the edition from 2 to 1 and by using this method you have the flexibilty also to modify other grib attributes. Example below:

the rule file: In this example called 2to1.filter
{{{
if (edition==2) {
    set edition=1;
    # In dissemination GRIB-1 files are given without local definition for stream oper.
    # The following instructions delete the local definition in this case.
    if (defined(stream)) {
        if (stream is "oper") {
            set deleteLocalDefinition=1;
        }
    }

    # Conversion of the longitudes to negative values.
    # To be used only if needed.
    if ( defined(longitudeOfFirstGridPointInDegrees) ) {
        if (longitudeOfFirstGridPoint > 180000 ) {
            set longitudeOfFirstGridPointInDegrees=longitudeOfFirstGridPointInDegrees - 360;
        }
    }
    if ( defined(longitudeOfLastGridPointInDegrees) ) {
        if ( longitudeOfLastGridPoint > 180000 ) {
            set longitudeOfLastGridPointInDegrees=longitudeOfLastGridPointInDegrees - 360;
        }
    }
    if ( defined(longitudeOfSouthernPoleInDegrees) ) {
        if (longitudeOfSouthernPole > 180000 ) {
            set longitudeOfSouthernPoleInDegrees=longitudeOfSouthernPoleInDegrees - 360;
        }
    }
}
write;
}}}

Use grib_filter to convert to grib1 and take care of correct longitudes/latitudes
{{{
grib_filter -f -o grib1-file 2to1.filter grib2-file
}}}

NOTE: The -f option in the grib_filter command means: "Force the execution not to fail on error"

= The HIRLAM grib converter =
GRIBCONV is a program to convert HIRLAM files between GRIB1 and GRIB2.

Internally, HIRLAM will remain working with files in the ASIMOF GRIB1
format.  GRIBCONV is meant to convert boundary data from ECMWF
(encoded in GRIB2 format) to GRIB1 and to convert HIRLAM output
from its ASIMOF GRIB1 format to GRIB2.

== Command line ==
{{{
gribconv.x [-gb1gb2 | -gb2gb1] [-v] inputfile outputfile
}}}
== Arguments ==
{{{
inputfile    The input file
outputfile   The output file
-gb1gb2      The conversion is from GRIB1 (possibly with ASIMOF structure)
             to GRIB2.  This is the default.
-gb2gb1      The conversion is from GRIB2 to GRIB1 (with ASIMOF structure).
-v           Some information regarding each converted field is printed.
}}}

== Textual output ==

Errors and warnings are printed to stderr and are meant to be self-explanatory.

Whenever GRIBCONV is unable to convert a field (see below), it is skipped.


== Limitations of the conversion ==

Fields with unknown parameters or level types are skipped.

Currently, on input, GRIB2 Fields which are not instantaneous are skipped.

Currently, the only conversion is between rotated lat/lon grids.

Currently, on writing GRIB1, ASIMOF structured files are produced.

== Status ==

A working version was committed with revision [9195] - however, the results were only tested by visual inspection.

The version based on revision [9215] has been tested with a 4-cycle run of the trunk (DTG=2011021506 DTGEND=2011021600).
Using 4DVAR resulted in a segmentation fault not clearly related with the GRIB 2 boundaries, so a renewed attempt used 3DVAR/FGAT.
That attempt finished without problems.  The results are available in ectmp:/nkc/hirlam/GB2TST/2011/02/{15|16}.  It is based on test data from the upcoming CY37r2 e-suite run, with results at 00 and 12 UTC.

Revision [9228] introduced the capability for GRIBCONV to select the lowest 126 levels from a GRIB 2 file with more than 126 model levels.  It was tested in the same setup as above, with DTG=2011021906 DTGEND=2011022000 to work with ordinary GRIB 2 encoded 91 level MARS data.

Revision [9265] brings the 7.3 branch up to the level of GRIBCONV support in the trunk. This has been tested in the same way as for trunk (see above) on a 4-cycle run from DTG=2011021906 to DTGEND=2011022000 (but with 4DVar this time) using the changes as outlined below.  The results are available in ectmp:/nkc/hirlam/GB2TST73/2011/02/{19|20}.

To perform GRIB 2 experiments with the trunk, the following has to be modified:

In Env_expdesc:
{{{
MIXINT=12
...
BDGRIB2=yes
BDSTRATEGY=operational_old
}}}
In ExtractBDfromMARS (just before the mars command):
{{{
expver="EXPVER = 53,"
export MARS_GRIB_API=1
}}}

[[BR]]

= grib_api adaptation for HARMONIE =

The process has started to rewrite gl, the LBC generator for HARMONIE to use grib_api instead of gribex for handling of GRIB files. The process can be followed [log:branches/gl_grib_api here]. 
The first goal is to have a proper version working in time for the ECMWF GRIB2 migration. The second goal of the rewriting is to change all parts of gl but this will take considerably longer time.

== '''Status''' ==

With [9371] gl_grib_api is now fully integrated in the harmonie-36h1 branch. The continued development of the non resolved gl functionalities will continue within the framework of cy36/cy37.

The following tests are based on [http://www.ecmwf.int/products/data/software/download/grib_api.html grib_api 1.9.9]. The version with grib_api reproduces the gribex version. However, several bugs have been found and corrected during the migration process which means that the comparison is with [log:trunk/harmonie/util/gl the latest version of gl].

 * Generation of LBC from ECMWF GRIB1/GRIB2 input works. 
 * Generation of LBC from HIRLAM pre newsnow GRIB1 input works. 
 * domain_prop works
 * SST extraction from ECMWF data works
 * grib output disabled
 * FA -> GRIB translation disabled
 * Xtool disabled
 * Fldextr disabled
 

----


[[Center(begin)]]
[[Disclaimer]]

[[Color(red, Last modified on)]] [[LastModified]]
[[Center(end)]]